<!DOCTYPE html>
<html lang="fr">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Pipeline First - Gestion des Intercontrats</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500;600;700&display=swap" rel="stylesheet">
  <script src="https://unpkg.com/react@18/umd/react.development.js" crossorigin></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js" crossorigin></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
  <style>
    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    :root {
      --bg-primary: #f8f9fa;
      --bg-secondary: #ffffff;
      --bg-tertiary: #e9ecef;
      --bg-card: #ffffff;
      --bg-hover: #f1f3f5;
      
      --text-primary: #212529;
      --text-secondary: #495057;
      --text-muted: #6c757d;
      
      --accent-cyan: #2c5aa0;
      --accent-cyan-dim: rgba(44, 90, 160, 0.08);
      --accent-cyan-glow: rgba(44, 90, 160, 0.15);
      
      --status-critical: #dc3545;
      --status-warning: #fd7e14;
      --status-ok: #28a745;
      --status-info: #0d6efd;
      
      --border-subtle: rgba(0, 0, 0, 0.08);
      --border-active: rgba(44, 90, 160, 0.25);
      
      --font-display: 'Inter', -apple-system, sans-serif;
      --font-mono: 'JetBrains Mono', monospace;
      
      --radius-sm: 6px;
      --radius-md: 10px;
      --radius-lg: 16px;
      
      --shadow-glow: 0 0 24px rgba(44, 90, 160, 0.1);
      --shadow-card: 0 2px 8px rgba(0, 0, 0, 0.08);
    }

    body {
      font-family: var(--font-display);
      background: var(--bg-primary);
      color: var(--text-primary);
      min-height: 100vh;
    }

    .app-container {
      display: flex;
      min-height: 100vh;
    }

    /* ============ SIDEBAR ============ */
    .sidebar {
      width: 260px;
      background: var(--bg-secondary);
      border-right: 1px solid var(--border-subtle);
      padding: 24px 16px;
      display: flex;
      flex-direction: column;
      position: fixed;
      height: 100vh;
      z-index: 100;
    }

    .logo {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 0 8px 24px;
      border-bottom: 1px solid var(--border-subtle);
      margin-bottom: 24px;
    }

    .logo-icon {
      width: 40px;
      height: 40px;
      background: linear-gradient(135deg, var(--accent-cyan), #0099cc);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 700;
      font-size: 14px;
      color: var(--bg-primary);
    }

    .logo-text {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: -0.5px;
    }

    .logo-text span {
      color: var(--accent-cyan);
    }

    .nav-section {
      margin-bottom: 32px;
    }

    .nav-label {
      font-size: 10px;
      font-weight: 600;
      letter-spacing: 1.5px;
      text-transform: uppercase;
      color: var(--text-muted);
      padding: 0 12px;
      margin-bottom: 12px;
    }

    .nav-item {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px 14px;
      border-radius: var(--radius-sm);
      cursor: pointer;
      transition: all 0.2s ease;
      color: var(--text-secondary);
      font-size: 14px;
      font-weight: 500;
      position: relative;
    }

    .nav-item:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
    }

    .nav-item.active {
      background: var(--accent-cyan-dim);
      color: var(--accent-cyan);
    }

    .nav-item.active::before {
      content: '';
      position: absolute;
      left: 0;
      width: 3px;
      height: 24px;
      background: var(--accent-cyan);
      border-radius: 0 2px 2px 0;
    }

    .nav-icon {
      width: 20px;
      height: 20px;
      opacity: 0.8;
    }

    .nav-badge {
      margin-left: auto;
      background: var(--status-critical);
      color: white;
      font-size: 11px;
      font-weight: 600;
      padding: 2px 8px;
      border-radius: 10px;
      min-width: 24px;
      text-align: center;
    }

    .sidebar-footer {
      margin-top: auto;
      padding-top: 24px;
      border-top: 1px solid var(--border-subtle);
    }

    .user-card {
      display: flex;
      align-items: center;
      gap: 12px;
      padding: 12px;
      border-radius: var(--radius-sm);
      background: var(--bg-tertiary);
    }

    .user-avatar {
      width: 40px;
      height: 40px;
      border-radius: 50%;
      background: linear-gradient(135deg, #667eea, #764ba2);
      display: flex;
      align-items: center;
      justify-content: center;
      font-weight: 600;
      font-size: 14px;
    }

    .user-info {
      flex: 1;
    }

    .user-name {
      font-size: 14px;
      font-weight: 600;
    }

    .user-role {
      font-size: 12px;
      color: var(--text-muted);
    }

    /* ============ MAIN CONTENT ============ */
    .main-content {
      flex: 1;
      margin-left: 260px;
      padding: 32px 48px;
      min-height: 100vh;
    }

    .page-header {
      margin-bottom: 36px;
    }

    .page-title {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -1.5px;
      margin-bottom: 8px;
    }

    .page-subtitle {
      color: var(--text-secondary);
      font-size: 15px;
    }

    .page-subtitle strong {
      color: var(--accent-cyan);
      font-weight: 600;
    }

    /* ============ KPI CARDS ============ */
    .kpi-grid {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 48px;
    }

    .kpi-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 24px;
      position: relative;
      overflow: hidden;
      transition: all 0.3s ease;
    }

    .kpi-card:hover {
      border-color: var(--border-active);
      transform: translateY(-2px);
    }

    .kpi-card::before {
      content: '';
      position: absolute;
      top: 0;
      left: 0;
      right: 0;
      height: 3px;
    }

    .kpi-card.critical::before { background: var(--status-critical); }
    .kpi-card.warning::before { background: var(--status-warning); }
    .kpi-card.ok::before { background: var(--status-ok); }
    .kpi-card.info::before { background: var(--status-info); }

    .kpi-label {
      font-size: 11px;
      font-weight: 600;
      letter-spacing: 0.5px;
      text-transform: uppercase;
      color: var(--text-muted);
      margin-bottom: 12px;
    }

    .kpi-value {
      font-family: var(--font-mono);
      font-size: 42px;
      font-weight: 700;
      letter-spacing: -2px;
      line-height: 1;
    }

    .kpi-card.critical .kpi-value { color: var(--status-critical); }
    .kpi-card.warning .kpi-value { color: var(--status-warning); }
    .kpi-card.ok .kpi-value { color: var(--status-ok); }
    .kpi-card.info .kpi-value { color: var(--accent-cyan); }

    .kpi-subtext {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
    }

    /* ============ SECTION ============ */
    .section {
      margin-bottom: 48px;
    }

    .section-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 24px;
    }

    .section-title {
      font-size: 20px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 14px;
    }

    .section-title-icon {
      width: 36px;
      height: 36px;
      background: var(--accent-cyan-dim);
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--accent-cyan);
      font-size: 18px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      padding: 10px 18px;
      border-radius: var(--radius-sm);
      font-size: 13px;
      font-weight: 600;
      cursor: pointer;
      transition: all 0.2s ease;
      border: none;
      font-family: var(--font-display);
    }

    .btn-primary {
      background: var(--accent-cyan);
      color: var(--bg-primary);
    }

    .btn-primary:hover {
      background: #00b8e6;
      box-shadow: var(--shadow-glow);
    }

    .btn-secondary {
      background: var(--bg-tertiary);
      color: var(--text-primary);
      border: 1px solid var(--border-subtle);
    }

    .btn-secondary:hover {
      border-color: var(--border-active);
      background: var(--bg-hover);
    }

    .btn-ghost {
      background: transparent;
      color: var(--text-secondary);
    }

    .btn-ghost:hover {
      color: var(--text-primary);
      background: var(--bg-hover);
    }

    .btn-success {
      background: var(--status-ok);
      color: var(--bg-primary);
    }

    .btn-success:hover {
      background: #26c46a;
    }

    .btn-danger {
      background: transparent;
      color: var(--status-critical);
      border: 1px solid var(--status-critical);
    }

    /* ============ PRIORITY LIST ============ */
    .priority-list {
      display: flex;
      flex-direction: column;
      gap: 14px;
    }

    .priority-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 24px;
      display: grid;
      grid-template-columns: 64px 1fr auto auto;
      gap: 24px;
      align-items: center;
      cursor: pointer;
      transition: all 0.3s ease;
      position: relative;
    }

    .priority-card:hover {
      border-color: var(--border-active);
      background: var(--bg-hover);
      transform: translateX(4px);
    }

    .priority-card.rank-1 {
      border-color: var(--accent-cyan);
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(0, 212, 255, 0.08) 100%);
    }

    .priority-card.rank-1::after {
      content: '';
      position: absolute;
      top: -1px;
      left: -1px;
      right: -1px;
      bottom: -1px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--accent-cyan), transparent 50%);
      z-index: -1;
      opacity: 0.2;
    }

    .rank-badge {
      width: 52px;
      height: 52px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-family: var(--font-mono);
      font-size: 22px;
      font-weight: 700;
      background: var(--bg-tertiary);
      color: var(--text-muted);
    }

    .priority-card.rank-1 .rank-badge {
      background: var(--accent-cyan);
      color: var(--bg-primary);
      box-shadow: 0 0 24px var(--accent-cyan-glow);
    }

    .priority-card.rank-2 .rank-badge {
      background: var(--status-warning);
      color: var(--bg-primary);
    }

    .priority-card.rank-3 .rank-badge {
      background: var(--status-ok);
      color: var(--bg-primary);
    }

    .priority-info {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .priority-name {
      font-size: 17px;
      font-weight: 600;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .priority-role {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .priority-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
      margin-top: 4px;
    }

    .tag {
      font-size: 10px;
      font-weight: 600;
      padding: 4px 10px;
      border-radius: 4px;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
      border: 1px solid var(--border-subtle);
    }

    .priority-stats {
      display: flex;
      gap: 28px;
      text-align: right;
    }

    .stat {
      display: flex;
      flex-direction: column;
      gap: 4px;
    }

    .stat-value {
      font-family: var(--font-mono);
      font-size: 20px;
      font-weight: 600;
    }

    .stat-value.cost { color: var(--status-critical); }
    .stat-value.days { color: var(--status-warning); }
    .stat-value.opps { color: var(--status-ok); }

    .stat-label {
      font-size: 10px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .priority-action {
      padding-left: 24px;
      border-left: 1px solid var(--border-subtle);
    }

    /* ============ ACTIONS LIST ============ */
    .actions-list {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .action-item {
      display: flex;
      align-items: center;
      gap: 16px;
      padding: 18px 24px;
      border-bottom: 1px solid var(--border-subtle);
      transition: background 0.2s ease;
    }

    .action-item:last-child {
      border-bottom: none;
    }

    .action-item:hover {
      background: var(--bg-hover);
    }

    .action-icon {
      width: 40px;
      height: 40px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
    }

    .action-icon.email {
      background: rgba(0, 212, 255, 0.15);
      color: var(--accent-cyan);
    }

    .action-icon.linkedin {
      background: rgba(10, 102, 194, 0.2);
      color: #0a66c2;
    }

    .action-icon.phone {
      background: rgba(46, 213, 115, 0.15);
      color: var(--status-ok);
    }

    .action-content {
      flex: 1;
    }

    .action-label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .action-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    .action-buttons {
      display: flex;
      gap: 10px;
    }

    /* ============ DETAIL VIEW ============ */
    .detail-container {
      max-width: 960px;
    }

    .back-button {
      display: inline-flex;
      align-items: center;
      gap: 8px;
      color: var(--text-secondary);
      font-size: 13px;
      cursor: pointer;
      margin-bottom: 28px;
      transition: color 0.2s ease;
    }

    .back-button:hover {
      color: var(--accent-cyan);
    }

    .consultant-header {
      display: flex;
      align-items: flex-start;
      gap: 28px;
      margin-bottom: 36px;
    }

    .consultant-avatar {
      width: 88px;
      height: 88px;
      border-radius: var(--radius-md);
      background: linear-gradient(135deg, var(--accent-cyan), #0099cc);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 32px;
      font-weight: 700;
      color: var(--bg-primary);
      flex-shrink: 0;
    }

    .consultant-info h1 {
      font-size: 32px;
      font-weight: 700;
      letter-spacing: -1px;
      margin-bottom: 6px;
    }

    .consultant-meta {
      color: var(--text-secondary);
      font-size: 14px;
      margin-bottom: 14px;
    }

    .consultant-tags {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    .consultant-tags .tag {
      background: var(--accent-cyan-dim);
      border-color: var(--accent-cyan);
      color: var(--accent-cyan);
    }

    .detail-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 32px;
    }

    .detail-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 28px;
    }

    .detail-card.highlight {
      border-color: var(--accent-cyan);
      background: linear-gradient(135deg, var(--bg-card) 0%, rgba(0, 212, 255, 0.06) 100%);
    }

    .detail-card.full-width {
      grid-column: 1 / -1;
    }

    .detail-card-header {
      display: flex;
      align-items: center;
      gap: 14px;
      margin-bottom: 20px;
    }

    .detail-card-icon {
      width: 44px;
      height: 44px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 20px;
    }

    .detail-card-icon.priority {
      background: var(--accent-cyan);
      color: var(--bg-primary);
    }

    .detail-card-icon.action {
      background: var(--status-ok);
      color: var(--bg-primary);
    }

    .detail-card-icon.warning {
      background: var(--status-warning);
      color: var(--bg-primary);
    }

    .detail-card-title {
      font-size: 14px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .priority-explanation {
      font-size: 15px;
      line-height: 1.7;
      color: var(--text-secondary);
    }

    .priority-explanation strong {
      color: var(--text-primary);
    }

    .action-recommendation {
      margin-top: 24px;
      padding-top: 24px;
      border-top: 1px solid var(--border-subtle);
    }

    .opp-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 14px;
    }

    .opp-client {
      font-size: 20px;
      font-weight: 600;
    }

    .opp-match {
      font-family: var(--font-mono);
      font-size: 14px;
      font-weight: 600;
      color: var(--status-ok);
      background: rgba(46, 213, 115, 0.15);
      padding: 6px 12px;
      border-radius: 4px;
    }

    .opp-contact {
      font-size: 14px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .opp-description {
      font-size: 14px;
      color: var(--text-muted);
    }

    .sequence-timeline {
      margin-top: 28px;
    }

    .sequence-item {
      display: flex;
      align-items: flex-start;
      gap: 12px;
      padding: 14px 0;
      position: relative;
    }

    .sequence-item:not(:last-child)::before {
      content: '';
      position: absolute;
      left: 9px;
      top: 32px;
      bottom: -14px;
      width: 2px;
      background: var(--border-subtle);
    }

    .sequence-item.active:not(:last-child)::before {
      background: var(--status-ok);
    }

    .sequence-item input[type="checkbox"] {
      accent-color: var(--status-ok);
      flex-shrink: 0;
    }

    .sequence-content {
      flex: 1;
      padding-top: 6px;
    }

    .sequence-label {
      font-size: 14px;
      font-weight: 500;
      margin-bottom: 4px;
    }

    .sequence-date {
      font-size: 12px;
      color: var(--text-muted);
    }

    .message-editor {
      margin-top: 28px;
      background: var(--bg-tertiary);
      border-radius: var(--radius-sm);
      overflow: hidden;
      border: 1px solid var(--border-subtle);
    }

    .message-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      padding: 14px 18px;
      border-bottom: 1px solid var(--border-subtle);
      background: var(--bg-secondary);
    }

    .message-label {
      font-size: 12px;
      font-weight: 600;
      color: var(--text-secondary);
    }

    .message-textarea {
      width: 100%;
      min-height: 180px;
      padding: 18px;
      background: transparent;
      border: none;
      color: var(--text-primary);
      font-family: var(--font-display);
      font-size: 14px;
      line-height: 1.7;
      resize: vertical;
    }

    .message-textarea:focus {
      outline: none;
    }

    .message-textarea::placeholder {
      color: var(--text-muted);
    }

    .detail-actions {
      display: flex;
      gap: 14px;
      margin-top: 28px;
    }

    /* ============ LOADING ============ */
    .loading-spinner {
      width: 18px;
      height: 18px;
      border: 2px solid var(--border-subtle);
      border-top-color: var(--accent-cyan);
      border-radius: 50%;
      animation: spin 0.8s linear infinite;
      display: inline-block;
    }

    @keyframes spin {
      to { transform: rotate(360deg); }
    }

    /* ============ EMPTY STATE ============ */
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: var(--text-muted);
    }

    .empty-state-icon {
      font-size: 48px;
      margin-bottom: 16px;
      opacity: 0.5;
    }

    /* ============ TOAST ============ */
    .toast {
      position: fixed;
      bottom: 24px;
      right: 24px;
      background: var(--bg-card);
      border: 1px solid var(--status-ok);
      border-radius: var(--radius-sm);
      padding: 16px 24px;
      display: flex;
      align-items: center;
      gap: 14px;
      box-shadow: var(--shadow-card);
      animation: slideIn 0.3s ease;
      z-index: 1000;
    }

    @keyframes slideIn {
      from {
        transform: translateX(100%);
        opacity: 0;
      }
      to {
        transform: translateX(0);
        opacity: 1;
      }
    }

    .toast-icon {
      color: var(--status-ok);
      font-size: 20px;
    }

    .toast-message {
      font-size: 14px;
      font-weight: 500;
    }

    /* ============ ESCALADE RH ============ */
    .escalade-card {
      background: linear-gradient(135deg, rgba(255, 71, 87, 0.08) 0%, var(--bg-card) 100%);
      border-color: rgba(255, 71, 87, 0.4);
    }

    .escalade-content {
      display: flex;
      flex-direction: column;
      gap: 18px;
    }

    .escalade-message {
      font-size: 14px;
      line-height: 1.7;
      color: var(--text-secondary);
    }

    .escalade-options {
      display: flex;
      gap: 14px;
      flex-wrap: wrap;
    }

    /* ============ MODAL ============ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.8);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      max-width: 800px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      box-shadow: var(--shadow-card);
    }

    .modal-header {
      padding: 24px 28px;
      border-bottom: 1px solid var(--border-subtle);
      display: flex;
      align-items: center;
      justify-content: space-between;
    }

    .modal-title {
      font-size: 22px;
      font-weight: 700;
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .modal-close {
      background: transparent;
      border: none;
      color: var(--text-muted);
      font-size: 24px;
      cursor: pointer;
      padding: 4px;
      line-height: 1;
      transition: color 0.2s;
    }

    .modal-close:hover {
      color: var(--text-primary);
    }

    .modal-body {
      padding: 28px;
    }

    .scoring-grid {
      display: grid;
      gap: 20px;
    }

    .scoring-criterion {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 20px;
    }

    .criterion-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .criterion-name {
      font-size: 15px;
      font-weight: 600;
    }

    .criterion-weight {
      font-family: var(--font-mono);
      font-size: 14px;
      color: var(--accent-cyan);
      font-weight: 600;
    }

    .criterion-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .formula-box {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 16px;
      margin-top: 20px;
      font-family: var(--font-mono);
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.8;
    }

    /* ============ FILTERS & SEARCH ============ */
    .filters-bar {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 20px 24px;
      margin-bottom: 24px;
      display: grid;
      grid-template-columns: 1fr auto auto auto;
      gap: 16px;
      align-items: center;
    }

    .search-input {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 10px 16px;
      color: var(--text-primary);
      font-family: var(--font-display);
      font-size: 14px;
      width: 100%;
    }

    .search-input:focus {
      outline: none;
      border-color: var(--border-active);
    }

    .search-input::placeholder {
      color: var(--text-muted);
    }

    .filter-select {
      background: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 10px 16px;
      color: var(--text-primary);
      font-family: var(--font-display);
      font-size: 14px;
      cursor: pointer;
      min-width: 160px;
    }

    .filter-select:focus {
      outline: none;
      border-color: var(--border-active);
    }

    /* ============ TABLE ============ */
    .consultants-table {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .table-header {
      background: var(--bg-secondary);
      display: grid;
      grid-template-columns: 60px 200px 180px 100px 100px 120px 100px auto;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .table-row {
      display: grid;
      grid-template-columns: 60px 200px 180px 100px 100px 120px 100px auto;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
      cursor: pointer;
      transition: all 0.2s ease;
      align-items: center;
    }

    .table-row:last-child {
      border-bottom: none;
    }

    .table-row:hover {
      background: var(--bg-hover);
    }

    .table-cell-rank {
      font-family: var(--font-mono);
      font-size: 18px;
      font-weight: 700;
      color: var(--text-muted);
    }

    .table-row.top-3 .table-cell-rank {
      color: var(--accent-cyan);
    }

    .table-cell-name {
      font-weight: 600;
      font-size: 14px;
    }

    .table-cell-role {
      font-size: 13px;
      color: var(--text-secondary);
    }

    .table-cell-metric {
      font-family: var(--font-mono);
      font-size: 14px;
      font-weight: 600;
    }

    .table-cell-metric.cost { color: var(--status-critical); }
    .table-cell-metric.days { color: var(--status-warning); }
    .table-cell-metric.opps { color: var(--accent-cyan); }

    /* ============ ROI SIMULATOR ============ */
    .roi-grid {
      display: grid;
      grid-template-columns: 1fr 1fr;
      gap: 24px;
      margin-bottom: 24px;
    }

    .roi-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 28px;
    }

    .roi-card-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 24px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .slider-container {
      margin-bottom: 32px;
    }

    .slider-label {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
      font-size: 14px;
    }

    .slider-value {
      font-family: var(--font-mono);
      font-size: 20px;
      font-weight: 700;
      color: var(--accent-cyan);
    }

    .slider {
      width: 100%;
      height: 8px;
      background: var(--bg-tertiary);
      border-radius: 4px;
      outline: none;
      -webkit-appearance: none;
    }

    .slider::-webkit-slider-thumb {
      -webkit-appearance: none;
      appearance: none;
      width: 20px;
      height: 20px;
      background: var(--accent-cyan);
      border-radius: 50%;
      cursor: pointer;
      box-shadow: 0 2px 8px rgba(0, 215, 255, 0.4);
    }

    .slider::-moz-range-thumb {
      width: 20px;
      height: 20px;
      background: var(--accent-cyan);
      border-radius: 50%;
      cursor: pointer;
      border: none;
      box-shadow: 0 2px 8px rgba(0, 215, 255, 0.4);
    }

    .impact-metrics {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 20px;
    }

    .impact-metric {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 18px;
    }

    .impact-metric-value {
      font-size: 28px;
      font-weight: 700;
      font-family: var(--font-mono);
      margin-bottom: 6px;
    }

    .impact-metric-value.gain { color: var(--status-ok); }
    .impact-metric-value.days { color: var(--accent-cyan); }
    .impact-metric-value.placements { color: var(--status-warning); }

    .impact-metric-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .comparison-bars {
      display: flex;
      flex-direction: column;
      gap: 24px;
      margin-top: 24px;
    }

    .bar-item {
      display: flex;
      flex-direction: column;
      gap: 8px;
    }

    .bar-label {
      font-size: 13px;
      font-weight: 600;
      display: flex;
      justify-content: space-between;
    }

    .bar-bg {
      background: var(--bg-tertiary);
      border-radius: 4px;
      height: 32px;
      position: relative;
      overflow: hidden;
    }

    .bar-fill {
      background: linear-gradient(90deg, var(--accent-cyan), rgba(0, 215, 255, 0.6));
      height: 100%;
      display: flex;
      align-items: center;
      padding: 0 12px;
      font-family: var(--font-mono);
      font-size: 13px;
      font-weight: 600;
      transition: width 0.5s ease;
    }

    .bar-fill.before {
      background: linear-gradient(90deg, var(--status-critical), rgba(255, 71, 87, 0.6));
    }

    .roi-summary {
      background: linear-gradient(135deg, rgba(0, 215, 255, 0.08) 0%, var(--bg-card) 100%);
      border: 1px solid rgba(0, 215, 255, 0.3);
      border-radius: var(--radius-md);
      padding: 28px;
      margin-top: 24px;
    }

    .roi-summary-title {
      font-size: 18px;
      font-weight: 700;
      margin-bottom: 20px;
      color: var(--accent-cyan);
    }

    .roi-summary-grid {
      display: grid;
      grid-template-columns: repeat(3, 1fr);
      gap: 24px;
    }

    .roi-summary-item {
      text-align: center;
    }

    .roi-summary-value {
      font-size: 32px;
      font-weight: 700;
      font-family: var(--font-mono);
      color: var(--status-ok);
      margin-bottom: 8px;
    }

    .roi-summary-label {
      font-size: 13px;
      color: var(--text-secondary);
    }

    /* ============ ANALYTICS & CHARTS ============ */
    .analytics-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 24px;
      margin-bottom: 24px;
    }

    .chart-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 24px;
    }

    .chart-card.full-width {
      grid-column: 1 / -1;
    }

    .chart-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 24px;
    }

    .chart-title {
      font-size: 16px;
      font-weight: 600;
    }

    .chart-period {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .horizontal-bars {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .h-bar-item {
      display: flex;
      align-items: center;
      gap: 12px;
    }

    .h-bar-label {
      min-width: 140px;
      font-size: 13px;
      font-weight: 500;
    }

    .h-bar-container {
      flex: 1;
      background: var(--bg-tertiary);
      border-radius: 4px;
      height: 28px;
      position: relative;
      overflow: hidden;
    }

    .h-bar-fill {
      background: linear-gradient(90deg, var(--accent-cyan), rgba(0, 215, 255, 0.5));
      height: 100%;
      display: flex;
      align-items: center;
      padding: 0 10px;
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 600;
      transition: width 0.5s ease;
    }

    .line-chart {
      display: flex;
      align-items: flex-end;
      justify-content: space-between;
      height: 180px;
      gap: 8px;
      padding: 20px 0;
      border-bottom: 2px solid var(--border-subtle);
    }

    .line-bar {
      flex: 1;
      background: linear-gradient(180deg, var(--accent-cyan), rgba(0, 215, 255, 0.3));
      border-radius: 4px 4px 0 0;
      position: relative;
      min-height: 20px;
      transition: height 0.5s ease;
    }

    .line-bar:hover {
      background: linear-gradient(180deg, var(--accent-cyan), rgba(0, 215, 255, 0.5));
    }

    .line-bar-label {
      position: absolute;
      bottom: -24px;
      left: 50%;
      transform: translateX(-50%);
      font-size: 11px;
      color: var(--text-muted);
      white-space: nowrap;
    }

    .line-bar-value {
      position: absolute;
      top: -24px;
      left: 50%;
      transform: translateX(-50%);
      font-family: var(--font-mono);
      font-size: 12px;
      font-weight: 600;
      color: var(--text-primary);
    }

    .gauge-container {
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
      padding: 40px 0;
    }

    .gauge-circle {
      width: 180px;
      height: 180px;
      border-radius: 50%;
      background: conic-gradient(
        var(--accent-cyan) 0deg,
        var(--accent-cyan) var(--gauge-angle, 270deg),
        var(--bg-tertiary) var(--gauge-angle, 270deg)
      );
      display: flex;
      align-items: center;
      justify-content: center;
      position: relative;
    }

    .gauge-inner {
      width: 140px;
      height: 140px;
      border-radius: 50%;
      background: var(--bg-card);
      display: flex;
      flex-direction: column;
      align-items: center;
      justify-content: center;
    }

    .gauge-value {
      font-size: 42px;
      font-weight: 700;
      font-family: var(--font-mono);
      color: var(--accent-cyan);
      line-height: 1;
    }

    .gauge-label {
      font-size: 12px;
      color: var(--text-muted);
      margin-top: 8px;
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    .insights-list {
      display: flex;
      flex-direction: column;
      gap: 16px;
    }

    .insight-item {
      background: var(--bg-secondary);
      border-left: 3px solid var(--accent-cyan);
      padding: 16px;
      border-radius: var(--radius-sm);
    }

    .insight-item.warning {
      border-left-color: var(--status-warning);
    }

    .insight-item.critical {
      border-left-color: var(--status-critical);
    }

    .insight-title {
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .insight-description {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    /* ============ OPPORTUNITES ============ */
    .opps-table {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      overflow: hidden;
    }

    .opps-table-header {
      background: var(--bg-secondary);
      display: grid;
      grid-template-columns: 200px 180px 120px 120px 100px auto;
      padding: 16px 24px;
      border-bottom: 1px solid var(--border-subtle);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.5px;
      color: var(--text-muted);
    }

    .opps-table-row {
      display: grid;
      grid-template-columns: 200px 180px 120px 120px 100px auto;
      padding: 20px 24px;
      border-bottom: 1px solid var(--border-subtle);
      cursor: pointer;
      transition: all 0.2s ease;
      align-items: center;
    }

    .opps-table-row:last-child {
      border-bottom: none;
    }

    .opps-table-row:hover {
      background: var(--bg-hover);
    }

    .opp-priority {
      display: inline-block;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .opp-priority.haute {
      background: rgba(255, 71, 87, 0.15);
      color: var(--status-critical);
      border: 1px solid rgba(255, 71, 87, 0.3);
    }

    .opp-priority.moyenne {
      background: rgba(255, 184, 0, 0.15);
      color: var(--status-warning);
      border: 1px solid rgba(255, 184, 0, 0.3);
    }

    .opp-priority.basse {
      background: rgba(0, 215, 255, 0.15);
      color: var(--accent-cyan);
      border: 1px solid rgba(0, 215, 255, 0.3);
    }

    .opp-statut {
      display: inline-block;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
    }

    .opp-statut.active {
      background: rgba(76, 209, 55, 0.15);
      color: var(--status-ok);
      border: 1px solid rgba(76, 209, 55, 0.3);
    }

    .opp-statut.en_attente {
      background: rgba(140, 140, 140, 0.15);
      color: var(--text-muted);
      border: 1px solid rgba(140, 140, 140, 0.3);
    }

    .opp-detail-modal {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .opp-detail-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      max-width: 900px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
    }

    .opp-detail-header {
      padding: 28px 32px;
      border-bottom: 1px solid var(--border-subtle);
    }

    .opp-detail-title {
      font-size: 24px;
      font-weight: 700;
      margin-bottom: 12px;
    }

    .opp-detail-meta {
      display: flex;
      gap: 20px;
      font-size: 13px;
      color: var(--text-secondary);
      flex-wrap: wrap;
    }

    .opp-detail-body {
      padding: 32px;
    }

    .opp-section {
      margin-bottom: 32px;
    }

    .opp-section:last-child {
      margin-bottom: 0;
    }

    .opp-section-title {
      font-size: 16px;
      font-weight: 600;
      margin-bottom: 16px;
      display: flex;
      align-items: center;
      gap: 10px;
    }

    .matched-consultants {
      display: grid;
      gap: 16px;
    }

    .matched-consultant-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-sm);
      padding: 20px;
      display: grid;
      grid-template-columns: auto 1fr auto;
      gap: 16px;
      align-items: center;
      transition: all 0.2s ease;
      cursor: pointer;
    }

    .matched-consultant-card:hover {
      border-color: var(--border-active);
      background: var(--bg-hover);
    }

    .match-score-badge {
      background: linear-gradient(135deg, var(--accent-cyan), rgba(0, 215, 255, 0.6));
      color: var(--bg-primary);
      font-weight: 700;
      font-family: var(--font-mono);
      font-size: 18px;
      padding: 12px 16px;
      border-radius: var(--radius-sm);
      text-align: center;
      min-width: 70px;
    }

    .matched-consultant-info h4 {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 6px;
    }

    .matched-consultant-info p {
      font-size: 13px;
      color: var(--text-secondary);
      margin-bottom: 8px;
    }

    .matched-consultant-tags {
      display: flex;
      gap: 6px;
      flex-wrap: wrap;
    }

    .matched-consultant-tags .tag {
      font-size: 11px;
      padding: 3px 8px;
    }

    /* ============ HISTORIQUE ============ */
    .history-timeline {
      position: relative;
      padding-left: 40px;
    }

    .history-timeline::before {
      content: '';
      position: absolute;
      left: 15px;
      top: 0;
      bottom: 0;
      width: 2px;
      background: var(--border-subtle);
    }

    .history-item {
      position: relative;
      margin-bottom: 24px;
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 20px 24px;
      transition: all 0.2s ease;
    }

    .history-item:hover {
      border-color: var(--border-active);
      background: var(--bg-hover);
    }

    .history-item::before {
      content: '';
      position: absolute;
      left: -31px;
      top: 24px;
      width: 14px;
      height: 14px;
      border-radius: 50%;
      background: var(--accent-cyan);
      border: 3px solid var(--bg-secondary);
      z-index: 1;
    }

    .history-item.placement::before {
      background: var(--status-ok);
    }

    .history-item.escalade::before {
      background: var(--status-critical);
    }

    .history-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }

    .history-date-time {
      font-size: 12px;
      color: var(--text-muted);
      font-family: var(--font-mono);
    }

    .history-type-badge {
      display: inline-block;
      padding: 4px 10px;
      border-radius: var(--radius-sm);
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.3px;
    }

    .history-type-badge.email {
      background: rgba(0, 215, 255, 0.15);
      color: var(--accent-cyan);
      border: 1px solid rgba(0, 215, 255, 0.3);
    }

    .history-type-badge.relance {
      background: rgba(255, 184, 0, 0.15);
      color: var(--status-warning);
      border: 1px solid rgba(255, 184, 0, 0.3);
    }

    .history-type-badge.placement {
      background: rgba(76, 209, 55, 0.15);
      color: var(--status-ok);
      border: 1px solid rgba(76, 209, 55, 0.3);
    }

    .history-type-badge.linkedin {
      background: rgba(0, 119, 181, 0.15);
      color: #0077B5;
      border: 1px solid rgba(0, 119, 181, 0.3);
    }

    .history-type-badge.escalade {
      background: rgba(255, 71, 87, 0.15);
      color: var(--status-critical);
      border: 1px solid rgba(255, 71, 87, 0.3);
    }

    .history-title {
      font-size: 15px;
      font-weight: 600;
      margin-bottom: 8px;
    }

    .history-details {
      font-size: 13px;
      color: var(--text-secondary);
      line-height: 1.6;
    }

    .history-meta {
      display: flex;
      gap: 16px;
      margin-top: 12px;
      padding-top: 12px;
      border-top: 1px solid var(--border-subtle);
      font-size: 12px;
      color: var(--text-muted);
    }

    .history-stats {
      display: grid;
      grid-template-columns: repeat(4, 1fr);
      gap: 20px;
      margin-bottom: 32px;
    }

    .history-stat-card {
      background: var(--bg-card);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-md);
      padding: 20px;
      text-align: center;
    }

    .history-stat-value {
      font-size: 32px;
      font-weight: 700;
      font-family: var(--font-mono);
      margin-bottom: 8px;
    }

    .history-stat-value.success { color: var(--status-ok); }
    .history-stat-value.info { color: var(--accent-cyan); }
    .history-stat-value.warning { color: var(--status-warning); }

    .history-stat-label {
      font-size: 12px;
      color: var(--text-muted);
      text-transform: uppercase;
      letter-spacing: 0.5px;
    }

    /* ============ RESPONSIVE ============ */
    @media (max-width: 1200px) {
      .kpi-grid {
        grid-template-columns: repeat(2, 1fr);
      }
      
      .detail-grid {
        grid-template-columns: 1fr;
      }
    }

    /* ============ OPPORTUNITES / MODAL ============ */
    .modal-overlay {
      position: fixed;
      top: 0;
      left: 0;
      right: 0;
      bottom: 0;
      background: rgba(0, 0, 0, 0.85);
      display: flex;
      align-items: center;
      justify-content: center;
      z-index: 1000;
      padding: 20px;
    }

    .modal-content {
      background: var(--bg-secondary);
      border: 1px solid var(--border-subtle);
      border-radius: var(--radius-lg);
      max-width: 700px;
      width: 100%;
      max-height: 90vh;
      overflow-y: auto;
      padding: 32px;
      position: relative;
    }

    .modal-content.large {
      max-width: 900px;
    }

    .modal-close {
      position: absolute;
      top: 20px;
      right: 20px;
      background: var(--bg-tertiary);
      border: 1px solid var(--border-subtle);
      color: var(--text-secondary);
      width: 32px;
      height: 32px;
      border-radius: var(--radius-sm);
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      font-size: 18px;
      transition: all 0.2s ease;
    }

    .modal-close:hover {
      background: var(--bg-hover);
      color: var(--text-primary);
      border-color: var(--border-active);
    }
  
    /* ============ GEO BADGES ============ */
    .geo-badge {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 6px;
      font-size: 13px;
      font-weight: 500;
      background: var(--bg-tertiary);
      color: var(--text-secondary);
    }
    
    .geo-badge.mobile {
      background: rgba(46, 213, 115, 0.15);
      color: var(--status-ok);
      border: 1px solid rgba(46, 213, 115, 0.3);
    }
    
    .geo-location {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-top: 8px;
    }
    
    .geo-icon {
      font-size: 14px;
    }

  </style>
</head>
<body>
  <div id="root"></div>

  <script type="text/babel">
    const { useState } = React;

    // ============================================
    // MOCK DATA - OPPORTUNITÉS
    // ============================================
    
    const mockOpportunites = [
      {
        id: 'opp1',
        client: 'Dalkia',
        contact: 'Marie Dupont',
        contactEmail: 'm.dupont@dalkia.fr',
        contactPoste: 'Responsable Data',
        titre: 'Data Engineer - Migration Cloud',
        description: 'Besoin Data Engineer pour projet migration infrastructure on-premise vers AWS',
        competencesRequises: ['Data Engineer', 'Python', 'Spark', 'AWS'],
        tjmPropose: 580,
        demarrage: 'Février 2026',
        duree: '6 mois',
        dureeMois: 6,
        ville: 'Paris',
        dateDebutSouhaitee: '2026-02-15',
        probabilite: 'chaude',
        statut: 'nouvelle',
        priorite: 'haute',
        dateCreation: '2026-01-20',
        consultantsMatches: ['1', '11', '16'], // IDs des consultants
        sequenceTracking: { j0_sent: true, j0_date: "2026-01-25", j3_sent: true, j3_date: "2026-01-28", j7_sent: false, j7_date: null }, // J+7 due aujourd'hui (4 fév)
        responseTracking: { received: false, responseDate: null, responseType: null, responseChannel: null, notes: '' }
      },
      {
        id: 'opp2',
        client: 'BNP Paribas',
        contact: 'François Bernard',
        contactEmail: 'f.bernard@bnpparibas.fr',
        contactPoste: 'Directeur Data',
        titre: 'Data Scientist - Modélisation risque',
        description: 'Modélisation risque crédit avec Machine Learning',
        competencesRequises: ['Data Scientist', 'Python', 'Machine Learning'],
        tjmPropose: 620,
        demarrage: 'Mars 2026',
        duree: '12 mois',
        
        
        statut: 'nouvelle',
        priorite: 'haute',
        dateCreation: '2026-01-18',
        consultantsMatches: ['6', '4', '12'],
        ville: 'Paris',
        dureeMois: 12,
        dateDebutSouhaitee: '2026-03-01',
        probabilite: 'nouvelle',
        sequenceTracking: { j0_sent: true, j0_date: "2026-02-01", j3_sent: false, j3_date: null, j7_sent: false, j7_date: null }, // J+3 due aujourd'hui
        responseTracking: { received: false, responseDate: null, responseType: null, responseChannel: null, notes: '' }
      },
      {
        id: 'opp3',
        client: 'Orange',
        contact: 'Sophie Laurent',
        contactEmail: 's.laurent@orange.fr',
        contactPoste: 'DSI',
        titre: 'Cloud Architect - Multi-cloud',
        description: 'Architecture multi-cloud pour nouveau SI',
        competencesRequises: ['Cloud Architect', 'AWS', 'Azure', 'Terraform'],
        tjmPropose: 650,
        demarrage: 'Février 2026',
        duree: '9 mois',
        
        
        statut: 'gagnee',
        priorite: 'haute',
        dateCreation: '2026-01-22',
        consultantsMatches: ['7', '15'],
        ville: 'Lyon',
        dureeMois: 6,
        dateDebutSouhaitee: '2026-02-01',
        probabilite: 'negociation',
        consultantPlace: '7',
        datePlacement: '2026-01-23',
      },
      {
        id: 'opp4',
        client: "L'Oréal",
        contact: 'Anne Petit',
        contactEmail: 'a.petit@loreal.com',
        contactPoste: 'Head of AI',
        titre: 'ML Engineer - MLOps',
        description: 'Industrialisation et déploiement modèles ML en production',
        competencesRequises: ['Machine Learning', 'MLOps', 'Python'],
        tjmPropose: 680,
        demarrage: 'Février 2026',
        duree: '8 mois',
        
        
        statut: 'gagnee',
        priorite: 'haute',
        dateCreation: '2026-01-19',
        consultantsMatches: ['4', '12'],
        ville: 'Nantes',
        dureeMois: 3,
        dateDebutSouhaitee: '2026-06-01',
        probabilite: 'nouvelle',
        consultantPlace: '4',
        datePlacement: '2026-01-24',
      },
      {
        id: 'opp5',
        client: 'SNCF',
        contact: 'Pierre Martin',
        contactEmail: 'p.martin@sncf.fr',
        contactPoste: 'Chef de projet BI',
        titre: 'Data Analyst - Tableaux de bord RH',
        description: 'Renfort équipe BI pour tableaux de bord RH et pilotage',
        competencesRequises: ['Data Analyst', 'Power BI', 'SQL'],
        tjmPropose: 480,
        demarrage: 'Février 2026',
        duree: '4 mois',
        
        
        statut: 'nouvelle',
        priorite: 'moyenne',
        dateCreation: '2026-01-21',
        consultantsMatches: ['2', '19'],
        ville: 'Paris',
        dureeMois: 18,
        dateDebutSouhaitee: '2026-02-20',
        probabilite: 'chaude',
        sequenceTracking: { j0_sent: true, j0_date: "2026-01-18", j3_sent: true, j3_date: "2026-01-21", j7_sent: true, j7_date: "2026-01-25" },
        responseTracking: { received: false, responseDate: null, responseType: null, responseChannel: null, notes: '' }
      },
      {
        id: 'opp6',
        client: 'EDF',
        contact: 'Nicolas Garcia',
        contactEmail: 'n.garcia@edf.fr',
        contactPoste: 'VP Engineering',
        titre: 'DevOps - Pipeline CI/CD',
        description: 'Mise en place pipeline CI/CD pour applications critiques',
        competencesRequises: ['DevOps', 'Docker', 'Kubernetes', 'CI/CD'],
        tjmPropose: 550,
        demarrage: 'Mars 2026',
        duree: '6 mois',
        
        
        statut: 'nouvelle',
        priorite: 'moyenne',
        dateCreation: '2026-01-17',
        consultantsMatches: ['8', '20'],
        ville: 'Lyon',
        dureeMois: 4,
        dateDebutSouhaitee: '2026-03-15',
        probabilite: 'nouvelle',
        sequenceTracking: { j0_sent: false, j0_date: null, j3_sent: false, j3_date: null, j7_sent: false, j7_date: null },
        responseTracking: { received: false, responseDate: null, responseType: null, responseChannel: null, notes: '' }
      },
      {
        id: 'opp7',
        client: 'Veolia',
        contact: 'Jean Durand',
        contactEmail: 'j.durand@veolia.fr',
        contactPoste: 'Responsable IT',
        titre: 'Python Developer - App interne',
        description: 'Développement application interne Python/Django',
        competencesRequises: ['Python', 'Django', 'PostgreSQL'],
        tjmPropose: 510,
        demarrage: 'Mars 2026',
        duree: '5 mois',
        
        
        statut: 'nouvelle',
        priorite: 'moyenne',
        dateCreation: '2026-01-23',
        consultantsMatches: ['3', '10', '17'],
        ville: 'Toulouse',
        dureeMois: 12,
        dateDebutSouhaitee: '2026-04-01',
        probabilite: 'chaude',
        sequenceTracking: { j0_sent: true, j0_date: "2026-01-18", j3_sent: true, j3_date: "2026-01-21", j7_sent: true, j7_date: "2026-01-25" },
        responseTracking: { received: false, responseDate: null, responseType: null, responseChannel: null, notes: '' }
      },
      {
        id: 'opp8',
        client: 'Thales',
        contact: 'Anne Petit',
        contactEmail: 'a.petit@thalesgroup.com',
        contactPoste: 'Head of AI',
        titre: 'ML Engineer - Computer Vision',
        description: 'Vision par ordinateur pour systèmes défense',
        competencesRequises: ['Machine Learning', 'Computer Vision', 'PyTorch'],
        tjmPropose: 700,
        demarrage: 'Avril 2026',
        duree: '12 mois',
        
        
        statut: 'gagnee',
        priorite: 'haute',
        dateCreation: '2026-01-16',
        consultantsMatches: ['12', '18'],
        ville: 'Paris',
        dureeMois: 6,
        dateDebutSouhaitee: '2026-02-10',
        probabilite: 'negociation',
        consultantPlace: '12',
        datePlacement: '2026-01-20',
      },
      {
        id: 'opp9',
        client: 'Carrefour',
        contact: 'Isabelle Roux',
        contactEmail: 'i.roux@carrefour.fr',
        contactPoste: 'Responsable BI',
        titre: 'BI Developer - Dashboards',
        description: 'Dashboards ventes et supply chain avec Power BI',
        competencesRequises: ['BI Developer', 'Power BI', 'SQL'],
        tjmPropose: 490,
        demarrage: 'Mars 2026',
        duree: '6 mois',
        
        
        statut: 'nouvelle',
        priorite: 'basse',
        dateCreation: '2026-01-15',
        consultantsMatches: ['9', '19'],
        ville: 'Bordeaux',
        dureeMois: 9,
        dateDebutSouhaitee: '2026-05-01',
        probabilite: 'nouvelle',
        sequenceTracking: { j0_sent: true, j0_date: "2026-01-23", j3_sent: false, j3_date: null, j7_sent: false, j7_date: null },
        responseTracking: { received: false, responseDate: null, responseType: null, responseChannel: null, notes: '' }
      },
      {
        id: 'opp10',
        client: 'Decathlon',
        contact: 'Marie Dupont',
        contactEmail: 'm.dupont@decathlon.fr',
        contactPoste: 'CTO',
        titre: 'Python Developer - API Backend',
        description: 'API backend e-commerce nouvelle plateforme',
        competencesRequises: ['Python', 'FastAPI', 'PostgreSQL'],
        tjmPropose: 520,
        demarrage: 'Février 2026',
        duree: '8 mois',
        
        
        statut: 'nouvelle',
        priorite: 'moyenne',
        dateCreation: '2026-01-14',
        consultantsMatches: ['10', '22'],
        ville: 'Lille',
        dureeMois: 12,
        dateDebutSouhaitee: '2026-03-01',
        probabilite: 'chaude',
        sequenceTracking: { j0_sent: false, j0_date: null, j3_sent: false, j3_date: null, j7_sent: false, j7_date: null },
        responseTracking: { received: false, responseDate: null, responseType: null, responseChannel: null, notes: '' }
      },
      {
        id: 'opp11',
        client: 'Airbus',
        contact: 'Jean Durand',
        contactEmail: 'j.durand@airbus.com',
        contactPoste: 'Lead Data',
        titre: 'Data Engineer - Pipeline IoT',
        description: 'Pipeline data temps réel pour IoT industriel',
        competencesRequises: ['Data Engineer', 'Scala', 'Spark', 'Kafka'],
        tjmPropose: 600,
        demarrage: 'Mars 2026',
        duree: '10 mois',
        
        
        statut: 'nouvelle',
        priorite: 'haute',
        dateCreation: '2026-01-13',
        consultantsMatches: ['11'],
        ville: 'Lyon',
        dureeMois: 6,
        dateDebutSouhaitee: '2026-02-25',
        probabilite: 'negociation',
        sequenceTracking: { j0_sent: true, j0_date: "2026-01-20", j3_sent: true, j3_date: "2026-01-23", j7_sent: false, j7_date: null },
        responseTracking: { received: false, responseDate: null, responseType: null, responseChannel: null, notes: '' }
      },
      {
        id: 'opp12',
        client: 'Société Générale',
        contact: 'François Bernard',
        contactEmail: 'f.bernard@socgen.fr',
        contactPoste: 'RSSI',
        titre: 'Cyber Security - Audit ISO 27001',
        description: 'Audit sécurité et mise en conformité ISO 27001',
        competencesRequises: ['Cyber Security', 'ISO 27001', 'SIEM'],
        tjmPropose: 610,
        demarrage: 'Avril 2026',
        duree: '6 mois',
        
        
        statut: 'nouvelle',
        priorite: 'moyenne',
        dateCreation: '2026-01-12',
        consultantsMatches: ['14'],
        ville: 'Paris',
        dureeMois: 24,
        dateDebutSouhaitee: '2026-07-01',
        probabilite: 'nouvelle',
        sequenceTracking: { j0_sent: false, j0_date: null, j3_sent: false, j3_date: null, j7_sent: false, j7_date: null },
        responseTracking: { received: false, responseDate: null, responseType: null, responseChannel: null, notes: '' }
      },
      {
        id: 'opp13',
        client: 'Total Energies',
        contact: 'Sophie Laurent',
        contactEmail: 's.laurent@totalenergies.com',
        contactPoste: 'Lead Cloud',
        titre: 'Cloud Architect - Migration GCP',
        description: 'Migration applications on-premise vers GCP',
        competencesRequises: ['Cloud Architect', 'GCP', 'Terraform'],
        tjmPropose: 640,
        demarrage: 'Mars 2026',
        duree: '7 mois',
        
        
        statut: 'nouvelle',
        priorite: 'haute',
        dateCreation: '2026-01-24',
        consultantsMatches: ['15'],
        ville: 'Marseille',
        dureeMois: 8,
        dateDebutSouhaitee: '2026-04-15',
        probabilite: 'chaude',
        sequenceTracking: { j0_sent: true, j0_date: "2026-01-18", j3_sent: true, j3_date: "2026-01-21", j7_sent: true, j7_date: "2026-01-25" },
        responseTracking: { received: false, responseDate: null, responseType: null, responseChannel: null, notes: '' }
      },
      {
        id: 'opp14',
        client: 'Safran',
        contact: 'Nicolas Garcia',
        contactEmail: 'n.garcia@safrangroup.com',
        contactPoste: 'Director Data Engineering',
        titre: 'Data Engineer - Data Warehouse',
        description: 'Data warehouse pour analytics industriels',
        competencesRequises: ['Data Engineer', 'AWS', 'Redshift', 'dbt'],
        tjmPropose: 570,
        demarrage: 'Avril 2026',
        duree: '9 mois',
        
        
        statut: 'nouvelle',
        priorite: 'moyenne',
        dateCreation: '2026-01-11',
        consultantsMatches: ['16'],
        ville: 'Nantes',
        dureeMois: 6,
        dateDebutSouhaitee: '2026-03-10',
        probabilite: 'nouvelle',
        sequenceTracking: { j0_sent: false, j0_date: null, j3_sent: false, j3_date: null, j7_sent: false, j7_date: null },
        responseTracking: { received: false, responseDate: null, responseType: null, responseChannel: null, notes: '' }
      },
      {
        id: 'opp15',
        client: 'Auchan',
        contact: 'Pierre Martin',
        contactEmail: 'p.martin@auchan.fr',
        contactPoste: 'Responsable Analytics',
        titre: 'Data Analyst - Analyse client',
        description: 'Analyse comportement client et optimisation assortiment',
        competencesRequises: ['Data Analyst', 'Python', 'SQL', 'Looker'],
        tjmPropose: 480,
        demarrage: 'Mars 2026',
        duree: '5 mois',
        
        
        statut: 'nouvelle',
        priorite: 'basse',
        dateCreation: '2026-01-10',
        consultantsMatches: ['13'],
        ville: 'Strasbourg',
        dureeMois: 12,
        dateDebutSouhaitee: '2026-05-01',
        probabilite: 'nouvelle',
        sequenceTracking: { j0_sent: true, j0_date: "2026-01-23", j3_sent: false, j3_date: null, j7_sent: false, j7_date: null },
        responseTracking: { received: false, responseDate: null, responseType: null, responseChannel: null, notes: '' }
      },
    ];

    // ============================================
    // MOCK DATA - CONSULTANTS
    // ============================================

    // ============================================
    // MOCK DATA
    // ============================================

    const mockHistorique = [
      {
        id: 'h1',
        date: '2026-01-25',
        heure: '14:30',
        type: 'email',
        consultant: 'Karim Benali',
        consultantId: '1',
        action: 'Email envoyé',
        cible: 'Marie Dupont (Dalkia)',
        statut: 'envoye',
        details: 'Email initial pour opportunité Data Engineer - Migration Cloud'
      },
      {
        id: 'h2',
        date: '2026-01-25',
        heure: '11:15',
        type: 'relance',
        consultant: 'Ahmed Moussaoui',
        consultantId: '2',
        action: 'Relance effectuée',
        cible: 'Pierre Martin (SNCF)',
        statut: 'envoye',
        details: 'Relance J+3 suite à email initial'
      },
      {
        id: 'h3',
        date: '2026-01-24',
        heure: '16:45',
        type: 'placement',
        consultant: 'Wei Chen',
        consultantId: '4',
        action: 'Placement réussi',
        cible: "L'Oréal",
        statut: 'succes',
        details: 'Placement confirmé - Mission MLOps 8 mois - TJM 680€'
      },
      {
        id: 'h4',
        date: '2026-01-24',
        heure: '10:20',
        type: 'linkedin',
        consultant: 'Sophie Leroux',
        consultantId: '3',
        action: 'Message LinkedIn',
        cible: 'Jean Durand (Veolia)',
        statut: 'envoye',
        details: 'Message LinkedIn suite à non-réponse email'
      },
      {
        id: 'h5',
        date: '2026-01-23',
        heure: '15:30',
        type: 'email',
        consultant: 'Fatima Garcia',
        consultantId: '6',
        action: 'Email envoyé',
        cible: 'François Bernard (BNP Paribas)',
        statut: 'envoye',
        details: 'Email initial pour opportunité Data Scientist'
      },
      {
        id: 'h6',
        date: '2026-01-23',
        heure: '09:15',
        type: 'placement',
        consultant: 'Thomas Martin',
        consultantId: '7',
        action: 'Placement réussi',
        cible: 'Orange',
        statut: 'succes',
        details: 'Placement confirmé - Architecture Multi-cloud 9 mois - TJM 650€'
      },
      {
        id: 'h7',
        date: '2026-01-22',
        heure: '14:00',
        type: 'relance',
        consultant: 'Léa Petit',
        consultantId: '8',
        action: 'Relance effectuée',
        cible: 'Nicolas Garcia (EDF)',
        statut: 'reponse',
        details: 'Réponse positive - RDV planifié pour le 27/01'
      },
      {
        id: 'h8',
        date: '2026-01-22',
        heure: '11:30',
        type: 'email',
        consultant: 'Maxime Durand',
        consultantId: '9',
        action: 'Email envoyé',
        cible: 'Isabelle Roux (Carrefour)',
        statut: 'envoye',
        details: 'Email initial pour opportunité BI Developer'
      },
      {
        id: 'h9',
        date: '2026-01-21',
        heure: '16:20',
        type: 'escalade',
        consultant: 'Marc Dubois',
        consultantId: '5',
        action: 'Escalade RH',
        cible: 'Direction RH',
        statut: 'en_cours',
        details: 'Profil Finance legacy - Aucune opportunité - Transmission dossier RH'
      },
      {
        id: 'h10',
        date: '2026-01-21',
        heure: '10:45',
        type: 'email',
        consultant: 'Yasmine Bernard',
        consultantId: '10',
        action: 'Email envoyé',
        cible: 'Marie Dupont (Decathlon)',
        statut: 'envoye',
        details: 'Email initial pour opportunité Python Developer'
      },
      {
        id: 'h11',
        date: '2026-01-20',
        heure: '15:15',
        type: 'placement',
        consultant: 'Nadia Moreau',
        consultantId: '12',
        action: 'Placement réussi',
        cible: 'Thales',
        statut: 'succes',
        details: 'Placement confirmé - Computer Vision 12 mois - TJM 700€'
      },
      {
        id: 'h12',
        date: '2026-01-20',
        heure: '11:00',
        type: 'linkedin',
        consultant: 'Paul Lefebvre',
        consultantId: '11',
        action: 'Message LinkedIn',
        cible: 'Jean Durand (Airbus)',
        statut: 'envoye',
        details: 'Message LinkedIn pour opportunité Data Engineer Scala'
      },
      {
        id: 'h13',
        date: '2026-01-19',
        heure: '14:30',
        type: 'relance',
        consultant: 'Hugo Laurent',
        consultantId: '13',
        action: 'Relance effectuée',
        cible: 'Pierre Martin (Auchan)',
        statut: 'envoye',
        details: 'Relance J+3 pour opportunité Data Analyst'
      },
      {
        id: 'h14',
        date: '2026-01-18',
        heure: '16:00',
        type: 'email',
        consultant: 'Emma Blanc',
        consultantId: '15',
        action: 'Email envoyé',
        cible: 'Sophie Laurent (Total Energies)',
        statut: 'reponse',
        details: 'Réponse positive - Entretien technique prévu'
      },
      {
        id: 'h15',
        date: '2026-01-17',
        heure: '10:30',
        type: 'email',
        consultant: 'Youssef Chevalier',
        consultantId: '18',
        action: 'Email envoyé',
        cible: 'Anne Petit (BNP Paribas)',
        statut: 'envoye',
        details: 'Email initial pour opportunité NLP/LLM'
      },
    ];

    // ============================================
    // ALGORITHME DE MATCHING CONSULTANT <-> OPPORTUNITÉ
    // ============================================

    /**
     * Calcule le score de match entre un consultant et une opportunité
     * @returns Score entre 0 et 100
     */
    // Configuration scoring (modifiable dans Paramètres)
    const defaultScoringConfig = {
      competences: { weight: 30, matchParfait: 30, match2sur3: 20, match1sur3: 10, aucunMatch: 5 },
      marge: { weight: 25, seuils: { perte: 0, faible: 5, correct: 15, bon: 20, excellent: 25 }, limites: { perte: 0, faible: 10, correct: 20, bon: 30 } },
      urgence: { weight: 20, seuils: { court: 5, moyen: 8, long: 12, treslag: 16, critique: 20 }, limites: { court: 15, moyen: 30, long: 60, treslag: 90 } },
      geographie: { weight: 15, seuils: { local: 15, proche: 10, moyen: 5, loin: 0 }, limites: { local: 50, proche: 100, moyen: 300 }, bonusMobilite: 5 },
      duree: { weight: 10, seuils: { court: 3, moyen: 6, bon: 8, excellent: 10 }, limites: { court: 3, moyen: 6, bon: 12 } },
      multiplicateurs: { nouvelle: 0.7, chaude: 1.0, negociation: 1.3, urgentDemarrage: 1.2, lointainDemarrage: 0.6 }
    };

    // Récupérer config depuis localStorage ou utiliser défaut
    function getScoringConfig() {
      const saved = localStorage.getItem('pipelineFirstScoringConfig');
      return saved ? JSON.parse(saved) : defaultScoringConfig;
    }

    // Sauvegarder config
    function saveScoringConfig(config) {
      localStorage.setItem('pipelineFirstScoringConfig', JSON.stringify(config));
    }

    // Calculer distance approximative entre deux villes (en km)
    function calculateDistance(ville1, ville2) {
      if (!ville1 || !ville2) return 200; // Distance par défaut si données manquantes
      if (ville1 === ville2) return 0;
      
      // Distances approximatives entre grandes villes françaises
      const distances = {
        'Paris-Lyon': 465, 'Paris-Marseille': 775, 'Paris-Toulouse': 680, 'Paris-Bordeaux': 580,
        'Paris-Nantes': 380, 'Paris-Lille': 220, 'Paris-Strasbourg': 490, 'Paris-Nice': 930,
        'Paris-Rennes': 350, 'Paris-Montpellier': 750,
        'Lyon-Marseille': 315, 'Lyon-Toulouse': 540, 'Lyon-Bordeaux': 560, 'Lyon-Nantes': 660,
        'Lyon-Lille': 690, 'Lyon-Nice': 470, 'Lyon-Montpellier': 300,
        'Marseille-Toulouse': 405, 'Marseille-Nice': 200, 'Marseille-Montpellier': 170,
        'Toulouse-Bordeaux': 245, 'Toulouse-Montpellier': 245,
        'Lille-Strasbourg': 535, 'Bordeaux-Nantes': 330
      };
      
      const key1 = `${ville1}-${ville2}`;
      const key2 = `${ville2}-${ville1}`;
      
      return distances[key1] || distances[key2] || 250; // 250km par défaut
    }

    function calculateMatchScore(consultant, opportunite, config = null) {
      const cfg = config || getScoringConfig();
      let score = 0;
      const details = {}; // Pour tooltip explicatif

      // 1. COMPÉTENCES (30% max)
      const competencesRequises = opportunite.competencesRequises || [];
      const competencesConsultant = consultant.competences || [];
      
      if (competencesRequises.length > 0) {
        const competencesEnCommun = competencesRequises.filter(comp => 
          competencesConsultant.includes(comp)
        ).length;
        const ratio = competencesEnCommun / competencesRequises.length;
        
        let compScore = 0;
        if (ratio >= 0.9) compScore = cfg.competences.matchParfait;
        else if (ratio >= 0.6) compScore = cfg.competences.match2sur3;
        else if (ratio >= 0.3) compScore = cfg.competences.match1sur3;
        else compScore = cfg.competences.aucunMatch;
        
        score += compScore;
        details.competences = { score: compScore, ratio: Math.round(ratio * 100), enCommun: competencesEnCommun, total: competencesRequises.length };
      } else {
        score += 15; // Score par défaut si pas de compétences définies
      }

      // 2. MARGE / RENTABILITÉ (25% max)
      const tjmConsultant = consultant.tjm || 500;
      const tjmCout = consultant.tjmCout || (tjmConsultant * 1.15);
      const tjmClient = opportunite.tjmPropose || 500;
      const marge = ((tjmClient - tjmCout) / tjmCout) * 100;
      
      let margeScore = 0;
      if (marge < 0) margeScore = cfg.marge.seuils.perte; // Perte = 0pts
      else if (marge < 10) margeScore = cfg.marge.seuils.faible;
      else if (marge < 20) margeScore = cfg.marge.seuils.correct;
      else if (marge < 30) margeScore = cfg.marge.seuils.bon;
      else margeScore = cfg.marge.seuils.excellent;
      
      score += margeScore;
      details.marge = { score: margeScore, pct: Math.round(marge), tjmClient, tjmCout };

      // 3. URGENCE INTERCONTRAT (20% max)
      const jours = consultant.joursIntercontrat || 0;
      let urgenceScore = 0;
      
      if (jours < 15) urgenceScore = 5;
      else if (jours < 30) urgenceScore = 8;
      else if (jours < 60) urgenceScore = 12;
      else if (jours < 90) urgenceScore = 16;
      else urgenceScore = 20;
      
      // Pondérer par séniorité (senior coûte plus cher)
      const facteurSeniorite = (tjmCout / 500);
      urgenceScore = urgenceScore * facteurSeniorite;
      urgenceScore = Math.min(urgenceScore, 20); // Plafonner
      
      score += urgenceScore;
      details.urgence = { score: Math.round(urgenceScore), jours, facteurSeniorite: facteurSeniorite.toFixed(2) };

      // 4. GÉOGRAPHIE (15% max)
      const villeConsultant = consultant.ville || 'Paris';
      const villeOpportunite = opportunite.ville || 'Paris';
      const distance = calculateDistance(villeConsultant, villeOpportunite);
      
      let geoScore = 0;
      if (distance < 50) geoScore = 15; // Local
      else if (distance < 100) geoScore = 10; // Proche
      else if (distance < 300) geoScore = 5; // Moyen
      else geoScore = 0; // Loin
      
      // Bonus mobilité
      if (consultant.mobilite && distance > 50) {
        geoScore += 5;
      }
      
      score += geoScore;
      details.geographie = { score: geoScore, distance, villeConsultant, villeOpportunite, mobilite: consultant.mobilite || false };

      // 5. DURÉE MISSION (10% max)
      const dureeMois = opportunite.dureeMois || parseInt(opportunite.duree) || 6;
      let dureeScore = 0;
      
      if (dureeMois < 3) dureeScore = 3;
      else if (dureeMois < 6) dureeScore = 6;
      else if (dureeMois < 12) dureeScore = 8;
      else dureeScore = 10;
      
      score += dureeScore;
      details.duree = { score: dureeScore, mois: dureeMois };

      // 6. MULTIPLICATEURS
      let multiplicateur = 1.0;
      
      // Statut opportunité
      const probabilite = opportunite.probabilite || 'nouvelle';
      if (probabilite === 'nouvelle') multiplicateur *= 0.7;
      else if (probabilite === 'chaude') multiplicateur *= 1.0;
      else if (probabilite === 'negociation') multiplicateur *= 1.3;
      
      // Urgence démarrage
      if (opportunite.dateDebutSouhaitee) {
        const dateDebut = new Date(opportunite.dateDebutSouhaitee);
        const maintenant = new Date();
        const joursAvantDebut = Math.ceil((dateDebut - maintenant) / (1000 * 60 * 60 * 24));
        
        if (joursAvantDebut < 14) multiplicateur *= 1.2; // Urgent
        else if (joursAvantDebut > 90) multiplicateur *= 0.6; // Lointain
      }
      
      score = score * multiplicateur;
      details.multiplicateur = { valeur: multiplicateur.toFixed(2), probabilite };

      const finalScore = Math.min(100, Math.round(score));
      details.scoreTotal = finalScore;
      
      // IMPORTANT: Toujours retourner un nombre valide
      return { 
        score: isNaN(finalScore) ? 50 : finalScore, 
        details 
      };
    }

    /**
     * Récupère toutes les opportunités qui matchent avec un consultant
     * @returns Array d'opportunités avec leur score de match
     */
    function getMatchedOpportunites(consultantId) {
      const consultant = mockConsultants.find(c => c.id === consultantId);
      if (!consultant) return [];

      return mockOpportunites
        .filter(opp => opp.consultantsMatches && opp.consultantsMatches.includes(consultantId))
        .map(opp => {
          const result = calculateMatchScore(consultant, opp);
          return {
            ...opp,
            matchScore: result.score,
            matchDetails: result.details
          };
        })
        .sort((a, b) => b.matchScore - a.matchScore);
    }

    /**
     * Compte le nombre d'opportunités actives pour un consultant
     */
    function countMatchedOpportunites(consultantId) {
      return mockOpportunites.filter(opp => 
        opp.consultantsMatches && 
        opp.consultantsMatches.includes(consultantId) &&
        (opp.statut === 'nouvelle' || opp.statut === 'en_cours')
      ).length;
    }

    const mockConsultants = [
      {
        id: '1',
        nom: 'Benali',
        prenom: 'Karim',
        email: 'k.benali@synchrone.fr',
        competences: ['Data Engineer', 'Python', 'Spark', 'AWS'],
        tjm: 550,
        tjmCout: 632,
        ville: 'Lyon',
        mobilite: true,
        tauxAcceptation: 85,
        anneesExperience: 8,
        joursIntercontrat: 15,
        statut: 'intercontrat',
        rang: 1,
        coutCumule: 6750,
        raisonPriorite: 'Coût cumulé élevé (6 750€). Profil Data Engineer très demandé ce mois, plusieurs opportunités disponibles.',
      },
      {
        id: '2',
        nom: 'Moussaoui',
        prenom: 'Ahmed',
        email: 'a.moussaoui@synchrone.fr',
        competences: ['Data Analyst', 'SQL', 'Power BI', 'Python'],
        tjm: 450,
        tjmCout: 517,
        ville: 'Paris',
        mobilite: false,
        tauxAcceptation: 90,
        anneesExperience: 6,
        joursIntercontrat: 22,
        statut: 'intercontrat',
        rang: 2,
        coutCumule: 7920,
        raisonPriorite: 'Coût élevé (7 920€). Profil Data Analyst moins demandé que Data Engineer.',
      },
      {
        id: '3',
        nom: 'Leroux',
        prenom: 'Sophie',
        email: 's.leroux@synchrone.fr',
        competences: ['Python', 'Django', 'PostgreSQL'],
        tjm: 480,
        tjmCout: 552,
        ville: 'Paris',
        mobilite: true,
        tauxAcceptation: 80,
        anneesExperience: 4,
        joursIntercontrat: 8,
        statut: 'intercontrat',
        rang: 3,
        coutCumule: 2880,
        raisonPriorite: 'Intercontrat récent, coût encore limité. Profil Python recherché.',
      },
      {
        id: '4',
        nom: 'Chen',
        prenom: 'Wei',
        email: 'w.chen@synchrone.fr',
        competences: ['Machine Learning', 'Python', 'TensorFlow', 'MLOps'],
        tjm: 650,
        tjmCout: 747,
        ville: 'Lyon',
        mobilite: true,
        tauxAcceptation: 75,
        joursIntercontrat: 0,
        statut: 'en_mission',
        rang: null,
        coutCumule: 0,
        opportunitesMatchees: 0,
        clientActuel: "L'Oréal",
        missionActuelle: 'MLOps et industrialisation modèles IA',
        datePlacement: '2026-01-24',
        raisonPriorite: 'En mission chez L\'Oréal depuis le 24/01/2026',
        actionRecommandee: null
      },
      {
        id: '5',
        nom: 'Dubois',
        prenom: 'Marc',
        email: 'm.dubois@synchrone.fr',
        competences: ['Finance', 'Excel', 'VBA'],
        tjm: 380,
        tjmCout: 436,
        ville: 'Nantes',
        mobilite: true,
        tauxAcceptation: 88,
        joursIntercontrat: 45,
        statut: 'intercontrat',
        rang: 5,
        coutCumule: 12150,
        opportunitesMatchees: 0,
        raisonPriorite: 'Profil legacy Finance - hors cible Data/IA. Aucune opportunité interne. Escalade RH recommandée.',
        actionRecommandee: null
      },
      {
        id: '6',
        nom: 'Garcia',
        prenom: 'Fatima',
        email: 'f.garcia@synchrone.fr',
        competences: ['Data Scientist', 'Python', 'R', 'Statistics', 'Machine Learning'],
        tjm: 580,
        tjmCout: 667,
        ville: 'Toulouse',
        mobilite: false,
        tauxAcceptation: 92,
        joursIntercontrat: 18,
        statut: 'intercontrat',
        rang: 6,
        coutCumule: 7830,
        opportunitesMatchees: 3,
        raisonPriorite: 'Profil Data Scientist avec 18j d\'intercontrat. 3 opportunités matchées.',
        actionRecommandee: {
          client: 'BNP Paribas',
          contact: 'François Bernard',
          contactEmail: 'f.bernard@bnpparibas.fr',
          contactPoste: 'Directeur Data',
          matchScore: 84,
          description: 'Modélisation risque crédit avec ML',
        }
      },
      {
        id: '7',
        nom: 'Martin',
        prenom: 'Thomas',
        email: 't.martin@synchrone.fr',
        competences: ['Cloud Architect', 'AWS', 'Azure', 'Terraform', 'Kubernetes'],
        tjm: 620,
        tjmCout: 713,
        ville: 'Bordeaux',
        mobilite: true,
        tauxAcceptation: 70,
        joursIntercontrat: 0,
        statut: 'en_mission',
        rang: null,
        coutCumule: 0,
        opportunitesMatchees: 0,
        clientActuel: 'Orange',
        missionActuelle: 'Architecture multi-cloud pour nouveau SI - 9 mois',
        datePlacement: '2026-01-23',
        raisonPriorite: 'En mission chez Orange depuis le 23/01/2026',
        actionRecommandee: null
      },
      {
        id: '8',
        nom: 'Petit',
        prenom: 'Léa',
        email: 'l.petit@synchrone.fr',
        competences: ['DevOps', 'Docker', 'Kubernetes', 'CI/CD', 'Jenkins'],
        tjm: 520,
        tjmCout: 598,
        ville: 'Paris',
        mobilite: true,
        tauxAcceptation: 95,
        joursIntercontrat: 9,
        statut: 'intercontrat',
        rang: 8,
        coutCumule: 3510,
        opportunitesMatchees: 2,
        raisonPriorite: 'Profil DevOps recherché, intercontrat récent.',
        actionRecommandee: {
          client: 'EDF',
          contact: 'Nicolas Garcia',
          contactEmail: 'n.garcia@edf.fr',
          contactPoste: 'VP Engineering',
          matchScore: 78,
          description: 'Mise en place pipeline CI/CD pour applications critiques',
        }
      },
      {
        id: '9',
        nom: 'Durand',
        prenom: 'Maxime',
        email: 'm.durand@synchrone.fr',
        competences: ['BI Developer', 'Power BI', 'SQL', 'DAX', 'Tableau'],
        tjm: 470,
        tjmCout: 540,
        ville: 'Marseille',
        mobilite: false,
        tauxAcceptation: 82,
        joursIntercontrat: 14,
        statut: 'intercontrat',
        rang: 9,
        coutCumule: 4935,
        opportunitesMatchees: 2,
        raisonPriorite: 'BI Developer avec 14j d\'intercontrat, profil demandé.',
        actionRecommandee: {
          client: 'Carrefour',
          contact: 'Isabelle Roux',
          contactEmail: 'i.roux@carrefour.fr',
          contactPoste: 'Responsable BI',
          matchScore: 74,
          description: 'Dashboards ventes et supply chain',
        }
      },
      {
        id: '10',
        nom: 'Bernard',
        prenom: 'Yasmine',
        email: 'y.bernard@synchrone.fr',
        competences: ['Python Developer', 'Django', 'FastAPI', 'PostgreSQL', 'Redis'],
        tjm: 490,
        tjmCout: 563,
        ville: 'Lille',
        mobilite: true,
        tauxAcceptation: 78,
        joursIntercontrat: 11,
        statut: 'intercontrat',
        rang: 10,
        coutCumule: 4042,
        opportunitesMatchees: 3,
        raisonPriorite: 'Python Developer polyvalent, 3 opportunités disponibles.',
        actionRecommandee: {
          client: 'Decathlon',
          contact: 'Marie Dupont',
          contactEmail: 'm.dupont@decathlon.fr',
          contactPoste: 'CTO',
          matchScore: 81,
          description: 'API backend e-commerce nouvelle plateforme',
        }
      },
      {
        id: '11',
        nom: 'Lefebvre',
        prenom: 'Paul',
        email: 'p.lefebvre@synchrone.fr',
        competences: ['Data Engineer', 'Scala', 'Spark', 'Kafka', 'Airflow'],
        tjm: 560,
        tjmCout: 644,
        ville: 'Lyon',
        mobilite: true,
        tauxAcceptation: 86,
        joursIntercontrat: 19,
        statut: 'intercontrat',
        rang: 11,
        coutCumule: 7980,
        opportunitesMatchees: 2,
        raisonPriorite: 'Data Engineer Scala, profil plus rare. Coût qui augmente.',
        actionRecommandee: {
          client: 'Airbus',
          contact: 'Jean Durand',
          contactEmail: 'j.durand@airbus.com',
          contactPoste: 'Lead Data',
          matchScore: 86,
          description: 'Pipeline data temps réel pour IoT industriel',
        }
      },
      {
        id: '12',
        nom: 'Moreau',
        prenom: 'Nadia',
        email: 'n.moreau@synchrone.fr',
        competences: ['Machine Learning', 'PyTorch', 'Computer Vision', 'MLOps'],
        tjm: 640,
        tjmCout: 736,
        ville: 'Paris',
        mobilite: false,
        tauxAcceptation: 91,
        joursIntercontrat: 0,
        statut: 'en_mission',
        rang: null,
        coutCumule: 0,
        opportunitesMatchees: 0,
        clientActuel: 'Thales',
        missionActuelle: 'Computer Vision pour systèmes défense - 12 mois',
        datePlacement: '2026-01-20',
        raisonPriorite: 'En mission chez Thales depuis le 20/01/2026',
        actionRecommandee: null
      },
      {
        id: '13',
        nom: 'Laurent',
        prenom: 'Hugo',
        email: 'h.laurent@synchrone.fr',
        competences: ['Data Analyst', 'Python', 'SQL', 'Looker', 'dbt'],
        tjm: 460,
        tjmCout: 529,
        ville: 'Nantes',
        mobilite: true,
        tauxAcceptation: 84,
        joursIntercontrat: 16,
        statut: 'intercontrat',
        rang: 13,
        coutCumule: 5520,
        opportunitesMatchees: 1,
        raisonPriorite: 'Data Analyst moderne avec stack dbt/Looker.',
        actionRecommandee: {
          client: 'Auchan',
          contact: 'Pierre Martin',
          contactEmail: 'p.martin@auchan.fr',
          contactPoste: 'Responsable Analytics',
          matchScore: 69,
          description: 'Analyse comportement client et optimisation assortiment',
        }
      },
      {
        id: '14',
        nom: 'Roux',
        prenom: 'Rachid',
        email: 'r.roux@synchrone.fr',
        competences: ['Cyber Security', 'SIEM', 'Pentest', 'ISO 27001', 'SOC'],
        tjm: 590,
        tjmCout: 678,
        ville: 'Rennes',
        mobilite: true,
        tauxAcceptation: 79,
        joursIntercontrat: 28,
        statut: 'intercontrat',
        rang: 14,
        coutCumule: 12390,
        opportunitesMatchees: 1,
        raisonPriorite: 'Cyber Security avec long intercontrat, profil spécialisé moins liquide.',
        actionRecommandee: {
          client: 'Société Générale',
          contact: 'François Bernard',
          contactEmail: 'f.bernard@socgen.fr',
          contactPoste: 'RSSI',
          matchScore: 76,
          description: 'Audit sécurité et mise en conformité ISO 27001',
        }
      },
      {
        id: '15',
        nom: 'Blanc',
        prenom: 'Emma',
        email: 'e.blanc@synchrone.fr',
        competences: ['Cloud Architect', 'GCP', 'Terraform', 'Docker', 'Kubernetes'],
        tjm: 610,
        tjmCout: 701,
        ville: 'Strasbourg',
        mobilite: false,
        tauxAcceptation: 88,
        joursIntercontrat: 10,
        statut: 'intercontrat',
        rang: 15,
        coutCumule: 4575,
        opportunitesMatchees: 3,
        raisonPriorite: 'Cloud Architect GCP, profil très demandé actuellement.',
        actionRecommandee: {
          client: 'Total Energies',
          contact: 'Sophie Laurent',
          contactEmail: 's.laurent@totalenergies.com',
          contactPoste: 'Lead Cloud',
          matchScore: 88,
          description: 'Migration applications on-premise vers GCP',
        }
      },
      {
        id: '16',
        nom: 'Lopez',
        prenom: 'Mohamed',
        email: 'm.lopez@synchrone.fr',
        competences: ['Data Engineer', 'Python', 'AWS', 'Redshift', 'dbt'],
        tjm: 540,
        tjmCout: 621,
        ville: 'Lyon',
        mobilite: true,
        tauxAcceptation: 93,
        joursIntercontrat: 13,
        statut: 'intercontrat',
        rang: 16,
        coutCumule: 5265,
        opportunitesMatchees: 2,
        raisonPriorite: 'Data Engineer AWS avec bonne expertise moderne.',
        actionRecommandee: {
          client: 'Safran',
          contact: 'Nicolas Garcia',
          contactEmail: 'n.garcia@safrangroup.com',
          contactPoste: 'Director Data Engineering',
          matchScore: 82,
          description: 'Data warehouse pour analytics industriels',
        }
      },
      {
        id: '17',
        nom: 'Fontaine',
        prenom: 'Clara',
        email: 'c.fontaine@synchrone.fr',
        competences: ['Python Developer', 'Flask', 'React', 'PostgreSQL'],
        tjm: 500,
        tjmCout: 575,
        ville: 'Paris',
        mobilite: true,
        tauxAcceptation: 81,
        joursIntercontrat: 6,
        statut: 'intercontrat',
        rang: 17,
        coutCumule: 2250,
        opportunitesMatchees: 2,
        raisonPriorite: 'Fullstack Python/React, intercontrat très récent.',
        actionRecommandee: {
          client: "L'Oréal",
          contact: 'Isabelle Roux',
          contactEmail: 'i.roux@loreal.com',
          contactPoste: 'Product Owner',
          matchScore: 75,
          description: 'Application interne RH et onboarding',
        }
      },
      {
        id: '18',
        nom: 'Chevalier',
        prenom: 'Youssef',
        email: 'y.chevalier@synchrone.fr',
        competences: ['Data Scientist', 'Python', 'NLP', 'Transformers', 'LLM'],
        tjm: 660,
        tjmCout: 758,
        ville: 'Toulouse',
        mobilite: false,
        tauxAcceptation: 87,
        joursIntercontrat: 4,
        statut: 'intercontrat',
        rang: 18,
        coutCumule: 1980,
        opportunitesMatchees: 6,
        raisonPriorite: 'NLP/LLM specialist, profil ultra-demandé en ce moment.',
        actionRecommandee: {
          client: 'BNP Paribas',
          contact: 'Anne Petit',
          contactEmail: 'a.petit@bnpparibas.fr',
          contactPoste: 'AI Product Lead',
          matchScore: 95,
          description: 'Chatbot intelligent service client avec LLM',
        }
      },
      {
        id: '19',
        nom: 'Robin',
        prenom: 'Julie',
        email: 'j.robin@synchrone.fr',
        competences: ['BI Developer', 'Tableau', 'SQL', 'Python'],
        tjm: 480,
        tjmCout: 552,
        ville: 'Nice',
        mobilite: true,
        tauxAcceptation: 76,
        joursIntercontrat: 17,
        statut: 'intercontrat',
        rang: 19,
        coutCumule: 6120,
        opportunitesMatchees: 1,
        raisonPriorite: 'BI Developer Tableau, profil classique avec coût qui monte.',
        actionRecommandee: {
          client: 'SNCF',
          contact: 'Pierre Martin',
          contactEmail: 'p.martin@sncf.fr',
          contactPoste: 'Manager BI',
          matchScore: 70,
          description: 'Tableaux de bord pilotage opérationnel trains',
        }
      },
      {
        id: '20',
        nom: 'Masson',
        prenom: 'David',
        email: 'd.masson@synchrone.fr',
        competences: ['DevOps', 'GitLab', 'Ansible', 'Terraform', 'AWS'],
        tjm: 530,
        tjmCout: 609,
        ville: 'Montpellier',
        mobilite: true,
        tauxAcceptation: 89,
        joursIntercontrat: 20,
        statut: 'intercontrat',
        rang: 20,
        coutCumule: 7950,
        opportunitesMatchees: 2,
        raisonPriorite: 'DevOps avec intercontrat qui s\'allonge, 2 opportunités à actionner.',
        actionRecommandee: {
          client: 'Orange',
          contact: 'Jean Durand',
          contactEmail: 'j.durand@orange.fr',
          contactPoste: 'Engineering Manager',
          matchScore: 79,
          description: 'Infrastructure as Code et automatisation déploiements',
        }
      },
      {
        id: '21',
        nom: 'Garnier',
        prenom: 'Laura',
        email: 'l.garnier@synchrone.fr',
        competences: ['Data Analyst', 'Excel', 'VBA', 'Power BI'],
        tjm: 420,
        tjmCout: 482,
        ville: 'Paris',
        mobilite: false,
        tauxAcceptation: 85,
        joursIntercontrat: 31,
        statut: 'intercontrat',
        rang: 21,
        coutCumule: 9765,
        opportunitesMatchees: 1,
        raisonPriorite: 'Data Analyst junior, intercontrat long avec peu d\'opportunités.',
        actionRecommandee: {
          client: 'Veolia',
          contact: 'Marie Dupont',
          contactEmail: 'm.dupont@veolia.fr',
          contactPoste: 'Contrôleur de gestion',
          matchScore: 64,
          description: 'Reporting financier et KPI opérationnels',
        }
      },
      {
        id: '22',
        nom: 'Faure',
        prenom: 'Ali',
        email: 'a.faure@synchrone.fr',
        competences: ['Python Developer', 'Django', 'PostgreSQL', 'Redis'],
        tjm: 510,
        tjmCout: 586,
        ville: 'Lyon',
        mobilite: true,
        tauxAcceptation: 90,
        joursIntercontrat: 24,
        statut: 'intercontrat',
        rang: 22,
        coutCumule: 9180,
        opportunitesMatchees: 1,
        raisonPriorite: 'Python backend, intercontrat qui dure malgré profil solide.',
        actionRecommandee: {
          client: 'Carrefour',
          contact: 'François Bernard',
          contactEmail: 'f.bernard@carrefour.fr',
          contactPoste: 'Tech Lead',
          matchScore: 72,
          description: 'API marketplace fournisseurs',
        }
      },
      {
        id: '23',
        nom: 'Andre',
        prenom: 'Charlotte',
        email: 'c.andre@synchrone.fr',
        competences: ['Cyber Security', 'Firewall', 'VPN', 'SIEM'],
        tjm: 570,
        tjmCout: 655,
        ville: 'Bordeaux',
        mobilite: true,
        tauxAcceptation: 83,
        joursIntercontrat: 35,
        statut: 'intercontrat',
        rang: 23,
        coutCumule: 14962,
        opportunitesMatchees: 0,
        raisonPriorite: 'Cyber Security avec long intercontrat, profil réseau moins aligné avec demande actuelle.',
        actionRecommandee: null
      },
      {
        id: '24',
        nom: 'Mercier',
        prenom: 'Lucas',
        email: 'l.mercier@synchrone.fr',
        competences: ['Data Analyst', 'SQL', 'Python', 'Matplotlib'],
        tjm: 440,
        tjmCout: 505,
        ville: 'Lille',
        mobilite: false,
        tauxAcceptation: 77,
        joursIntercontrat: 27,
        statut: 'intercontrat',
        rang: 24,
        coutCumule: 8910,
        opportunitesMatchees: 1,
        raisonPriorite: 'Data Analyst classique, intercontrat long avec peu de matching.',
        actionRecommandee: {
          client: 'Dalkia',
          contact: 'Sophie Laurent',
          contactEmail: 's.laurent@dalkia.fr',
          contactPoste: 'Data Manager',
          matchScore: 67,
          description: 'Analyse consommation énergétique bâtiments',
        }
      },
      {
        id: '25',
        nom: 'Blanchard',
        prenom: 'Sarah',
        email: 's.blanchard@synchrone.fr',
        competences: ['Finance', 'SAP', 'Reporting', 'Excel'],
        tjm: 390,
        tjmCout: 448,
        ville: 'Paris',
        mobilite: true,
        tauxAcceptation: 94,
        joursIntercontrat: 52,
        statut: 'intercontrat',
        rang: 25,
        coutCumule: 15210,
        opportunitesMatchees: 0,
        raisonPriorite: 'Profil Finance SAP legacy, très long intercontrat. Escalade RH recommandée.',
        actionRecommandee: null
      }
    ];

    const mockActions = [
      { id: '1', consultantId: '1', type: 'email', label: 'Email Marie (Dalkia) pour Karim', datePrevue: "Aujourd'hui", statut: 'a_faire' },
      { id: '2', consultantId: '2', type: 'relance', label: 'Relance SNCF pour Ahmed', datePrevue: "Aujourd'hui", statut: 'a_faire' },
      { id: '3', consultantId: '1', type: 'linkedin', label: 'Message LinkedIn Veolia', datePrevue: 'Demain', statut: 'a_faire' },
    ];

    // Calculate real stats from consultants
    const calculateStats = () => {
      const consultantsIntercontrat = mockConsultants.filter(c => c.statut === 'intercontrat');
      const intercontrats30j = consultantsIntercontrat.filter(c => c.joursIntercontrat <= 30).length;
      const intercontrats60j = consultantsIntercontrat.filter(c => c.joursIntercontrat > 30 && c.joursIntercontrat <= 60).length;
      const intercontrats90j = consultantsIntercontrat.filter(c => c.joursIntercontrat > 60).length;
      const opportunitesActives = mockOpportunites.filter(o => o.statut === 'nouvelle' || o.statut === 'en_cours').length;
      
      return {
        intercontrats30j,
        intercontrats60j,
        intercontrats90j,
        opportunites: opportunitesActives,
      };
    };

    const mockStats = calculateStats();

    // ============================================
    // ICONS
    // ============================================

    const Icons = {
      Dashboard: () => (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <rect x="3" y="3" width="7" height="7"/>
          <rect x="14" y="3" width="7" height="7"/>
          <rect x="14" y="14" width="7" height="7"/>
          <rect x="3" y="14" width="7" height="7"/>
        </svg>
      ),
      Users: () => (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M17 21v-2a4 4 0 0 0-4-4H5a4 4 0 0 0-4 4v2"/>
          <circle cx="9" cy="7" r="4"/>
          <path d="M23 21v-2a4 4 0 0 0-3-3.87"/>
          <path d="M16 3.13a4 4 0 0 1 0 7.75"/>
        </svg>
      ),
      BarChart: () => (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <line x1="12" y1="20" x2="12" y2="10"/>
          <line x1="18" y1="20" x2="18" y2="4"/>
          <line x1="6" y1="20" x2="6" y2="16"/>
        </svg>
      ),
      Briefcase: () => (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <rect x="2" y="7" width="20" height="14" rx="2" ry="2"/>
          <path d="M16 21V5a2 2 0 0 0-2-2h-4a2 2 0 0 0-2 2v16"/>
        </svg>
      ),
      History: () => (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="12" cy="12" r="10"/>
          <polyline points="12 6 12 12 16 14"/>
        </svg>
      ),
      Settings: () => (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="12" cy="12" r="3"/>
          <path d="M12 1v6m0 6v6m9-9h-6m-6 0H3m15.364-6.364l-4.242 4.242m-6.364 0L3.636 3.636m12.728 12.728l-4.242 4.242m-6.364 0L3.636 20.364"/>
        </svg>
      ),
      ArrowLeft: () => (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <line x1="19" y1="12" x2="5" y2="12"/>
          <polyline points="12 19 5 12 12 5"/>
        </svg>
      ),
      ChevronRight: () => (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="9 18 15 12 9 6"/>
        </svg>
      ),
      Refresh: () => (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="23 4 23 10 17 10"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
      ),
      RefreshCw: () => (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="23 4 23 10 17 10"/>
          <path d="M20.49 15a9 9 0 1 1-2.12-9.36L23 10"/>
        </svg>
      ),
      Check: () => (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="20 6 9 17 4 12"/>
        </svg>
      ),
      Send: () => (
        <svg width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <line x1="22" y1="2" x2="11" y2="13"/>
          <polygon points="22 2 15 22 11 13 2 9 22 2"/>
        </svg>
      ),
      AlertTriangle: () => (
        <svg width="18" height="18" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <path d="M10.29 3.86L1.82 18a2 2 0 0 0 1.71 3h16.94a2 2 0 0 0 1.71-3L13.71 3.86a2 2 0 0 0-3.42 0z"/>
          <line x1="12" y1="9" x2="12" y2="13"/>
          <line x1="12" y1="17" x2="12.01" y2="17"/>
        </svg>
      ),
      Info: () => (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <circle cx="12" cy="12" r="10"/>
          <line x1="12" y1="16" x2="12" y2="12"/>
          <line x1="12" y1="8" x2="12.01" y2="8"/>
        </svg>
      ),
      TrendingUp: () => (
        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" strokeWidth="2">
          <polyline points="23 6 13.5 15.5 8.5 10.5 1 18"/>
          <polyline points="17 6 23 6 23 12"/>
        </svg>
      ),
    };

    // ============================================
    // COMPONENTS
    // ============================================

    function Sidebar({ currentPage, onNavigate }) {
      const intercontrats = mockConsultants.filter(c => c.statut === 'intercontrat').length;
      const opportunitesActives = mockOpportunites.filter(o => o.statut === 'nouvelle' || o.statut === 'en_cours').length;
      
      const navItems = [
        { id: 'dashboard', label: 'Dashboard', icon: Icons.Dashboard, badge: null },
        { id: 'consultants', label: 'Consultants', icon: Icons.Users, badge: intercontrats },
        { id: 'opportunites', label: 'Opportunités', icon: Icons.Briefcase, badge: opportunitesActives },
        { id: 'historique', label: 'Historique', icon: Icons.History, badge: null },
        { id: 'synthese', label: 'Synthèse', icon: Icons.BarChart, badge: null },
        { id: 'impact', label: 'Impact ROI', icon: Icons.TrendingUp, badge: null },
      ];

      return (
        <aside className="sidebar">
          <div className="logo">
            <div className="logo-icon">PF</div>
            <div className="logo-text">Pipeline<span>First</span></div>
          </div>

          <nav className="nav-section">
            <div className="nav-label">Navigation</div>
            {navItems.map(item => (
              <div
                key={item.id}
                className={`nav-item ${currentPage === item.id ? 'active' : ''}`}
                onClick={() => onNavigate(item.id)}
              >
                <item.icon />
                {item.label}
                {item.badge && <span className="nav-badge">{item.badge}</span>}
              </div>
            ))}
          </nav>

          <nav className="nav-section">
            <div className="nav-label">Système</div>
            <div className="nav-item" onClick={() => onNavigate('config')}>
              <Icons.Settings />
              Configuration
            </div>
          </nav>

          <div className="sidebar-footer">
            <div className="user-card">
              <div className="user-avatar">MB</div>
              <div className="user-info">
                <div className="user-name">Florian Legrand</div>
                <div className="user-role">Business Manager</div>
              </div>
            </div>
          </div>
        </aside>
      );
    }

    function KPICard({ label, value, subtext, type }) {
      return (
        <div className={`kpi-card ${type}`}>
          <div className="kpi-label">{label}</div>
          <div className="kpi-value">{value}</div>
          {subtext && <div className="kpi-subtext">{subtext}</div>}
        </div>
      );
    }

    function PriorityCard({ consultant, onClick, oppCount }) {
      const rankClass = consultant.rang <= 3 ? `rank-${consultant.rang}` : '';
      
      return (
        <div className={`priority-card ${rankClass}`} onClick={() => onClick(consultant)} style={{ cursor: 'pointer' }}>
          <div className="rank-badge">#{consultant.rang}</div>
          
          <div className="priority-info">
            <div className="priority-name">
              {consultant.prenom} {consultant.nom}
            </div>
            <div className="priority-role">{consultant.competences[0]}</div>
            <div className="geo-location">
              <span className="geo-badge">
                <span className="geo-icon">📍</span>
                {consultant.ville}
              </span>
              {consultant.mobilite && (
                <span className="geo-badge mobile">✓ Mobile</span>
              )}
            </div>
            <div className="priority-tags">
              {consultant.competences.slice(1, 4).map(c => (
                <span key={c} className="tag">{c}</span>
              ))}
            </div>
          </div>

          <div className="priority-stats">
            <div className="stat">
              <div className="stat-value cost">{consultant.coutCumule.toLocaleString()}€</div>
              <div className="stat-label">Coût</div>
            </div>
            <div className="stat">
              <div className="stat-value days">{consultant.joursIntercontrat}j</div>
              <div className="stat-label">Durée</div>
            </div>
            <div className="stat">
              <div className="stat-value opps">{oppCount !== undefined ? oppCount : consultant.opportunitesMatchees}</div>
              <div className="stat-label">Opps</div>
            </div>
          </div>
        </div>
      );
    }

    function ActionItem({ action, onDone, onSkip }) {
      return (
        <div className="action-item">
          <div className={`action-icon ${action.type === 'linkedin' ? 'linkedin' : 'email'}`}>
            {action.type === 'linkedin' ? '💼' : '📧'}
          </div>
          <div className="action-content">
            <div className="action-label">{action.label}</div>
            <div className="action-date">{action.datePrevue}</div>
          </div>
          <div className="action-buttons">
            <button className="btn btn-success" onClick={() => onDone(action.id)}>
              <Icons.Check /> Fait
            </button>
            <button className="btn btn-ghost" onClick={() => onSkip(action.id)}>
              Passer
            </button>
          </div>
        </div>
      );
    }

    // ============================================
    // CAMPAGNE MODAL
    // ============================================


    function ScoringModal({ onClose }) {
      return (
        <div className="modal-overlay" onClick={onClose}>
          <div className="modal" onClick={(e) => e.stopPropagation()}>
            <div className="modal-header">
              <div className="modal-title">
                <Icons.Info />
                Méthodologie de priorisation
              </div>
              <button className="modal-close" onClick={onClose}>×</button>
            </div>
            <div className="modal-body">
              <p style={{ fontSize: '14px', color: 'var(--text-secondary)', marginBottom: '24px', lineHeight: '1.7' }}>
                Pipeline First calcule un score de priorité pour chaque consultant en intercontrat en combinant plusieurs critères clés. 
                L'objectif est d'identifier qui nécessite une action urgente pour minimiser les coûts et maximiser les placements.
              </p>

              <div className="scoring-grid">
                <div className="scoring-criterion">
                  <div className="criterion-header">
                    <div className="criterion-name">Durée d'intercontrat</div>
                    <div className="criterion-weight">Poids: 40%</div>
                  </div>
                  <div className="criterion-description">
                    Plus un consultant est en intercontrat longtemps, plus il devient prioritaire. Chaque jour compte pour éviter l'accumulation de coûts.
                  </div>
                </div>

                <div className="scoring-criterion">
                  <div className="criterion-header">
                    <div className="criterion-name">Coût cumulé</div>
                    <div className="criterion-weight">Poids: 30%</div>
                  </div>
                  <div className="criterion-description">
                    Le coût déjà accumulé (jours × TJM × 75%) détermine l'urgence financière. Les consultants qui ont généré beaucoup de coûts sont prioritaires.
                  </div>
                </div>

                <div className="scoring-criterion">
                  <div className="criterion-header">
                    <div className="criterion-name">Opportunités matchées</div>
                    <div className="criterion-weight">Poids: 20%</div>
                  </div>
                  <div className="criterion-description">
                    Les consultants avec plusieurs opportunités de placement identifiées sont prioritaires car les chances de succès sont élevées.
                  </div>
                </div>

                <div className="scoring-criterion">
                  <div className="criterion-header">
                    <div className="criterion-name">Profil métier</div>
                    <div className="criterion-weight">Poids: 10%</div>
                  </div>
                  <div className="criterion-description">
                    Les profils très demandés (Data Engineer, ML, Cloud) ou au contraire obsolètes (Finance, legacy) influencent la priorité.
                  </div>
                </div>
              </div>

              <div className="formula-box">
                <strong>Formule de calcul du score :</strong><br/><br/>
                Score = (Jours × 2 × 0.4) + (Coût / 100 × 0.3) + (Opportunités × 10 × 0.2) + (Bonus Profil × 0.1)
                <br/><br/>
                Les consultants sont ensuite classés par score décroissant pour établir le ranking hebdomadaire.
              </div>
            </div>
          </div>
        </div>
      );
    }

    function Dashboard({ onSelectConsultant, onAddAction, onUpdateOpportunity, opportunities = mockOpportunites }) {
      const [isRefreshing, setIsRefreshing] = useState(false);
      const [actions, setActions] = useState(mockActions);
      const [toast, setToast] = useState(null);
      const [showScoringModal, setShowScoringModal] = useState(false);

      // Calculer le nombre d'opportunités matchées pour chaque consultant
      const getOpportunitiesCount = (consultantId) => {
        return opportunities.filter(opp => 
          opp.consultantsMatches && opp.consultantsMatches.includes(consultantId)
        ).length;
      };

      // Calculer les relances J+3 et J+7 à faire
      const getRelances = () => {
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        
        const relances = [];
        
        opportunities.forEach(opp => {
          if (!opp.sequenceTracking || !opp.consultantsMatches || opp.statut === 'gagnee' || opp.statut === 'perdue') return;
          
          const tracking = opp.sequenceTracking;
          
          // Relance J+3 à faire
          if (tracking.j0_sent && !tracking.j3_sent && tracking.j0_date) {
            const j0Date = new Date(tracking.j0_date);
            const j3ExpectedDate = new Date(j0Date);
            j3ExpectedDate.setDate(j0Date.getDate() + 3);
            j3ExpectedDate.setHours(0, 0, 0, 0);
            
            const daysDiff = Math.floor((today - j3ExpectedDate) / (1000 * 60 * 60 * 24));
            
            // Si prévu aujourd'hui, demain, ou en retard
            if (daysDiff >= -1) {
              opp.consultantsMatches.forEach(consultantId => {
                const consultant = mockConsultants.find(c => c.id === consultantId);
                if (consultant) {
                  relances.push({
                    id: `${opp.id}-${consultantId}-j3`,
                    type: 'j3',
                    consultant: consultant,
                    opportunite: opp,
                    expectedDate: j3ExpectedDate,
                    daysDiff: daysDiff,
                    urgence: daysDiff > 0 ? 'retard' : daysDiff === 0 ? 'aujourd_hui' : 'demain'
                  });
                }
              });
            }
          }
          
          // Relance J+7 à faire
          if (tracking.j3_sent && !tracking.j7_sent && tracking.j3_date) {
            const j3Date = new Date(tracking.j3_date);
            const j7ExpectedDate = new Date(j3Date);
            j7ExpectedDate.setDate(j3Date.getDate() + 4); // J+3 à J+7 = 4 jours
            j7ExpectedDate.setHours(0, 0, 0, 0);
            
            const daysDiff = Math.floor((today - j7ExpectedDate) / (1000 * 60 * 60 * 24));
            
            // Si prévu aujourd'hui, demain, ou en retard
            if (daysDiff >= -1) {
              opp.consultantsMatches.forEach(consultantId => {
                const consultant = mockConsultants.find(c => c.id === consultantId);
                if (consultant) {
                  relances.push({
                    id: `${opp.id}-${consultantId}-j7`,
                    type: 'j7',
                    consultant: consultant,
                    opportunite: opp,
                    expectedDate: j7ExpectedDate,
                    daysDiff: daysDiff,
                    urgence: daysDiff > 0 ? 'retard' : daysDiff === 0 ? 'aujourd_hui' : 'demain'
                  });
                }
              });
            }
          }
        });
        
        // Trier par urgence puis par date
        return relances.sort((a, b) => {
          const urgenceOrder = { 'retard': 0, 'aujourd_hui': 1, 'demain': 2 };
          if (urgenceOrder[a.urgence] !== urgenceOrder[b.urgence]) {
            return urgenceOrder[a.urgence] - urgenceOrder[b.urgence];
          }
          return b.daysDiff - a.daysDiff;
        });
      };

      const relances = getRelances();

      const handleRefresh = () => {
        setIsRefreshing(true);
        setTimeout(() => setIsRefreshing(false), 2000);
      };

      const handleActionDone = (id) => {
        setActions(prev => prev.filter(a => a.id !== id));
        setToast('Action marquée comme faite ✓');
        setTimeout(() => setToast(null), 3000);
      };

      const handleActionSkip = (id) => {
        setActions(prev => prev.filter(a => a.id !== id));
      };

      const intercontrats = mockConsultants.filter(c => c.statut === 'intercontrat');

      return (
        <div className="main-content">
          <header className="page-header">
            <h1 className="page-title">Tableau de bord</h1>
            <p className="page-subtitle">
              Semaine du <strong>27 janvier 2026</strong> • {intercontrats.length} consultants en intercontrat
            </p>
          </header>

          <div className="kpi-grid">
            <KPICard label="Intercontrats < 30j" value={mockStats.intercontrats30j} subtext="Récent" type="ok" />
            <KPICard label="Intercontrats 30-60j" value={mockStats.intercontrats60j} subtext="À surveiller" type="warning" />
            <KPICard label="Intercontrats 60j+" value={mockStats.intercontrats90j} subtext="Action urgente" type="critical" />
            <KPICard label="Opportunités ouvertes" value={mockStats.opportunites} subtext="+3 cette semaine" type="info" />
          </div>

          <section className="section">
            <div className="section-header">
              <h2 className="section-title">
                <span className="section-title-icon">🏆</span>
                Priorités de la semaine
              </h2>
              <div style={{ display: 'flex', gap: '12px' }}>
                <button className="btn btn-ghost" onClick={() => setShowScoringModal(true)}>
                  <Icons.Info /> Méthodologie
                </button>
                <button className="btn btn-secondary" onClick={handleRefresh} disabled={isRefreshing}>
                  {isRefreshing ? (
                    <><span className="loading-spinner"></span> Calcul...</>
                  ) : (
                    <><Icons.Refresh /> Recalculer</>
                  )}
                </button>
              </div>
            </div>

            <div className="priority-list">
              {intercontrats.slice(0, 5).map(consultant => (
                <PriorityCard
                  key={consultant.id}
                  consultant={consultant}
                  onClick={(c) => onSelectConsultant(c)}
                  oppCount={getOpportunitiesCount(consultant.id)}
                />
              ))}
            </div>
          </section>

          {/* Section Relances */}
          {relances.length > 0 && (
            <section className="section">
              <div className="section-header">
                <h2 className="section-title">
                  <span className="section-title-icon">🔔</span>
                  Relances à faire
                  <span style={{ 
                    marginLeft: '12px',
                    padding: '4px 10px',
                    background: relances.filter(r => r.urgence === 'retard').length > 0 ? 'var(--status-critical)' : 'var(--status-warning)',
                    color: 'white',
                    borderRadius: '12px',
                    fontSize: '13px',
                    fontWeight: 700
                  }}>
                    {relances.length}
                  </span>
                </h2>
              </div>

              <div style={{ display: 'flex', flexDirection: 'column', gap: '12px' }}>
                {relances.map(relance => {
                  const getUrgenceBadge = (urgence, daysDiff) => {
                    if (urgence === 'retard') {
                      return { 
                        text: `En retard (${Math.abs(daysDiff)}j)`, 
                        bg: 'var(--status-critical)', 
                        color: 'white' 
                      };
                    }
                    if (urgence === 'aujourd_hui') {
                      return { 
                        text: 'Aujourd\'hui', 
                        bg: 'var(--status-warning)', 
                        color: 'white' 
                      };
                    }
                    return { 
                      text: 'Demain', 
                      bg: 'var(--accent-cyan)', 
                      color: 'white' 
                    };
                  };

                  const badge = getUrgenceBadge(relance.urgence, relance.daysDiff);
                  
                  return (
                    <div 
                      key={relance.id}
                      className="card clickable"
                      onClick={() => onSelectConsultant(relance.consultant)}
                      style={{ 
                        padding: '16px',
                        display: 'grid',
                        gridTemplateColumns: 'auto 1fr auto auto',
                        gap: '16px',
                        alignItems: 'center',
                        background: relance.urgence === 'retard' ? 'rgba(239, 68, 68, 0.05)' : 'var(--bg-card)'
                      }}
                    >
                      <div style={{ fontSize: '28px' }}>
                        {relance.type === 'j3' ? '📨' : '💼'}
                      </div>
                      
                      <div>
                        <div style={{ fontWeight: 600, marginBottom: '4px' }}>
                          {relance.consultant.prenom} {relance.consultant.nom} → {relance.opportunite.client}
                        </div>
                        <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                          {relance.type === 'j3' ? 'Relance J+3 email' : 'Approche J+7 LinkedIn'} • 
                          Prévu le {relance.expectedDate.toLocaleDateString('fr-FR')}
                        </div>
                      </div>

                      <span style={{ 
                        padding: '6px 12px',
                        background: badge.bg,
                        color: badge.color,
                        borderRadius: '6px',
                        fontSize: '12px',
                        fontWeight: 600,
                        whiteSpace: 'nowrap'
                      }}>
                        {badge.text}
                      </span>

                      <button 
                        className="btn btn-sm btn-primary"
                        onClick={(e) => {
                          e.stopPropagation();
                          onSelectConsultant(relance.consultant);
                        }}
                      >
                        Voir fiche
                      </button>
                    </div>
                  );
                })}
              </div>
            </section>
          )}

          <section className="section">
            <div className="section-header">
              <h2 className="section-title">
                <span className="section-title-icon">⚡</span>
                Actions à faire aujourd'hui
              </h2>
            </div>

            {actions.length > 0 ? (
              <div className="actions-list">
                {actions.map(action => (
                  <ActionItem key={action.id} action={action} onDone={handleActionDone} onSkip={handleActionSkip} />
                ))}
              </div>
            ) : (
              <div className="empty-state">
                <div className="empty-state-icon">✓</div>
                <p>Toutes les actions du jour sont terminées !</p>
              </div>
            )}
          </section>

          {toast && (
            <div className="toast">
              <span className="toast-icon">✓</span>
              <span className="toast-message">{toast}</span>
            </div>
          )}

          {showScoringModal && <ScoringModal onClose={() => setShowScoringModal(false)} />}
        </div>
      );
    }

    // ============================================
    // OPPORTUNITES PAGE
    // ============================================

    function OpportunitesPage({ onSelectConsultant }) {
      const [filterClient, setFilterClient] = useState('all');
      const [filterCompetence, setFilterCompetence] = useState('all');
      const [filterStatut, setFilterStatut] = useState('all');
      const [selectedOpp, setSelectedOpp] = useState(null);

      // Extract unique values for filters
      const allClients = [...new Set(mockOpportunites.map(o => o.client))].sort();
      const allCompetences = [...new Set(mockOpportunites.flatMap(o => o.competencesRequises))].sort();

      // Filter opportunities
      let filteredOpps = mockOpportunites.filter(opp => {
        const matchClient = filterClient === 'all' || opp.client === filterClient;
        const matchCompetence = filterCompetence === 'all' || opp.competencesRequises.includes(filterCompetence);
        const matchStatut = filterStatut === 'all' || opp.statut === filterStatut;
        return matchClient && matchCompetence && matchStatut;
      });

      // Calculate matching score for consultant
      // Get matched consultants with scores (utilise calculateMatchScore globale)
      const getMatchedConsultantsWithScores = (opportunite) => {
        // Si opportunité gagnée, retourner seulement le consultant placé
        if (opportunite.statut === 'gagnee' && opportunite.consultantPlace) {
          const placedConsultant = mockConsultants.find(c => c.id === opportunite.consultantPlace);
          if (placedConsultant) {
            const result = calculateMatchScore(placedConsultant, opportunite);
            return [{
              ...placedConsultant,
              matchScore: result?.score || 50,
              matchDetails: result?.details || {},
              isPlaced: true
            }];
          }
        }
        
        // Sinon, retourner tous les consultants matchés
        return (opportunite.consultantsMatches || [])
          .map(id => mockConsultants.find(c => c.id === id))
          .filter(Boolean)
          .map(consultant => {
            const result = calculateMatchScore(consultant, opportunite);
            return {
              ...consultant,
              matchScore: result?.score || 50,
              matchDetails: result?.details || {},
              isPlaced: false
            };
          })
          .sort((a, b) => b.matchScore - a.matchScore);
      };

      const getStatutColor = (statut) => {
        switch(statut) {
          case 'nouvelle': return 'var(--accent-cyan)';
          case 'en_cours': return 'var(--status-warning)';
          case 'gagnee': return 'var(--status-ok)';
          case 'perdue': return 'var(--text-muted)';
          default: return 'var(--text-secondary)';
        }
      };

      const getStatutLabel = (statut) => {
        switch(statut) {
          case 'nouvelle': return 'Nouvelle';
          case 'en_cours': return 'En cours';
          case 'gagnee': return 'Gagnée';
          case 'perdue': return 'Perdue';
          default: return statut;
        }
      };

      // Stats
      const stats = {
        total: mockOpportunites.length,
        nouvelles: mockOpportunites.filter(o => o.statut === 'nouvelle').length,
        enCours: mockOpportunites.filter(o => o.statut === 'en_cours').length,
        gagnees: mockOpportunites.filter(o => o.statut === 'gagnee').length,
      };

      return (
        <div className="main-content">
          <header className="page-header">
            <h1 className="page-title">Opportunités clients</h1>
            <p className="page-subtitle">
              {filteredOpps.length} opportunité{filteredOpps.length > 1 ? 's' : ''} • 
              {stats.nouvelles} nouvelles • {stats.enCours} en cours • {stats.gagnees} placées
            </p>
          </header>

          <div className="filters-bar">
            <select 
              className="filter-select" 
              value={filterClient} 
              onChange={(e) => setFilterClient(e.target.value)}
            >
              <option value="all">Tous les clients</option>
              {allClients.map(client => (
                <option key={client} value={client}>{client}</option>
              ))}
            </select>

            <select 
              className="filter-select" 
              value={filterCompetence} 
              onChange={(e) => setFilterCompetence(e.target.value)}
            >
              <option value="all">Toutes les compétences</option>
              {allCompetences.map(comp => (
                <option key={comp} value={comp}>{comp}</option>
              ))}
            </select>

            <select 
              className="filter-select" 
              value={filterStatut} 
              onChange={(e) => setFilterStatut(e.target.value)}
            >
              <option value="all">Tous les statuts</option>
              <option value="nouvelle">Nouvelle</option>
              <option value="en_cours">En cours</option>
              <option value="gagnee">Gagnée</option>
              <option value="perdue">Perdue</option>
            </select>
          </div>

          <div style={{ display: 'grid', gap: '16px' }}>
            {filteredOpps.map(opp => {
              const matched = getMatchedConsultantsWithScores(opp);
              const topConsultant = matched[0];
              
              return (
                <div 
                  key={opp.id}
                  className="card clickable"
                  onClick={() => setSelectedOpp(opp)}
                  style={{ padding: '24px' }}
                >
                  <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'flex-start', marginBottom: '16px' }}>
                    <div>
                      <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '8px' }}>
                        <h3 style={{ fontSize: '16px', fontWeight: 600, margin: 0 }}>
                          {opp.client}
                        </h3>
                        <span 
                          className="tag"
                          style={{ 
                            background: `${getStatutColor(opp.statut)}22`,
                            color: getStatutColor(opp.statut),
                            border: `1px solid ${getStatutColor(opp.statut)}44`
                          }}
                        >
                          {getStatutLabel(opp.statut)}
                        </span>
                      </div>
                      <p style={{ fontSize: '14px', color: 'var(--text-secondary)', margin: '0 0 4px 0' }}>
                        {opp.competencesRequises.join(', ')} • TJM {opp.tjmPropose}€
                      </p>
                      <div style={{ display: 'flex', gap: '8px', alignItems: 'center', marginBottom: '8px' }}>
                        {opp.ville && (
                          <span className="geo-badge">
                            <span className="geo-icon">📍</span>
                            {opp.ville}
                          </span>
                        )}
                        {opp.dureeMois && (
                          <span className="geo-badge">
                            <span className="geo-icon">⏱️</span>
                            {opp.dureeMois} mois
                          </span>
                        )}
                        {opp.probabilite && (
                          <span 
                            className="geo-badge"
                            style={{ 
                              background: opp.probabilite === 'chaude' ? 'rgba(255, 165, 2, 0.15)' : 
                                         opp.probabilite === 'negociation' ? 'rgba(46, 213, 115, 0.15)' : 
                                         'var(--bg-tertiary)',
                              color: opp.probabilite === 'chaude' ? 'var(--status-warning)' : 
                                     opp.probabilite === 'negociation' ? 'var(--status-ok)' : 
                                     'var(--text-secondary)',
                              border: opp.probabilite === 'chaude' ? '1px solid rgba(255, 165, 2, 0.3)' : 
                                     opp.probabilite === 'negociation' ? '1px solid rgba(46, 213, 115, 0.3)' : 
                                     '1px solid var(--border-subtle)'
                            }}
                          >
                            <span className="geo-icon">🔥</span>
                            {opp.probabilite}
                          </span>
                        )}
                      </div>
                      <p style={{ fontSize: '13px', color: 'var(--text-muted)', margin: 0 }}>
                        {opp.description}
                      </p>
                    </div>
                    
                    {topConsultant && (
                      <div style={{ textAlign: 'right', minWidth: '120px' }}>
                        <div 
                          style={{ 
                            fontSize: '24px', 
                            fontWeight: 700, 
                            fontFamily: 'var(--font-mono)',
                            color: topConsultant.matchScore >= 80 ? 'var(--status-ok)' : 'var(--accent-cyan)',
                            marginBottom: '4px',
                            cursor: 'help',
                            padding: '4px 8px',
                            borderRadius: 'var(--radius-sm)',
                            transition: 'all 0.2s ease'
                          }}
                          onMouseEnter={(e) => e.currentTarget.style.background = 'var(--bg-tertiary)'}
                          onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                          title={topConsultant.matchDetails ? `${topConsultant.prenom} ${topConsultant.nom} - Détail :
🎯 Compétences : ${topConsultant.matchDetails.competences?.score || 0}pts
💰 Marge : ${topConsultant.matchDetails.marge?.score || 0}pts (${topConsultant.matchDetails.marge?.pct || 0}%)
⏰ Urgence : ${topConsultant.matchDetails.urgence?.score || 0}pts (${topConsultant.matchDetails.urgence?.jours || 0}j)
📍 Géo : ${topConsultant.matchDetails.geographie?.score || 0}pts (${topConsultant.matchDetails.geographie?.distance || 0}km)
📅 Durée : ${topConsultant.matchDetails.duree?.score || 0}pts
✖️ Mult : ${topConsultant.matchDetails.multiplicateur?.valeur || 1}` : ''}
                        >
                          {topConsultant.matchScore}%
                        </div>
                        <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>
                          Meilleur match
                        </div>
                      </div>
                    )}
                  </div>

                  <div style={{ 
                    display: 'flex', 
                    gap: '12px',
                    paddingTop: '16px',
                    borderTop: '1px solid var(--border-subtle)',
                    fontSize: '12px',
                    color: 'var(--text-muted)'
                  }}>
                    <span>👤 {opp.contact} ({opp.contactPoste})</span>
                    <span>📅 Créée le {new Date(opp.dateCreation).toLocaleDateString('fr-FR')}</span>
                    <span>🎯 {matched.length} consultant{matched.length > 1 ? 's' : ''} matché{matched.length > 1 ? 's' : ''}</span>
                  </div>
                </div>
              );
            })}
          </div>

          {filteredOpps.length === 0 && (
            <div className="empty-state">
              <div className="empty-state-icon">🔍</div>
              <p>Aucune opportunité avec ces critères</p>
            </div>
          )}

          {selectedOpp && (
            <div className="modal-overlay" onClick={() => setSelectedOpp(null)}>
              <div className="modal-content large" onClick={(e) => e.stopPropagation()}>
                <button 
                  className="modal-close"
                  onClick={() => setSelectedOpp(null)}
                >
                  ✕
                </button>

                <h2 style={{ fontSize: '24px', fontWeight: 700, marginBottom: '8px' }}>
                  {selectedOpp.titre}
                </h2>
                <p style={{ fontSize: '16px', color: 'var(--text-secondary)', marginBottom: '16px' }}>
                  {selectedOpp.client}
                </p>
                
                <div style={{ 
                  display: 'flex', 
                  gap: '16px', 
                  marginBottom: '24px',
                  fontSize: '13px',
                  color: 'var(--text-secondary)',
                  flexWrap: 'wrap'
                }}>
                  <span>👤 {selectedOpp.contact} • {selectedOpp.contactPoste}</span>
                  <span>📧 {selectedOpp.contactEmail}</span>
                  <span>💰 TJM {selectedOpp.tjmPropose}€</span>
                  {selectedOpp.ville && <span>📍 {selectedOpp.ville}</span>}
                  {selectedOpp.dureeMois && <span>⏱️ {selectedOpp.dureeMois} mois</span>}
                  <span>📅 {new Date(selectedOpp.dateCreation).toLocaleDateString('fr-FR')}</span>
                  {selectedOpp.probabilite && (
                    <span style={{ 
                      background: selectedOpp.probabilite === 'negociation' ? 'rgba(76, 209, 55, 0.15)' :
                                  selectedOpp.probabilite === 'chaude' ? 'rgba(255, 159, 10, 0.15)' :
                                  'rgba(100, 181, 246, 0.15)',
                      color: selectedOpp.probabilite === 'negociation' ? 'var(--status-ok)' :
                             selectedOpp.probabilite === 'chaude' ? 'var(--status-warning)' :
                             'var(--accent-cyan)',
                      padding: '3px 10px',
                      borderRadius: '4px',
                      fontSize: '11px',
                      fontWeight: 600
                    }}>
                      {selectedOpp.probabilite === 'negociation' ? '🔥 Négo' :
                       selectedOpp.probabilite === 'chaude' ? '🌡️ Chaude' :
                       '🆕 Nouvelle'}
                    </span>
                  )}
                  <span 
                    style={{ 
                      color: getStatutColor(selectedOpp.statut),
                      fontWeight: 600
                    }}
                  >
                    {getStatutLabel(selectedOpp.statut)}
                  </span>
                </div>

                <div style={{ marginBottom: '32px' }}>
                  <h3 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '12px' }}>
                    📋 Description
                  </h3>
                  <p style={{ fontSize: '14px', lineHeight: '1.7', color: 'var(--text-secondary)' }}>
                    {selectedOpp.description}
                  </p>
                  <div style={{ marginTop: '12px', display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                    {selectedOpp.competencesRequises.map((comp, idx) => (
                      <span key={idx} className="tag" style={{ fontSize: '13px' }}>
                        {comp}
                      </span>
                    ))}
                  </div>
                </div>


                <div>
                  <h3 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '16px' }}>
                    {selectedOpp.statut === 'gagnee' ? '✅ Consultant placé' : `👥 Consultants matchés (${getMatchedConsultantsWithScores(selectedOpp).length})`}
                  </h3>
                  
                  <div style={{ display: 'grid', gap: '12px' }}>
                    {getMatchedConsultantsWithScores(selectedOpp).map((consultant) => (
                      <div 
                        key={consultant.id}
                        className="card clickable"
                        onClick={() => {
                          setSelectedOpp(null);
                          onSelectConsultant(consultant);
                        }}
                        style={{ 
                          padding: '16px',
                          display: 'grid',
                          gridTemplateColumns: 'auto 1fr auto',
                          gap: '16px',
                          alignItems: 'center',
                          background: consultant.isPlaced ? 'rgba(76, 209, 55, 0.08)' : undefined,
                          border: consultant.isPlaced ? '1px solid rgba(76, 209, 55, 0.3)' : undefined
                        }}
                      >
                        <div 
                          style={{ 
                            fontSize: '20px', 
                            fontWeight: 700,
                            fontFamily: 'var(--font-mono)',
                            color: consultant.matchScore >= 80 ? 'var(--status-ok)' : 'var(--accent-cyan)',
                            minWidth: '60px',
                            textAlign: 'center',
                            cursor: 'help',
                            position: 'relative',
                            padding: '8px',
                            borderRadius: 'var(--radius-sm)',
                            transition: 'all 0.2s ease'
                          }}
                          onMouseEnter={(e) => e.currentTarget.style.background = 'var(--bg-tertiary)'}
                          onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                          title={consultant.matchDetails ? `Détail du score :
🎯 Compétences : ${consultant.matchDetails.competences?.score || 0}pts (${consultant.matchDetails.competences?.ratio || 0}% match)
💰 Marge : ${consultant.matchDetails.marge?.score || 0}pts (${consultant.matchDetails.marge?.pct || 0}%)
⏰ Urgence : ${consultant.matchDetails.urgence?.score || 0}pts (${consultant.matchDetails.urgence?.jours || 0}j)
📍 Géographie : ${consultant.matchDetails.geographie?.score || 0}pts (${consultant.matchDetails.geographie?.distance || 0}km)
📅 Durée : ${consultant.matchDetails.duree?.score || 0}pts (${consultant.matchDetails.duree?.mois || 0}m)
✖️ Multiplicateur : ${consultant.matchDetails.multiplicateur?.valeur || 1}` : ''}
                        >
                          {consultant.isPlaced ? '✓' : `${consultant.matchScore}%`}
                        </div>
                        
                        <div>
                          <div style={{ fontWeight: 600, marginBottom: '4px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                            {consultant.prenom} {consultant.nom}
                            {consultant.isPlaced && (
                              <span style={{ 
                                background: 'var(--status-ok)', 
                                color: 'white', 
                                padding: '2px 8px', 
                                borderRadius: '4px', 
                                fontSize: '11px', 
                                fontWeight: '600' 
                              }}>
                                PLACÉ
                              </span>
                            )}
                          </div>
                          <div style={{ fontSize: '12px', color: 'var(--text-secondary)', display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap' }}>
                            <span>{consultant.email} • TJM {consultant.tjm}€</span>
                            {consultant.ville && (
                              <span style={{ display: 'flex', alignItems: 'center', gap: '4px' }}>
                                📍 {consultant.ville}
                                {consultant.mobilite && (
                                  <span style={{ 
                                    background: 'rgba(76, 209, 55, 0.15)',
                                    color: 'var(--status-ok)',
                                    padding: '1px 6px',
                                    borderRadius: '3px',
                                    fontSize: '10px',
                                    fontWeight: 600
                                  }}>
                                    Mobile
                                  </span>
                                )}
                              </span>
                            )}
                            {!consultant.isPlaced && <span>• {consultant.joursIntercontrat}j intercontrat</span>}
                          </div>
                          <div style={{ display: 'flex', gap: '6px', marginTop: '6px', flexWrap: 'wrap' }}>
                            {consultant.competences.slice(0, 3).map(comp => (
                              <span key={comp} className="tag" style={{ fontSize: '11px' }}>
                                {comp}
                              </span>
                            ))}
                          </div>
                        </div>

                        <button className="btn btn-sm btn-primary">
                          Voir profil
                        </button>
                      </div>
                    ))}
                  </div>
                </div>
              </div>
            </div>
          )}
        </div>
      );
    }

    // ============================================
    // MODALE CONFIRMATION ENVOI
    // ============================================

    function ConfirmSendModal({ data, onConfirm, onCancel }) {
      if (!data) return null;
      
      const { opp, step, stepLabel, message, type, consultant } = data;
      
      const getSubject = () => {
        if (step === 'j0') return `Profil ${consultant.prenom} ${consultant.nom} - ${opp.titre}`;
        if (step === 'j3') return `Relance - Profil ${consultant.prenom} ${consultant.nom}`;
        if (step === 'j7') return `Message LinkedIn - ${consultant.prenom} ${consultant.nom}`;
        return 'Message';
      };
      
      return (
        <div className="modal-overlay" onClick={onCancel}>
          <div className="modal-card" style={{ maxWidth: '700px', maxHeight: '90vh', overflow: 'auto' }} onClick={e => e.stopPropagation()}>
            <div className="modal-header">
              <h2 style={{ fontSize: '18px', fontWeight: 600 }}>Confirmation d'envoi - {stepLabel}</h2>
              <button className="modal-close" onClick={onCancel}>×</button>
            </div>
            
            <div className="modal-body">
              <div style={{ 
                marginBottom: '20px',
                padding: '16px',
                background: 'var(--bg-secondary)',
                borderRadius: 'var(--radius-sm)'
              }}>
                <div style={{ fontSize: '13px', marginBottom: '8px', display: 'flex', gap: '8px' }}>
                  <strong style={{ minWidth: '100px' }}>Destinataire :</strong>
                  <span style={{ color: 'var(--text-secondary)' }}>{opp.contact} ({opp.contactEmail})</span>
                </div>
                <div style={{ fontSize: '13px', display: 'flex', gap: '8px' }}>
                  <strong style={{ minWidth: '100px' }}>Sujet :</strong>
                  <span style={{ color: 'var(--text-secondary)' }}>{getSubject()}</span>
                </div>
              </div>
              
              <div style={{ marginBottom: '20px' }}>
                <div style={{ fontWeight: 600, marginBottom: '8px', fontSize: '14px', color: 'var(--text-primary)' }}>
                  📝 Message à envoyer :
                </div>
                <textarea 
                  readOnly
                  value={message}
                  style={{
                    width: '100%',
                    minHeight: '320px',
                    padding: '16px',
                    border: '1px solid var(--border-subtle)',
                    borderRadius: 'var(--radius-sm)',
                    fontFamily: 'var(--font-base)',
                    fontSize: '13px',
                    lineHeight: '1.7',
                    resize: 'vertical',
                    background: 'var(--bg-tertiary)',
                    color: 'var(--text-primary)'
                  }}
                />
              </div>
              
              <div style={{
                padding: '14px 16px',
                background: 'rgba(0, 212, 255, 0.1)',
                borderLeft: '3px solid var(--accent-cyan)',
                borderRadius: 'var(--radius-sm)',
                fontSize: '13px',
                color: 'var(--text-secondary)',
                lineHeight: '1.6'
              }}>
                <strong style={{ color: 'var(--accent-cyan)' }}>ℹ️ Que va-t-il se passer ?</strong><br/>
                • Le message sera copié dans votre presse-papier<br/>
                {step !== 'j7' && '• Votre client email s\'ouvrira automatiquement avec le message pré-rempli'}
                {step === 'j7' && '• Ouvrez LinkedIn pour envoyer le message'}
                <br/>
                • L'envoi sera automatiquement tracé dans l'historique
              </div>
            </div>
            
            <div className="modal-footer" style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
              <button className="btn btn-secondary" onClick={onCancel}>
                Annuler
              </button>
              <button className="btn btn-primary" onClick={onConfirm}>
                {step === 'j7' ? '📋 Copier message' : '📧 Copier & Ouvrir email'}
              </button>
            </div>
          </div>
        </div>
      );
    }

    // ============================================
    // CONSULTANT DETAIL
    // ============================================

    function ConsultantDetail({ consultant, onBack, actionHistory = [], opportunities = mockOpportunites, onUpdateOpportunity, onAddAction }) {
      // Gérer les messages par opportunité
      const [messages, setMessages] = useState({});
      const [isGenerating, setIsGenerating] = useState(false);
      const [isSending, setIsSending] = useState(false);
      const [toast, setToast] = useState(null);
      const [selectedOpp, setSelectedOpp] = useState(null);
      const [confirmAction, setConfirmAction] = useState(null);
      const [messageType, setMessageType] = useState('email');
      const [confirmSendModal, setConfirmSendModal] = useState(null); // Modale confirmation envoi
      
      // Protection spam click
      const [sendingJ0, setSendingJ0] = useState({});
      const [sendingJ3, setSendingJ3] = useState({});
      const [sendingJ7, setSendingJ7] = useState({});

      // Générateur de message EMAIL (formel, structuré)
      const generateEmailMessage = (opp, step) => {
        const isRelance = step === 'j3';
        
        if (isRelance) {
          return `Objet : Relance - Profil ${consultant.prenom} ${consultant.nom} pour ${opp.titre}

Bonjour ${opp.contact},

Je me permets de revenir vers vous concernant le profil de ${consultant.prenom} ${consultant.nom} que je vous ai présenté il y a quelques jours.

Avez-vous eu l'occasion d'examiner son CV ? Seriez-vous disponible pour un échange rapide cette semaine ?

Pour rappel :
• ${consultant.anneesExperience} ans d'expérience en ${consultant.competences[0]}
• Compétences : ${consultant.competences.slice(0, 4).join(', ')}
• TJM : ${consultant.tjm}€
• Disponibilité : Immédiate

Je reste à votre disposition pour toute question.`;
        }
        
        return `Objet : Profil ${consultant.prenom} ${consultant.nom} pour ${opp.titre}

Bonjour ${opp.contact},

Je me permets de vous contacter concernant ${opp.description}.

Je souhaitais vous présenter le profil de ${consultant.prenom} ${consultant.nom}, ${consultant.competences[0]} avec ${consultant.anneesExperience} ans d'expérience dans le domaine.

Compétences clés :
${consultant.competences.map(c => `• ${c}`).join('\n')}

Points forts pour votre projet :
• Expertise technique alignée sur vos besoins
• ${consultant.anneesExperience} ans d'expérience opérationnelle
• Disponibilité immédiate
• TJM : ${consultant.tjm}€

Seriez-vous disponible pour échanger cette semaine sur cette opportunité ?

Je reste à votre disposition pour vous transmettre son CV détaillé et organiser un premier échange.`;
      };

      // Générateur de message LINKEDIN (conversationnel, court)
      const generateLinkedInMessage = (opp) => {
        return `Bonjour ${opp.contact},

Je reviens vers vous concernant ${opp.titre} chez ${opp.client}.

${consultant.prenom} ${consultant.nom}, ${consultant.anneesExperience} ans d'expérience en ${consultant.competences[0]}, pourrait correspondre parfaitement à votre besoin.

Profil clé : ${consultant.competences.slice(0, 3).join(', ')}.

Disponible pour un échange rapide cette semaine ?`;
      };

      // Message par défaut selon type et étape
      const getDefaultMessage = (opp, type = 'email', step = 'j0') => {
        if (type === 'linkedin') {
          return generateLinkedInMessage(opp);
        }
        return generateEmailMessage(opp, step);
      };

      // Récupérer le message d'une opportunité (ou générer par défaut)
      const getMessage = (oppId, type = 'email', step = 'j0') => {
        if (!messages[oppId]) {
          const opp = opportunities.find(o => o.id === oppId);
          return getDefaultMessage(opp, type, step);
        }
        return messages[oppId];
      };

      // Mettre à jour le message d'une opportunité
      const updateMessage = (oppId, newMessage) => {
        setMessages(prev => ({
          ...prev,
          [oppId]: newMessage
        }));
      };

      // Handler confirmation envoi depuis modale
      const handleConfirmSend = () => {
        if (!confirmSendModal) return;
        
        const { opp, step, message } = confirmSendModal;
        const now = new Date().toISOString();
        
        // Protection spam immédiate
        if (step === 'j0') setSendingJ0(prev => ({ ...prev, [opp.id]: true }));
        if (step === 'j3') setSendingJ3(prev => ({ ...prev, [opp.id]: true }));
        if (step === 'j7') setSendingJ7(prev => ({ ...prev, [opp.id]: true }));
        
        // Copier message dans clipboard
        navigator.clipboard.writeText(message);
        
        // Mettre à jour tracking
        if (onUpdateOpportunity) {
          onUpdateOpportunity(opp.id, {
            sequenceTracking: {
              ...opp.sequenceTracking,
              [`${step}_sent`]: true,
              [`${step}_date`]: now.split('T')[0]
            }
          });
        }
        
        // Ajouter à l'historique
        if (onAddAction) {
          const actionTypes = { j0: 'campagne_preparee', j3: 'relance_j3', j7: 'linkedin_j7' };
          onAddAction({
            id: Date.now(),
            type: actionTypes[step],
            consultantId: consultant.id,
            consultantNom: `${consultant.prenom} ${consultant.nom}`,
            opportunites: [{
              id: opp.id,
              client: opp.client,
              message: message
            }],
            date: now
          });
        }
        
        // Ouvrir mailto (sauf LinkedIn)
        if (step !== 'j7') {
          const subject = step === 'j0' 
            ? `Profil ${consultant.prenom} ${consultant.nom} - ${opp.titre}`
            : `Relance - Profil ${consultant.prenom} ${consultant.nom}`;
          const mailto = `mailto:${opp.contactEmail}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(message)}`;
          const link = document.createElement('a');
          link.href = mailto;
          document.body.appendChild(link);
          link.click();
          document.body.removeChild(link);
        }
        
        // Feedback
        setToast(step === 'j7' ? '✓ Message copié ! Ouvrez LinkedIn pour envoyer.' : '✓ Message copié & email ouvert');
        setTimeout(() => setToast(null), 3000);
        
        // Fermer modales
        setConfirmSendModal(null);
        setSelectedOpp(null);
      };

      // Trouver toutes les opportunités qui matchent ce consultant
      const matchedOpportunites = opportunities
        .filter(opp => opp.consultantsMatches.includes(consultant.id))
        .map(opp => {
          const result = calculateMatchScore(consultant, opp);
          return {
            ...opp,
            matchScore: result.score,
            matchDetails: result.details
          };
        })
        .sort((a, b) => b.matchScore - a.matchScore);

      // Toggle une étape de séquence avec création d'événement historique
      const toggleSequenceStep = (oppId, step) => {
        const opp = matchedOpportunites.find(o => o.id === oppId);
        if (!opp) return;
        
        const stepName = step === 'j0' ? 'Email initial (J0)' : 
                        step === 'j3' ? 'Relance email (J+3)' : 
                        'Message LinkedIn (J+7)';
        
        const messageType = step === 'j7' ? 'linkedin' : 'email';
        const isCurrentlyChecked = opp.sequenceTracking[`${step}_sent`];
        
        if (isCurrentlyChecked) {
          // Décocher - supprimer l'événement de l'historique
          opp.sequenceTracking[`${step}_sent`] = false;
          opp.sequenceTracking[`${step}_date`] = null;
          
          // Supprimer l'événement correspondant de l'historique
          const eventIndex = mockHistorique.findIndex(h => 
            h.consultantId === consultant.id && 
            h.details && h.details.includes(stepName)
          );
          if (eventIndex !== -1) {
            mockHistorique.splice(eventIndex, 1);
          }
          
          setToast(`✓ ${stepName} marqué comme non envoyé`);
        } else {
          // Cocher - créer événement historique
          const now = new Date();
          opp.sequenceTracking[`${step}_sent`] = true;
          opp.sequenceTracking[`${step}_date`] = now.toISOString().split('T')[0];
          
          // Créer événement dans historique
          const newEvent = {
            id: `hist_${Date.now()}_${Math.random().toString(36).substr(2, 9)}`,
            date: now.toISOString().split('T')[0],
            heure: now.toLocaleTimeString('fr-FR', { hour: '2-digit', minute: '2-digit' }),
            type: messageType,
            consultant: `${consultant.prenom} ${consultant.nom}`,
            consultantId: consultant.id,
            action: step === 'j0' ? 'Email envoyé' : 
                    step === 'j3' ? 'Relance email envoyée' :
                    'Message LinkedIn envoyé',
            cible: `${opp.contact} (${opp.client})`,
            statut: 'envoye',
            details: `${stepName} pour opportunité ${opp.titre}`
          };
          
          mockHistorique.unshift(newEvent);
          setToast(`✓ ${stepName} marqué comme envoyé`);
        }
        
        // Force re-render
        setSelectedOpp({...opp});
        setConfirmAction(null);
        setTimeout(() => setToast(null), 3000);
      };

      const isLegacyProfile = consultant.statut === 'intercontrat' && consultant.opportunitesMatchees === 0;
      const isEnMission = consultant.statut === 'en_mission';

      return (
        <div className="main-content">
          <div className="detail-container">
            <div className="back-button" onClick={onBack}>
              <Icons.ArrowLeft /> Consultants
            </div>

            <div className="consultant-header">
              <div className="consultant-avatar">
                {consultant.prenom[0]}{consultant.nom[0]}
              </div>
              <div className="consultant-info">
                <h1>{consultant.prenom} {consultant.nom}</h1>
                <div className="consultant-meta">
                  {consultant.competences[0]} • {consultant.email} • TJM cible : {consultant.tjm}€
                  {consultant.ville && (
                    <>
                      {' • 📍 '}{consultant.ville}
                      {consultant.mobilite && (
                        <span style={{ 
                          marginLeft: '6px',
                          background: 'rgba(76, 209, 55, 0.15)',
                          color: 'var(--status-ok)',
                          padding: '2px 8px',
                          borderRadius: '4px',
                          fontSize: '11px',
                          fontWeight: 600
                        }}>
                          Mobile
                        </span>
                      )}
                    </>
                  )}
                </div>
                <div className="consultant-tags">
                  {consultant.competences.map(c => (
                    <span key={c} className="tag">{c}</span>
                  ))}
                </div>
              </div>
            </div>

            {isEnMission ? (
              <div className="detail-card full-width" style={{ background: 'rgba(76, 209, 55, 0.1)', border: '1px solid rgba(76, 209, 55, 0.3)' }}>
                <div className="detail-card-header">
                  <div className="detail-card-icon" style={{ background: 'var(--status-ok)' }}>✓</div>
                  <div className="detail-card-title">Mission en cours</div>
                </div>
                <p className="priority-explanation" style={{ marginBottom: '20px' }}>
                  <strong>{consultant.prenom}</strong> {consultant.raisonPriorite}
                </p>
                <div style={{ marginTop: '16px', display: 'grid', gridTemplateColumns: 'repeat(auto-fit, minmax(200px, 1fr))', gap: '16px' }}>
                  <div>
                    <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '4px' }}>Client</div>
                    <div style={{ fontSize: '16px', fontWeight: 600 }}>{consultant.clientActuel}</div>
                  </div>
                  <div>
                    <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '4px' }}>Mission</div>
                    <div style={{ fontSize: '14px' }}>{consultant.missionActuelle}</div>
                  </div>
                  <div>
                    <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '4px' }}>Placement</div>
                    <div style={{ fontSize: '14px' }}>{new Date(consultant.datePlacement).toLocaleDateString('fr-FR')}</div>
                  </div>
                  <div>
                    <div style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '4px' }}>TJM</div>
                    <div style={{ fontSize: '16px', fontWeight: 600, color: 'var(--status-ok)' }}>{consultant.tjm}€</div>
                  </div>
                </div>
              </div>
            ) : (
              <>
                <div className="detail-grid">
                  <div className={`detail-card ${consultant.rang === 1 ? 'highlight' : ''}`}>
                    <div className="detail-card-header">
                      <div className="detail-card-icon priority">🏆</div>
                      <div className="detail-card-title">Priorité #{consultant.rang} cette semaine</div>
                    </div>
                    <p className="priority-explanation">
                      <strong>{consultant.prenom}</strong> {consultant.raisonPriorite}
                    </p>
                  </div>

                  <div className="detail-card">
                    <div className="detail-card-header">
                      <div className="detail-card-icon action">📊</div>
                      <div className="detail-card-title">Métriques</div>
                    </div>
                    <div className="priority-stats" style={{ justifyContent: 'flex-start', gap: '32px' }}>
                      <div className="stat">
                        <div className="stat-value cost">{consultant.coutCumule.toLocaleString()}€</div>
                        <div className="stat-label">Coût cumulé</div>
                      </div>
                      <div className="stat">
                        <div className="stat-value days">{consultant.joursIntercontrat}j</div>
                        <div className="stat-label">En intercontrat</div>
                      </div>
                      <div className="stat">
                        <div className="stat-value opps">{matchedOpportunites.length}</div>
                        <div className="stat-label">Opportunités</div>
                      </div>
                    </div>
                  </div>
                </div>

                {matchedOpportunites.length > 0 && (
                  <div className="detail-card full-width">
                    <div className="detail-card-header">
                      <div className="detail-card-icon action">💼</div>
                      <div className="detail-card-title">Opportunités matchées ({matchedOpportunites.length})</div>
                    </div>
                    <div style={{ display: 'grid', gap: '12px', marginTop: '16px' }}>
                      {matchedOpportunites.map(opp => (
                        <div 
                          key={opp.id}
                          className="card clickable"
                          style={{ 
                            padding: '12px 16px',
                            display: 'grid',
                            gridTemplateColumns: '1fr auto auto',
                            gap: '16px',
                            alignItems: 'center'
                          }}
                          onClick={() => setSelectedOpp(opp)}
                        >
                          <div>
                            <div style={{ fontWeight: 600, marginBottom: '4px', display: 'flex', alignItems: 'center', gap: '8px', flexWrap: 'wrap' }}>
                              {opp.client}
                              <span 
                                style={{ 
                                  fontSize: '11px',
                                  padding: '2px 6px',
                                  borderRadius: '3px',
                                  background: opp.statut === 'nouvelle' ? 'rgba(0, 180, 216, 0.2)' : 
                                              opp.statut === 'en_cours' ? 'rgba(247, 154, 62, 0.2)' : 
                                              'rgba(140, 140, 140, 0.2)',
                                  color: opp.statut === 'nouvelle' ? 'var(--accent-cyan)' : 
                                         opp.statut === 'en_cours' ? 'var(--status-warning)' : 
                                         'var(--text-muted)'
                                }}
                              >
                                {opp.statut === 'nouvelle' ? 'Nouvelle' : opp.statut === 'en_cours' ? 'En cours' : opp.statut}
                              </span>
                              {opp.sequenceStatus && (
                                <span 
                                  style={{ 
                                    fontSize: '11px',
                                    padding: '2px 6px',
                                    borderRadius: '3px',
                                    background: opp.sequenceStatus === 'non_lancee' ? 'rgba(140, 140, 140, 0.15)' :
                                                opp.sequenceStatus === 'j0' ? 'rgba(76, 209, 55, 0.2)' :
                                                opp.sequenceStatus === 'j3' ? 'rgba(76, 209, 55, 0.25)' :
                                                opp.sequenceStatus === 'j7' ? 'rgba(247, 154, 62, 0.2)' :
                                                'rgba(140, 140, 140, 0.2)',
                                    color: opp.sequenceStatus === 'non_lancee' ? 'var(--text-muted)' :
                                           opp.sequenceStatus === 'j0' ? 'var(--status-ok)' :
                                           opp.sequenceStatus === 'j3' ? 'var(--status-ok)' :
                                           opp.sequenceStatus === 'j7' ? 'var(--status-warning)' :
                                           'var(--text-muted)',
                                    fontWeight: 600
                                  }}
                                >
                                  {opp.sequenceStatus === 'non_lancee' ? '⚪ Non lancée' :
                                   opp.sequenceStatus === 'j0' ? '🟢 Séq. J+0' :
                                   opp.sequenceStatus === 'j3' ? '🟢 Séq. J+3' :
                                   opp.sequenceStatus === 'j7' ? '🟡 Relance J+7' :
                                   '✓ Terminée'}
                                </span>
                              )}
                            </div>
                            <div style={{ fontSize: '12px', color: 'var(--text-secondary)' }}>
                              {opp.titre} • TJM {opp.tjmPropose}€
                            </div>
                          </div>
                          <div 
                            style={{ 
                              fontSize: '16px', 
                              fontWeight: 700,
                              fontFamily: 'var(--font-mono)',
                              color: opp.matchScore >= 80 ? 'var(--status-ok)' : 'var(--accent-cyan)',
                              cursor: 'help',
                              padding: '4px 8px',
                              borderRadius: 'var(--radius-sm)',
                              transition: 'all 0.2s ease'
                            }}
                            onMouseEnter={(e) => e.currentTarget.style.background = 'var(--bg-tertiary)'}
                            onMouseLeave={(e) => e.currentTarget.style.background = 'transparent'}
                            title={opp.matchDetails ? `Détail du match :
🎯 Compétences : ${opp.matchDetails.competences?.score || 0}pts
💰 Marge : ${opp.matchDetails.marge?.score || 0}pts (${opp.matchDetails.marge?.pct || 0}%)
⏰ Urgence : ${opp.matchDetails.urgence?.score || 0}pts (${opp.matchDetails.urgence?.jours || 0}j)
📍 Géo : ${opp.matchDetails.geographie?.score || 0}pts (${opp.matchDetails.geographie?.distance || 0}km)
📅 Durée : ${opp.matchDetails.duree?.score || 0}pts
✖️ Mult : ${opp.matchDetails.multiplicateur?.valeur || 1}` : ''}
                          >
                            {opp.matchScore}%
                          </div>
                          <button 
                            className="btn btn-sm btn-ghost"
                            onClick={(e) => {
                              e.stopPropagation();
                              setSelectedOpp(opp);
                            }}
                            style={{ fontSize: '16px' }}
                          >
                            🔍
                          </button>
                        </div>
                      ))}
                    </div>
                  </div>
                )}
              </>
            )}

            {!isEnMission && isLegacyProfile && (
                  <div className="detail-card escalade-card full-width">
                    <div className="detail-card-header">
                      <div className="detail-card-icon warning"><Icons.AlertTriangle /></div>
                      <div className="detail-card-title">Escalade RH recommandée</div>
                    </div>
                    <div className="escalade-content">
                      <p className="escalade-message">
                        <strong>{consultant.prenom}</strong> a un profil {consultant.competences[0]} qui ne correspond plus 
                        à la cible Data/IA de Synchrone. Aucune opportunité interne n'est actuellement disponible.
                      </p>
                      <p className="escalade-message">
                        <strong>Recommandation :</strong> Transmettre le dossier aux RH pour évaluer les options 
                        (formation reconversion, mobilité interne, ou accompagnement sortie).
                      </p>
                      <div className="escalade-options">
                        <button className="btn btn-primary"><Icons.Send /> Escalader aux RH</button>
                        <button className="btn btn-secondary">Explorer formations Data</button>
                      </div>
                    </div>
                  </div>
            )}

            {/* Historique actions automatiques */}
            {!isEnMission && (
              <div className="detail-card full-width">
                <div className="detail-card-header">
                  <div className="detail-card-icon action">📝</div>
                  <div className="detail-card-title">Historique des actions</div>
                </div>
                <div style={{ display: 'flex', flexDirection: 'column', gap: '12px', marginTop: '16px' }}>
                  {/* Filtrer actionHistory pour ce consultant */}
                  {actionHistory
                    .filter(action => action.consultantId === consultant.id)
                    .slice(0, 10) // Limiter aux 10 dernières
                    .map((action, idx) => {
                      const formatDate = (dateStr) => {
                        const date = new Date(dateStr);
                        return date.toLocaleDateString('fr-FR', { day: '2-digit', month: '2-digit', year: 'numeric' });
                      };

                      const getIcon = (type) => {
                        if (type === 'campagne_preparee') return '📋';
                        if (type === 'relance_j3') return '🔄';
                        if (type === 'linkedin_j7') return '💼';
                        if (type === 'email') return '📧';
                        if (type === 'relance') return '🔄';
                        if (type === 'linkedin') return '💼';
                        return '📌';
                      };

                      const getTitle = (action) => {
                        if (action.type === 'campagne_preparee') {
                          return `Messages préparés - ${action.opportunites?.length || 0} opportunités`;
                        }
                        if (action.type === 'relance_j3') {
                          return `Relance J+3 envoyée`;
                        }
                        if (action.type === 'linkedin_j7') {
                          return `Message LinkedIn J+7 envoyé`;
                        }
                        return action.title || 'Action';
                      };

                      const getDetails = (action) => {
                        if (action.type === 'campagne_preparee' || action.type === 'relance_j3' || action.type === 'linkedin_j7') {
                          return action.opportunites?.map(o => o.client).join(', ') || 'N/A';
                        }
                        return action.details || '';
                      };

                      return (
                        <div 
                          key={action.id || idx}
                          style={{ 
                            display: 'flex', 
                            gap: '16px',
                            padding: '12px',
                            background: 'var(--bg-tertiary)',
                            borderRadius: 'var(--radius-sm)'
                          }}
                        >
                          <div style={{ fontSize: '24px' }}>{getIcon(action.type)}</div>
                          <div style={{ flex: 1 }}>
                            <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '4px' }}>
                              <div style={{ fontWeight: 600, fontSize: '14px' }}>
                                {getTitle(action)}
                              </div>
                              <div style={{ fontSize: '12px', color: 'var(--text-muted)' }}>
                                {formatDate(action.date)}
                              </div>
                            </div>
                            <div style={{ fontSize: '13px', color: 'var(--text-secondary)' }}>
                              {getDetails(action)}
                              <span style={{ 
                                marginLeft: '8px',
                                padding: '2px 6px',
                                borderRadius: '3px',
                                background: 'rgba(0, 212, 255, 0.15)',
                                color: 'var(--accent-cyan)',
                                fontSize: '11px',
                                fontWeight: 600
                              }}>
                                ✨ Tracé automatiquement
                              </span>
                            </div>
                          </div>
                        </div>
                      );
                    })}
                  
                  {/* Message si aucune action */}
                  {actionHistory.filter(a => a.consultantId === consultant.id).length === 0 && (
                    <div style={{ 
                      padding: '24px', 
                      textAlign: 'center', 
                      color: 'var(--text-muted)',
                      fontSize: '14px'
                    }}>
                      Aucune action enregistrée pour ce consultant
                    </div>
                  )}
                </div>
              </div>
            )}
          </div>

          {selectedOpp && (
            <div className="modal-overlay" onClick={() => setSelectedOpp(null)}>
              <div className="modal-content large" onClick={(e) => e.stopPropagation()}>
                <button className="modal-close" onClick={() => setSelectedOpp(null)}>✕</button>

                <h2 style={{ fontSize: '24px', fontWeight: 700, marginBottom: '8px' }}>
                  {selectedOpp.client}
                </h2>
                
                <div style={{ 
                  display: 'flex', 
                  gap: '16px', 
                  marginBottom: '24px',
                  fontSize: '13px',
                  color: 'var(--text-secondary)',
                  flexWrap: 'wrap'
                }}>
                  <span>👤 {selectedOpp.contact} • {selectedOpp.contactPoste}</span>
                  <span>📧 {selectedOpp.contactEmail}</span>
                  <span>💰 TJM {selectedOpp.tjmPropose}€</span>
                  {selectedOpp.ville && <span>📍 {selectedOpp.ville}</span>}
                  <span>📅 Démarrage : {selectedOpp.demarrage}</span>
                  <span>⏱️ Durée : {selectedOpp.duree}</span>
                </div>

                <div style={{ marginBottom: '32px' }}>
                  <h3 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '12px' }}>
                    📋 Description
                  </h3>
                  <p style={{ fontSize: '14px', lineHeight: '1.7', color: 'var(--text-secondary)' }}>
                    {selectedOpp.description}
                  </p>
                  <div style={{ marginTop: '12px', display: 'flex', gap: '8px', flexWrap: 'wrap' }}>
                    {selectedOpp.competencesRequises.map((comp, idx) => (
                      <span key={idx} className="tag" style={{ fontSize: '13px' }}>
                        {comp}
                      </span>
                    ))}
                  </div>
                </div>

                <div style={{ 
                  background: 'rgba(0, 180, 216, 0.1)',
                  border: '1px solid rgba(0, 180, 216, 0.3)',
                  borderRadius: 'var(--radius-sm)',
                  padding: '16px',
                  marginBottom: '32px'
                }}>
                  <div style={{ fontSize: '14px', fontWeight: 600, color: 'var(--accent-cyan)', marginBottom: '6px' }}>
                    🎯 Match avec {consultant.prenom}
                  </div>
                  <div style={{ fontSize: '24px', fontWeight: 700, fontFamily: 'var(--font-mono)', color: 'var(--accent-cyan)' }}>
                    {selectedOpp.matchScore}%
                  </div>
                </div>

                <div style={{ marginBottom: '32px' }}>
                  <h3 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '8px' }}>
                    📊 Suivi de la séquence
                  </h3>
                  <p style={{ fontSize: '13px', color: 'var(--text-secondary)', marginBottom: '12px' }}>
                    Messages préparés depuis le dashboard. Copiez-les pour envoyer depuis votre boîte mail.
                  </p>
                  <div style={{ 
                    display: 'flex', 
                    gap: '16px',
                    padding: '20px',
                    background: 'var(--bg-tertiary)',
                    borderRadius: 'var(--radius-md)',
                    marginBottom: '16px'
                  }}>
                    {/* J0 */}
                    <div style={{ flex: 1, textAlign: 'center' }}>
                      <div style={{ 
                        width: '48px',
                        height: '48px',
                        margin: '0 auto 12px',
                        borderRadius: '50%',
                        background: selectedOpp.sequenceTracking?.j0_sent ? 'var(--status-ok)' : 'var(--bg-secondary)',
                        border: `2px solid ${selectedOpp.sequenceTracking?.j0_sent ? 'var(--status-ok)' : 'var(--border-subtle)'}`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '20px'
                      }}>
                        {selectedOpp.sequenceTracking?.j0_sent ? '✓' : '📧'}
                      </div>
                      <div style={{ fontWeight: 600, marginBottom: '4px', color: selectedOpp.sequenceTracking?.j0_sent ? 'var(--status-ok)' : 'var(--text-secondary)' }}>
                        J0 - Email initial
                      </div>
                      {selectedOpp.sequenceTracking?.j0_date && (
                        <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '8px' }}>
                          {new Date(selectedOpp.sequenceTracking.j0_date).toLocaleDateString('fr-FR')}
                        </div>
                      )}
                      {!selectedOpp.sequenceTracking?.j0_sent && (
                        <div style={{ 
                          fontSize: '11px', 
                          color: 'var(--text-muted)', 
                          marginBottom: '8px',
                          fontStyle: 'italic',
                          padding: '6px',
                          background: 'var(--bg-secondary)',
                          borderRadius: '4px'
                        }}>
                          "Bonjour {selectedOpp.contact}, j'ai le profil de {consultant.prenom}..."
                        </div>
                      )}
                      <button 
                        className="btn btn-sm btn-primary" 
                        onClick={() => {
                          const message = getMessage(selectedOpp.id, 'email', 'j0');
                          setConfirmSendModal({
                            opp: selectedOpp,
                            step: 'j0',
                            stepLabel: 'J0 - Email initial',
                            message: message,
                            type: 'email',
                            consultant: consultant
                          });
                        }}
                        disabled={selectedOpp.sequenceTracking?.j0_sent || sendingJ0[selectedOpp.id]}
                        style={{ 
                          fontSize: '12px',
                          opacity: (selectedOpp.sequenceTracking?.j0_sent || sendingJ0[selectedOpp.id]) ? 0.6 : 1,
                          cursor: (selectedOpp.sequenceTracking?.j0_sent || sendingJ0[selectedOpp.id]) ? 'not-allowed' : 'pointer'
                        }}
                      >
                        {selectedOpp.sequenceTracking?.j0_sent 
                          ? `✓ Envoyé le ${new Date(selectedOpp.sequenceTracking.j0_date).toLocaleDateString('fr-FR')}`
                          : sendingJ0[selectedOpp.id]
                            ? '⏳ Envoi...'
                            : '📝 Préparer & Envoyer'
                        }
                      </button>
                    </div>

                    {/* J3 */}
                    <div style={{ flex: 1, textAlign: 'center' }}>
                      <div style={{ 
                        width: '48px',
                        height: '48px',
                        margin: '0 auto 12px',
                        borderRadius: '50%',
                        background: selectedOpp.sequenceTracking?.j3_sent ? 'var(--status-warning)' : 'var(--bg-secondary)',
                        border: `2px solid ${selectedOpp.sequenceTracking?.j3_sent ? 'var(--status-warning)' : 'var(--border-subtle)'}`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '20px'
                      }}>
                        {selectedOpp.sequenceTracking?.j3_sent ? '✓' : '🔄'}
                      </div>
                      <div style={{ fontWeight: 600, marginBottom: '4px', color: selectedOpp.sequenceTracking?.j3_sent ? 'var(--status-warning)' : 'var(--text-secondary)' }}>
                        J+3 - Relance
                      </div>
                      {selectedOpp.sequenceTracking?.j3_date && (
                        <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '8px' }}>
                          {new Date(selectedOpp.sequenceTracking.j3_date).toLocaleDateString('fr-FR')}
                        </div>
                      )}
                      {!selectedOpp.sequenceTracking?.j3_sent && selectedOpp.sequenceTracking?.j0_sent && (
                        <div style={{ 
                          fontSize: '11px', 
                          color: 'var(--text-muted)', 
                          marginBottom: '8px',
                          fontStyle: 'italic',
                          padding: '6px',
                          background: 'var(--bg-secondary)',
                          borderRadius: '4px'
                        }}>
                          "Bonjour {selectedOpp.contact}, je reviens vers vous..."
                        </div>
                      )}
                      <button 
                        className="btn btn-sm btn-primary" 
                        onClick={() => {
                          const message = getMessage(selectedOpp.id, 'email', 'j3');
                          setConfirmSendModal({
                            opp: selectedOpp,
                            step: 'j3',
                            stepLabel: 'J+3 - Relance email',
                            message: message,
                            type: 'email',
                            consultant: consultant
                          });
                        }}
                        disabled={selectedOpp.sequenceTracking?.j3_sent || sendingJ3[selectedOpp.id]}
                        style={{ 
                          fontSize: '12px',
                          opacity: (selectedOpp.sequenceTracking?.j3_sent || sendingJ3[selectedOpp.id]) ? 0.6 : 1,
                          cursor: (selectedOpp.sequenceTracking?.j3_sent || sendingJ3[selectedOpp.id]) ? 'not-allowed' : 'pointer'
                        }}
                      >
                        {selectedOpp.sequenceTracking?.j3_sent 
                          ? `✓ Envoyé le ${new Date(selectedOpp.sequenceTracking.j3_date).toLocaleDateString('fr-FR')}`
                          : sendingJ3[selectedOpp.id]
                            ? '⏳ Envoi...'
                            : '📝 Préparer & Envoyer'
                        }
                      </button>
                    </div>

                    {/* J7 */}
                    <div style={{ flex: 1, textAlign: 'center' }}>
                      <div style={{ 
                        width: '48px',
                        height: '48px',
                        margin: '0 auto 12px',
                        borderRadius: '50%',
                        background: selectedOpp.sequenceTracking?.j7_sent ? 'var(--accent-cyan)' : 'var(--bg-secondary)',
                        border: `2px solid ${selectedOpp.sequenceTracking?.j7_sent ? 'var(--accent-cyan)' : 'var(--border-subtle)'}`,
                        display: 'flex',
                        alignItems: 'center',
                        justifyContent: 'center',
                        fontSize: '20px'
                      }}>
                        {selectedOpp.sequenceTracking?.j7_sent ? '✓' : '💼'}
                      </div>
                      <div style={{ fontWeight: 600, marginBottom: '4px', color: selectedOpp.sequenceTracking?.j7_sent ? 'var(--accent-cyan)' : 'var(--text-secondary)' }}>
                        J+7 - LinkedIn
                      </div>
                      {selectedOpp.sequenceTracking?.j7_date && (
                        <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '8px' }}>
                          {new Date(selectedOpp.sequenceTracking.j7_date).toLocaleDateString('fr-FR')}
                        </div>
                      )}
                      {!selectedOpp.sequenceTracking?.j7_sent && selectedOpp.sequenceTracking?.j3_sent && (
                        <div style={{ 
                          fontSize: '11px', 
                          color: 'var(--text-muted)', 
                          marginBottom: '8px',
                          fontStyle: 'italic',
                          padding: '6px',
                          background: 'var(--bg-secondary)',
                          borderRadius: '4px'
                        }}>
                          "Bonjour {selectedOpp.contact}, approche LinkedIn..."
                        </div>
                      )}
                      <button 
                        className="btn btn-sm btn-primary" 
                        onClick={() => {
                          const message = getMessage(selectedOpp.id, 'linkedin', 'j7');
                          setConfirmSendModal({
                            opp: selectedOpp,
                            step: 'j7',
                            stepLabel: 'J+7 - Message LinkedIn',
                            message: message,
                            type: 'linkedin',
                            consultant: consultant
                          });
                        }}
                        disabled={selectedOpp.sequenceTracking?.j7_sent || sendingJ7[selectedOpp.id]}
                        style={{ 
                          fontSize: '12px',
                          opacity: (selectedOpp.sequenceTracking?.j7_sent || sendingJ7[selectedOpp.id]) ? 0.6 : 1,
                          cursor: (selectedOpp.sequenceTracking?.j7_sent || sendingJ7[selectedOpp.id]) ? 'not-allowed' : 'pointer'
                        }}
                      >
                        {selectedOpp.sequenceTracking?.j7_sent 
                          ? `✓ Envoyé le ${new Date(selectedOpp.sequenceTracking.j7_date).toLocaleDateString('fr-FR')}`
                          : sendingJ7[selectedOpp.id]
                            ? '⏳ Envoi...'
                            : '📝 Préparer message'
                        }
                      </button>
                    </div>
                  </div>
                </div>

                {/* Section Tracking Réponse */}
                <div style={{ marginBottom: '24px', padding: '20px', background: 'var(--bg-tertiary)', borderRadius: 'var(--radius-sm)', border: '1px solid var(--border)' }}>
                  <h3 style={{ fontSize: '16px', fontWeight: 600, marginBottom: '16px', display: 'flex', alignItems: 'center', gap: '8px' }}>
                    📊 Suivi réponse client
                  </h3>
                  
                  <div style={{ display: 'flex', alignItems: 'center', gap: '12px', marginBottom: '16px' }}>
                    <input 
                      type="checkbox" 
                      checked={selectedOpp.responseTracking?.received || false}
                      onChange={(e) => {
                        selectedOpp.responseTracking.received = e.target.checked;
                        if (e.target.checked) {
                          selectedOpp.responseTracking.responseDate = new Date().toISOString().split('T')[0];
                        } else {
                          selectedOpp.responseTracking.responseDate = null;
                          selectedOpp.responseTracking.responseType = null;
                          selectedOpp.responseTracking.responseChannel = null;
                          selectedOpp.responseTracking.notes = '';
                        }
                        setSelectedOpp({...selectedOpp});
                      }}
                      style={{ width: '18px', height: '18px', cursor: 'pointer', accentColor: 'var(--status-ok)' }}
                    />
                    <label style={{ fontSize: '14px', fontWeight: 500, cursor: 'pointer' }}>
                      Client a répondu
                    </label>
                  </div>

                  {selectedOpp.responseTracking?.received && (
                    <div style={{ paddingLeft: '30px', display: 'flex', flexDirection: 'column', gap: '16px' }}>
                      <div style={{ display: 'grid', gridTemplateColumns: '1fr 1fr', gap: '12px' }}>
                        <div>
                          <label style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '6px', display: 'block' }}>
                            Type de réponse
                          </label>
                          <select
                            value={selectedOpp.responseTracking.responseType || ''}
                            onChange={(e) => {
                              selectedOpp.responseTracking.responseType = e.target.value;
                              setSelectedOpp({...selectedOpp});
                            }}
                            style={{
                              width: '100%',
                              padding: '8px 12px',
                              fontSize: '14px',
                              border: '1px solid var(--border)',
                              borderRadius: '6px',
                              background: 'var(--bg-secondary)',
                              color: 'var(--text-primary)'
                            }}
                          >
                            <option value="">Sélectionner...</option>
                            <option value="positive">✅ Positive (intéressé)</option>
                            <option value="negative">❌ Négative (pas intéressé)</option>
                            <option value="information">💬 Demande d'information</option>
                          </select>
                        </div>

                        <div>
                          <label style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '6px', display: 'block' }}>
                            Canal de réponse
                          </label>
                          <select
                            value={selectedOpp.responseTracking.responseChannel || ''}
                            onChange={(e) => {
                              selectedOpp.responseTracking.responseChannel = e.target.value;
                              setSelectedOpp({...selectedOpp});
                            }}
                            style={{
                              width: '100%',
                              padding: '8px 12px',
                              fontSize: '14px',
                              border: '1px solid var(--border)',
                              borderRadius: '6px',
                              background: 'var(--bg-secondary)',
                              color: 'var(--text-primary)'
                            }}
                          >
                            <option value="">Sélectionner...</option>
                            <option value="email">📧 Email</option>
                            <option value="linkedin">💼 LinkedIn</option>
                            <option value="phone">📞 Téléphone</option>
                            <option value="copil">👥 COPIL client</option>
                            <option value="consultant">🤝 Via consultant</option>
                            <option value="autre">💬 Autre</option>
                          </select>
                        </div>
                      </div>

                      <div>
                        <label style={{ fontSize: '13px', color: 'var(--text-muted)', marginBottom: '6px', display: 'block' }}>
                          Notes complémentaires
                        </label>
                        <textarea
                          value={selectedOpp.responseTracking.notes || ''}
                          onChange={(e) => {
                            selectedOpp.responseTracking.notes = e.target.value;
                            setSelectedOpp({...selectedOpp});
                          }}
                          placeholder="Ex: Client intéressé, demande CV détaillé..."
                          style={{
                            width: '100%',
                            minHeight: '80px',
                            padding: '10px',
                            fontSize: '14px',
                            border: '1px solid var(--border)',
                            borderRadius: '6px',
                            background: 'var(--bg-secondary)',
                            color: 'var(--text-primary)',
                            resize: 'vertical',
                            fontFamily: 'inherit'
                          }}
                        />
                      </div>

                      <div style={{ fontSize: '13px', color: 'var(--text-muted)', display: 'flex', alignItems: 'center', gap: '6px' }}>
                        📅 Réponse enregistrée le {new Date(selectedOpp.responseTracking.responseDate).toLocaleDateString('fr-FR', { day: 'numeric', month: 'long', year: 'numeric' })}
                      </div>
                    </div>
                  )}
                </div>

                <div className="message-editor" style={{ marginBottom: '24px' }}>
                  <div className="message-header" style={{ marginBottom: '12px' }}>
                    <span className="message-label">Message personnalisé</span>
                    <div style={{ display: 'flex', gap: '8px', alignItems: 'center' }}>
                      <select 
                        value={messageType}
                        onChange={(e) => {
                          setMessageType(e.target.value);
                          const step = e.target.value === 'linkedin' ? 'j7' : 'j0';
                          updateMessage(selectedOpp.id, getDefaultMessage(selectedOpp, e.target.value, step));
                        }}
                        style={{ 
                          padding: '4px 8px', 
                          fontSize: '13px',
                          border: '1px solid var(--border)',
                          borderRadius: '6px',
                          background: 'var(--bg-secondary)',
                          color: 'var(--text-primary)'
                        }}
                      >
                        <option value="email">📧 Email</option>
                        <option value="linkedin">💼 LinkedIn</option>
                      </select>
                      <button 
                        className="btn btn-ghost" 
                        onClick={() => {
                          setIsGenerating(true);
                          setTimeout(() => {
                            const step = messageType === 'linkedin' ? 'j7' : 'j0';
                            updateMessage(selectedOpp.id, getDefaultMessage(selectedOpp, messageType, step));
                            setIsGenerating(false);
                          }, 800);
                        }} 
                        disabled={isGenerating}
                      >
                        {isGenerating ? <><span className="loading-spinner"></span> Génération...</> : <><Icons.Refresh /> Régénérer</>}
                      </button>
                    </div>
                  </div>
                  <textarea
                    className="message-textarea"
                    value={getMessage(selectedOpp.id, messageType)}
                    onChange={(e) => updateMessage(selectedOpp.id, e.target.value)}
                    placeholder="Message personnalisé..."
                    style={{ minHeight: messageType === 'email' ? '300px' : '180px' }}
                  />
                </div>

                <div className="detail-actions" style={{ marginTop: '24px' }}>
                  <button 
                    className="btn btn-primary" 
                    onClick={() => {
                      setIsSending(true);
                      setTimeout(() => {
                        setIsSending(false);
                        setToast(`Campagne lancée pour ${selectedOpp.client} !`);
                        setTimeout(() => setToast(null), 3000);
                        setSelectedOpp(null);
                      }, 1500);
                    }} 
                    disabled={isSending}
                  >
                    {isSending ? <><span className="loading-spinner"></span> Envoi...</> : <><Icons.Send /> Lancer la campagne</>}
                  </button>
                  <button className="btn btn-secondary">✏️ Modifier la séquence</button>
                  <button className="btn btn-ghost" onClick={() => setSelectedOpp(null)}>Annuler</button>
                </div>
              </div>
            </div>
          )}

          {confirmAction && (
            <div className="modal-overlay" onClick={() => setConfirmAction(null)}>
              <div className="modal-content" onClick={(e) => e.stopPropagation()} style={{ maxWidth: '500px' }}>
                <button className="modal-close" onClick={() => setConfirmAction(null)}>✕</button>
                
                <h3 style={{ fontSize: '20px', fontWeight: 700, marginBottom: '16px' }}>
                  {confirmAction.isChecked ? '⚠️ Annuler l\'envoi' : '✓ Confirmer l\'envoi'}
                </h3>
                
                {confirmAction.isChecked ? (
                  <>
                    <p style={{ marginBottom: '24px', color: 'var(--text-secondary)' }}>
                      Voulez-vous vraiment marquer <strong>{confirmAction.stepName}</strong> comme non envoyé pour <strong>{selectedOpp?.client}</strong> ?
                    </p>
                    <p style={{ marginBottom: '24px', fontSize: '13px', color: 'var(--text-muted)' }}>
                      ⚠️ L'événement sera supprimé de l'historique.
                    </p>
                  </>
                ) : (
                  <>
                    <p style={{ marginBottom: '24px', color: 'var(--text-secondary)' }}>
                      Avez-vous bien envoyé <strong>{confirmAction.stepName}</strong> à <strong>{selectedOpp?.contact}</strong> ({selectedOpp?.client}) ?
                    </p>
                    <p style={{ marginBottom: '24px', fontSize: '13px', color: 'var(--text-muted)' }}>
                      ✓ Un événement sera créé dans l'historique avec la date et l'heure actuelles.
                    </p>
                  </>
                )}
                
                <div style={{ display: 'flex', gap: '12px', justifyContent: 'flex-end' }}>
                  <button 
                    className="btn btn-ghost" 
                    onClick={() => setConfirmAction(null)}
                  >
                    Annuler
                  </button>
                  <button 
                    className={confirmAction.isChecked ? 'btn btn-secondary' : 'btn btn-primary'}
                    onClick={() => toggleSequenceStep(confirmAction.oppId, confirmAction.step)}
                  >
                    {confirmAction.isChecked ? '✓ Oui, marquer comme non envoyé' : '✓ Oui, j\'ai envoyé'}
                  </button>
                </div>
              </div>
            </div>
          )}

          {confirmSendModal && (
            <ConfirmSendModal
              data={confirmSendModal}
              onConfirm={handleConfirmSend}
              onCancel={() => setConfirmSendModal(null)}
            />
          )}

          {toast && (
            <div className="toast">
              <span className="toast-icon">✓</span>
              <span className="toast-message">{toast}</span>
            </div>
          )}
        </div>
      );
    }

    function ConfigPage() {
      const [config, setConfig] = useState(getScoringConfig());
      const [toast, setToast] = useState(null);
      const [showExample, setShowExample] = useState(true);

      // Exemple concret pour montrer l'impact
      const exampleConsultant = {
        prenom: 'Karim', nom: 'Benali',
        competences: ['Data Engineer', 'Python', 'Spark', 'AWS'],
        tjm: 550, tjmCout: 632, ville: 'Lyon', mobilite: true,
        joursIntercontrat: 15, anneesExperience: 8
      };
      const exampleOpp = {
        client: 'Dalkia',
        titre: 'Data Engineer - Migration Cloud',
        competencesRequises: ['Data Engineer', 'Python', 'Spark', 'AWS'],
        tjmPropose: 580, ville: 'Paris', dureeMois: 6,
        dateDebutSouhaitee: '2026-02-15', probabilite: 'chaude'
      };

      // Calculer score exemple avec config actuelle
      const exampleResult = calculateMatchScore(exampleConsultant, exampleOpp, config);

      const handleSave = () => {
        saveScoringConfig(config);
        setToast('✅ Configuration sauvegardée');
        setTimeout(() => setToast(null), 3000);
      };

      const handleReset = () => {
        setConfig(defaultScoringConfig);
        saveScoringConfig(defaultScoringConfig);
        setToast('🔄 Configuration réinitialisée');
        setTimeout(() => setToast(null), 3000);
      };

      const updateWeight = (critere, value) => {
        setConfig(prev => ({
          ...prev,
          [critere]: { ...prev[critere], weight: parseInt(value) }
        }));
      };

      const total = config.competences.weight + config.marge.weight + config.urgence.weight + config.geographie.weight + config.duree.weight;

      return (
        <div className="main-content">
          <header className="page-header">
            <h1 className="page-title">⚙️ Configuration Scoring</h1>
            <p className="page-subtitle">
              Ajustez les critères de matching consultant-opportunité
            </p>
          </header>

          {toast && (
            <div style={{
              position: 'fixed', top: '20px', right: '20px',
              background: 'var(--status-ok)', color: 'white',
              padding: '16px 24px', borderRadius: 'var(--radius-md)',
              boxShadow: '0 4px 12px rgba(0,0,0,0.15)',
              zIndex: 9999, fontWeight: 500
            }}>
              {toast}
            </div>
          )}

          <div className="roi-grid" style={{ gridTemplateColumns: '1.2fr 0.8fr' }}>
            {/* COLONNE GAUCHE : SLIDERS */}
            <div className="roi-card">
              <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '24px' }}>
                <div className="roi-card-title" style={{ margin: 0 }}>⚖️ Poids des critères</div>
                <div style={{ 
                  padding: '8px 16px', 
                  background: total === 100 ? 'var(--status-ok)' : 'var(--status-warning)',
                  color: 'white',
                  borderRadius: 'var(--radius-sm)',
                  fontWeight: 600,
                  fontSize: '14px'
                }}>
                  Total : {total}%
                </div>
              </div>
              
              {total !== 100 && (
                <div style={{ 
                  background: 'rgba(255, 159, 10, 0.1)', 
                  border: '1px solid var(--status-warning)',
                  color: 'var(--status-warning)', 
                  padding: '12px', 
                  borderRadius: 'var(--radius-sm)',
                  marginBottom: '24px',
                  fontSize: '13px',
                  display: 'flex',
                  alignItems: 'center',
                  gap: '8px'
                }}>
                  <span style={{ fontSize: '18px' }}>⚠️</span>
                  <span>Le total doit faire 100% pour un scoring équilibré</span>
                </div>
              )}

              {/* COMPÉTENCES */}
              <div style={{ marginBottom: '32px' }}>
                <div className="slider-label" style={{ marginBottom: '8px' }}>
                  <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <span style={{ fontSize: '20px' }}>🎯</span>
                    <span style={{ fontWeight: 600 }}>Compétences</span>
                  </span>
                  <span className="slider-value" style={{ fontSize: '18px', fontWeight: 700 }}>
                    {config.competences.weight}%
                  </span>
                </div>
                <input 
                  type="range" 
                  min="0" max="50" step="5"
                  value={config.competences.weight}
                  onChange={(e) => updateWeight('competences', e.target.value)}
                  className="slider"
                  style={{ marginBottom: '8px' }}
                />
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  fontSize: '11px',
                  color: 'var(--text-muted)',
                  marginBottom: '6px'
                }}>
                  <span>0%</span>
                  <span>25%</span>
                  <span>50%</span>
                </div>
                <p style={{ fontSize: '12px', color: 'var(--text-muted)', lineHeight: '1.5' }}>
                  Match entre compétences consultant et compétences requises. 
                  <strong style={{ color: 'var(--text-primary)' }}> Critère clé</strong> pour éviter les profils inadaptés.
                </p>
              </div>

              {/* MARGE */}
              <div style={{ marginBottom: '32px' }}>
                <div className="slider-label" style={{ marginBottom: '8px' }}>
                  <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <span style={{ fontSize: '20px' }}>💰</span>
                    <span style={{ fontWeight: 600 }}>Marge / Rentabilité</span>
                  </span>
                  <span className="slider-value" style={{ fontSize: '18px', fontWeight: 700 }}>
                    {config.marge.weight}%
                  </span>
                </div>
                <input 
                  type="range" 
                  min="0" max="50" step="5"
                  value={config.marge.weight}
                  onChange={(e) => updateWeight('marge', e.target.value)}
                  className="slider"
                  style={{ marginBottom: '8px' }}
                />
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  fontSize: '11px',
                  color: 'var(--text-muted)',
                  marginBottom: '6px'
                }}>
                  <span>0%</span>
                  <span>25%</span>
                  <span>50%</span>
                </div>
                <p style={{ fontSize: '12px', color: 'var(--text-muted)', lineHeight: '1.5' }}>
                  Écart entre TJM client et TJM coût. 
                  <strong style={{ color: 'var(--status-error)' }}> Marge négative = disqualification</strong> automatique.
                </p>
              </div>

              {/* URGENCE */}
              <div style={{ marginBottom: '32px' }}>
                <div className="slider-label" style={{ marginBottom: '8px' }}>
                  <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <span style={{ fontSize: '20px' }}>⏰</span>
                    <span style={{ fontWeight: 600 }}>Urgence Intercontrat</span>
                  </span>
                  <span className="slider-value" style={{ fontSize: '18px', fontWeight: 700 }}>
                    {config.urgence.weight}%
                  </span>
                </div>
                <input 
                  type="range" 
                  min="0" max="50" step="5"
                  value={config.urgence.weight}
                  onChange={(e) => updateWeight('urgence', e.target.value)}
                  className="slider"
                  style={{ marginBottom: '8px' }}
                />
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  fontSize: '11px',
                  color: 'var(--text-muted)',
                  marginBottom: '6px'
                }}>
                  <span>0%</span>
                  <span>25%</span>
                  <span>50%</span>
                </div>
                <p style={{ fontSize: '12px', color: 'var(--text-muted)', lineHeight: '1.5' }}>
                  Durée intercontrat × séniorité consultant. 
                  <strong style={{ color: 'var(--text-primary)' }}> Senior 90j+ = urgence maximale.</strong>
                </p>
              </div>

              {/* GÉOGRAPHIE */}
              <div style={{ marginBottom: '32px' }}>
                <div className="slider-label" style={{ marginBottom: '8px' }}>
                  <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <span style={{ fontSize: '20px' }}>📍</span>
                    <span style={{ fontWeight: 600 }}>Géographie</span>
                  </span>
                  <span className="slider-value" style={{ fontSize: '18px', fontWeight: 700 }}>
                    {config.geographie.weight}%
                  </span>
                </div>
                <input 
                  type="range" 
                  min="0" max="30" step="5"
                  value={config.geographie.weight}
                  onChange={(e) => updateWeight('geographie', e.target.value)}
                  className="slider"
                  style={{ marginBottom: '8px' }}
                />
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  fontSize: '11px',
                  color: 'var(--text-muted)',
                  marginBottom: '6px'
                }}>
                  <span>0%</span>
                  <span>15%</span>
                  <span>30%</span>
                </div>
                <p style={{ fontSize: '12px', color: 'var(--text-muted)', lineHeight: '1.5' }}>
                  Distance consultant-mission. Bonus si mobilité acceptée. 
                  <strong style={{ color: 'var(--text-primary)' }}> Lyon→Paris = friction réelle.</strong>
                </p>
              </div>

              {/* DURÉE */}
              <div style={{ marginBottom: '32px' }}>
                <div className="slider-label" style={{ marginBottom: '8px' }}>
                  <span style={{ display: 'flex', alignItems: 'center', gap: '8px' }}>
                    <span style={{ fontSize: '20px' }}>📅</span>
                    <span style={{ fontWeight: 600 }}>Durée Mission</span>
                  </span>
                  <span className="slider-value" style={{ fontSize: '18px', fontWeight: 700 }}>
                    {config.duree.weight}%
                  </span>
                </div>
                <input 
                  type="range" 
                  min="0" max="30" step="5"
                  value={config.duree.weight}
                  onChange={(e) => updateWeight('duree', e.target.value)}
                  className="slider"
                  style={{ marginBottom: '8px' }}
                />
                <div style={{ 
                  display: 'flex', 
                  justifyContent: 'space-between',
                  fontSize: '11px',
                  color: 'var(--text-muted)',
                  marginBottom: '6px'
                }}>
                  <span>0%</span>
                  <span>15%</span>
                  <span>30%</span>
                </div>
                <p style={{ fontSize: '12px', color: 'var(--text-muted)', lineHeight: '1.5' }}>
                  Missions longues = stabilité consultants + rentabilité. 
                  <strong style={{ color: 'var(--text-primary)' }}> 12+ mois = optimal.</strong>
                </p>
              </div>

              <div style={{ display: 'flex', gap: '12px', marginTop: '40px' }}>
                <button 
                  className="btn-primary"
                  onClick={handleSave}
                  style={{ flex: 1 }}
                >
                  💾 Sauvegarder
                </button>
                <button 
                  className="btn-secondary"
                  onClick={handleReset}
                  style={{ flex: 1 }}
                >
                  🔄 Réinitialiser
                </button>
              </div>
            </div>

            {/* COLONNE DROITE : EXEMPLE TEMPS RÉEL */}
            <div>
              <div className="roi-card" style={{ marginBottom: '16px' }}>
                <div style={{ display: 'flex', justifyContent: 'space-between', alignItems: 'center', marginBottom: '16px' }}>
                  <div className="roi-card-title" style={{ margin: 0 }}>📊 Impact en temps réel</div>
                  <button 
                    className="btn-secondary"
                    onClick={() => setShowExample(!showExample)}
                    style={{ padding: '6px 12px', fontSize: '12px' }}
                  >
                    {showExample ? '👁️ Masquer' : '👁️ Afficher'}
                  </button>
                </div>

                {showExample && (
                  <>
                    <div style={{ 
                      background: 'var(--bg-tertiary)', 
                      padding: '16px', 
                      borderRadius: 'var(--radius-sm)',
                      marginBottom: '16px'
                    }}>
                      <div style={{ fontSize: '12px', color: 'var(--text-muted)', marginBottom: '8px' }}>
                        Exemple : Karim Benali (Lyon) → Dalkia Paris
                      </div>
                      <div style={{ 
                        fontSize: '48px', 
                        fontWeight: 700,
                        fontFamily: 'var(--font-mono)',
                        color: exampleResult.score >= 70 ? 'var(--status-ok)' : 
                               exampleResult.score >= 50 ? 'var(--status-warning)' : 'var(--status-error)',
                        textAlign: 'center',
                        marginBottom: '8px'
                      }}>
                        {exampleResult.score}%
                      </div>
                      <div style={{ textAlign: 'center', fontSize: '11px', color: 'var(--text-muted)' }}>
                        Score avec configuration actuelle
                      </div>
                    </div>

                    <div style={{ fontSize: '12px' }}>
                      <div style={{ marginBottom: '12px', paddingBottom: '12px', borderBottom: '1px solid var(--border-subtle)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <span style={{ color: 'var(--text-muted)' }}>🎯 Compétences (4/4)</span>
                          <strong>{exampleResult.details.competences?.score || 0}/{config.competences.weight}</strong>
                        </div>
                        <div style={{ 
                          height: '4px', 
                          background: 'var(--bg-tertiary)', 
                          borderRadius: '2px',
                          overflow: 'hidden'
                        }}>
                          <div style={{ 
                            width: `${((exampleResult.details.competences?.score || 0) / config.competences.weight) * 100}%`,
                            height: '100%',
                            background: 'var(--status-ok)'
                          }} />
                        </div>
                      </div>

                      <div style={{ marginBottom: '12px', paddingBottom: '12px', borderBottom: '1px solid var(--border-subtle)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <span style={{ color: 'var(--text-muted)' }}>💰 Marge ({exampleResult.details.marge?.pct || 0}%)</span>
                          <strong>{exampleResult.details.marge?.score || 0}/{config.marge.weight}</strong>
                        </div>
                        <div style={{ 
                          height: '4px', 
                          background: 'var(--bg-tertiary)', 
                          borderRadius: '2px',
                          overflow: 'hidden'
                        }}>
                          <div style={{ 
                            width: `${((exampleResult.details.marge?.score || 0) / config.marge.weight) * 100}%`,
                            height: '100%',
                            background: (exampleResult.details.marge?.pct || 0) < 0 ? 'var(--status-error)' : 'var(--status-warning)'
                          }} />
                        </div>
                      </div>

                      <div style={{ marginBottom: '12px', paddingBottom: '12px', borderBottom: '1px solid var(--border-subtle)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <span style={{ color: 'var(--text-muted)' }}>⏰ Urgence ({exampleResult.details.urgence?.jours || 0}j)</span>
                          <strong>{exampleResult.details.urgence?.score || 0}/{config.urgence.weight}</strong>
                        </div>
                        <div style={{ 
                          height: '4px', 
                          background: 'var(--bg-tertiary)', 
                          borderRadius: '2px',
                          overflow: 'hidden'
                        }}>
                          <div style={{ 
                            width: `${((exampleResult.details.urgence?.score || 0) / config.urgence.weight) * 100}%`,
                            height: '100%',
                            background: 'var(--accent-cyan)'
                          }} />
                        </div>
                      </div>

                      <div style={{ marginBottom: '12px', paddingBottom: '12px', borderBottom: '1px solid var(--border-subtle)' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <span style={{ color: 'var(--text-muted)' }}>📍 Géo ({exampleResult.details.geographie?.distance || 0}km)</span>
                          <strong>{exampleResult.details.geographie?.score || 0}/{config.geographie.weight}</strong>
                        </div>
                        <div style={{ 
                          height: '4px', 
                          background: 'var(--bg-tertiary)', 
                          borderRadius: '2px',
                          overflow: 'hidden'
                        }}>
                          <div style={{ 
                            width: `${((exampleResult.details.geographie?.score || 0) / config.geographie.weight) * 100}%`,
                            height: '100%',
                            background: 'var(--accent-purple)'
                          }} />
                        </div>
                      </div>

                      <div style={{ marginBottom: '12px' }}>
                        <div style={{ display: 'flex', justifyContent: 'space-between', marginBottom: '4px' }}>
                          <span style={{ color: 'var(--text-muted)' }}>📅 Durée ({exampleResult.details.duree?.mois || 0}m)</span>
                          <strong>{exampleResult.details.duree?.score || 0}/{config.duree.weight}</strong>
                        </div>
                        <div style={{ 
                          height: '4px', 
                          background: 'var(--bg-tertiary)', 
                          borderRadius: '2px',
                          overflow: 'hidden'
                        }}>
                          <div style={{ 
                            width: `${((exampleResult.details.duree?.score || 0) / config.duree.weight) * 100}%`,
                            height: '100%',
                            background: 'var(--status-ok)'
                          }} />
                        </div>
                      </div>

                      <div style={{ 
                        marginTop: '16px', 
                        paddingTop: '16px', 
                        borderTop: '1px solid var(--border-subtle)',
                        fontSize: '11px',
                        color: 'var(--text-muted)'
                      }}>
                        × Multiplicateur : {exampleResult.details.multiplicateur?.valeur || 1} 
                        <span style={{ marginLeft: '4px' }}>
                          ({exampleResult.details.multiplicateur?.probabilite || 'nouvelle'})
                        </span>
                      </div>
                    </div>
                  </>
                )}
              </div>

              <div className="roi-card">
                <div className="roi-card-title">💡 Recommandations</div>
                <div style={{ fontSize: '13px', color: 'var(--text-muted)', lineHeight: '1.7' }}>
                  <p style={{ marginBottom: '12px' }}>
                    <strong style={{ color: 'var(--text-primary)' }}>Configuration ESN optimale :</strong>
                  </p>
                  <ul style={{ paddingLeft: '20px', margin: 0, listStyle: 'none' }}>
                    <li style={{ marginBottom: '6px' }}>🎯 Compétences : <strong>30%</strong></li>
                    <li style={{ marginBottom: '6px' }}>💰 Marge : <strong>25%</strong></li>
                    <li style={{ marginBottom: '6px' }}>⏰ Urgence : <strong>20%</strong></li>
                    <li style={{ marginBottom: '6px' }}>📍 Géographie : <strong>15%</strong></li>
                    <li style={{ marginBottom: '6px' }}>📅 Durée : <strong>10%</strong></li>
                  </ul>
                </div>
              </div>
            </div>
          </div>
        </div>
      );
    }
    function HistoriquePage({ onSelectConsultant, actionHistory = [] }) {
      const [filterType, setFilterType] = useState('all');
      const [filterConsultant, setFilterConsultant] = useState('all');

      // Convertir actionHistory en format compatible avec l'affichage
      const formattedHistory = actionHistory.map(action => {
        let type = action.type;
        let details = action.details || '';
        
        if (action.type === 'campagne_preparee') {
          type = 'email';
          details = `Messages préparés pour ${action.opportunites?.length || 0} opportunités`;
        } else if (action.type === 'relance_j3') {
          type = 'relance';
          details = `Relance J+3 envoyée`;
        } else if (action.type === 'linkedin_j7') {
          type = 'linkedin';
          details = `Message LinkedIn J+7 envoyé`;
        }
        
        return {
          id: action.id,
          date: action.date,
          type: type,
          consultant: action.consultantNom,
          opportunite: action.opportunites?.map(o => o.client).join(', ') || 'N/A',
          details: details
        };
      });

      // Fusionner avec mockHistorique pour avoir un historique complet (mock + réel)
      // Pour la démo, on garde aussi le mock pour avoir des données initiales
      const allHistory = actionHistory.length > 0 ? [...formattedHistory, ...mockHistorique.slice(0, 3)] : mockHistorique;

      // Get unique consultant names
      const allConsultantNames = [...new Set(allHistory.map(h => h.consultant))].sort();

      // Filter historique
      let filtered = allHistory.filter(item => {
        const matchType = filterType === 'all' || item.type === filterType;
        const matchConsultant = filterConsultant === 'all' || item.consultant === filterConsultant;
        return matchType && matchConsultant;
      });

      // Calculate stats - NOUVEAU CALCUL TAUX RÉPONSE
      const opportunitesSollicitees = mockOpportunites.filter(o => o.sequenceTracking?.j0_sent).length;
      const opportunitesAvecReponse = mockOpportunites.filter(o => o.responseTracking?.received).length;
      const tauxReponse = opportunitesSollicitees > 0 ? Math.round((opportunitesAvecReponse / opportunitesSollicitees) * 100) : 0;

      const stats = {
        total: allHistory.length,
        placements: allHistory.filter(h => h.type === 'placement').length,
        sollicitees: opportunitesSollicitees,
        reponses: opportunitesAvecReponse,
        tauxReponse: tauxReponse
      };

      // Format date for display
      const formatDate = (dateStr) => {
        const date = new Date(dateStr);
        const today = new Date();
        const yesterday = new Date(today);
        yesterday.setDate(yesterday.getDate() - 1);

        if (date.toDateString() === today.toDateString()) return "Aujourd'hui";
        if (date.toDateString() === yesterday.toDateString()) return "Hier";
        
        const options = { day: 'numeric', month: 'long' };
        return date.toLocaleDateString('fr-FR', options);
      };

      // Get icon for event type
      const getTypeIcon = (type) => {
        switch(type) {
          case 'email': return '📧';
          case 'relance': return '🔄';
          case 'placement': return '✅';
          case 'linkedin': return '💼';
          case 'escalade': return '⚠️';
          default: return '📌';
        }
      };

      return (
        <div className="main-content">
          <header className="page-header">
            <h1 className="page-title">Historique des actions</h1>
            <p className="page-subtitle">
              Suivi des 30 derniers jours • {filtered.length} événement{filtered.length > 1 ? 's' : ''}
            </p>
          </header>

          <div className="history-stats">
            <div className="history-stat-card">
              <div className="history-stat-value info">{stats.total}</div>
              <div className="history-stat-label">Actions totales</div>
            </div>
            <div className="history-stat-card">
              <div className="history-stat-value success">{stats.placements}</div>
              <div className="history-stat-label">Placements réussis</div>
            </div>
            <div className="history-stat-card">
              <div className="history-stat-value info">{stats.sollicitees}</div>
              <div className="history-stat-label">Opportunités sollicitées</div>
            </div>
            <div className="history-stat-card">
              <div className="history-stat-value warning">{stats.tauxReponse}% ({stats.reponses}/{stats.sollicitees})</div>
              <div className="history-stat-label">Taux de réponse</div>
            </div>
          </div>

          <div className="filters-bar" style={{ gridTemplateColumns: '1fr auto auto' }}>
            <div></div>
            <select className="filter-select" value={filterType} onChange={(e) => setFilterType(e.target.value)}>
              <option value="all">Tous les types</option>
              <option value="email">Email</option>
              <option value="relance">Relance</option>
              <option value="placement">Placement</option>
              <option value="linkedin">LinkedIn</option>
              <option value="escalade">Escalade RH</option>
            </select>

            <select className="filter-select" value={filterConsultant} onChange={(e) => setFilterConsultant(e.target.value)}>
              <option value="all">Tous les consultants</option>
              {allConsultantNames.map(name => (
                <option key={name} value={name}>{name}</option>
              ))}
            </select>
          </div>

          <div className="history-timeline">
            {filtered.map(item => (
              <div key={item.id} className={`history-item ${item.type}`}>
                <div className="history-header">
                  <div className="history-date-time">
                    {formatDate(item.date)} • {item.heure}
                  </div>
                  <span className={`history-type-badge ${item.type}`}>
                    {getTypeIcon(item.type)} {item.action}
                  </span>
                </div>
                <div className="history-title">
                  {item.consultant} → {item.cible}
                </div>
                <div className="history-details">
                  {item.details}
                </div>
                {item.type !== 'escalade' && (
                  <div className="history-meta">
                    <span>👤 {item.consultant}</span>
                    <span>🎯 {item.cible}</span>
                    {item.statut === 'succes' && <span style={{ color: 'var(--status-ok)' }}>✓ Placement confirmé</span>}
                    {item.statut === 'reponse' && <span style={{ color: 'var(--status-ok)' }}>✓ Réponse reçue</span>}
                  </div>
                )}
              </div>
            ))}
          </div>

          {filtered.length === 0 && (
            <div className="empty-state">
              <div className="empty-state-icon">🔍</div>
              <p>Aucun événement trouvé avec ces critères</p>
            </div>
          )}
        </div>
      );
    }

    function SynthesePage() {
      // Mock data pour évolution temporelle (3 derniers mois)
      const evolutionData = [
        { month: 'Oct', count: 28 },
        { month: 'Nov', count: 32 },
        { month: 'Déc', count: 29 },
        { month: 'Jan', count: 25 },
      ];

      // Répartition par durée
      const dureeData = [
        { label: '0-15 jours', count: mockConsultants.filter(c => c.joursIntercontrat <= 15).length },
        { label: '16-30 jours', count: mockConsultants.filter(c => c.joursIntercontrat > 15 && c.joursIntercontrat <= 30).length },
        { label: '31-45 jours', count: mockConsultants.filter(c => c.joursIntercontrat > 30 && c.joursIntercontrat <= 45).length },
        { label: '46+ jours', count: mockConsultants.filter(c => c.joursIntercontrat > 45).length },
      ];

      const maxDuree = Math.max(...dureeData.map(d => d.count));

      // Top compétences
      const competencesCount = {};
      mockConsultants.forEach(c => {
        const mainComp = c.competences[0];
        competencesCount[mainComp] = (competencesCount[mainComp] || 0) + 1;
      });

      const topCompetences = Object.entries(competencesCount)
        .sort((a, b) => b[1] - a[1])
        .slice(0, 5)
        .map(([label, count]) => ({ label, count }));

      const maxComp = Math.max(...topCompetences.map(c => c.count));

      // Taux de placement (simulé)
      const placementRate = 75; // 75% de taux de placement

      // KPIs
      const kpis = {
        tempsPlacement: 18, // jours moyens
        tauxSucces: 75, // %
        economiesRealisees: 142000, // € depuis début mois
        objectifEconomies: 200000, // € objectif mensuel
      };

      // Insights
      const insights = [
        {
          type: 'success',
          title: '🎯 Tendance positive',
          description: `Le nombre de consultants en intercontrat a diminué de 12% ce mois-ci grâce à la priorisation intelligente.`
        },
        {
          type: 'warning',
          title: '⚠️ Profils à risque',
          description: `${mockConsultants.filter(c => c.joursIntercontrat > 30).length} consultants dépassent 30 jours d'intercontrat. Action commerciale urgente recommandée.`
        },
        {
          type: 'critical',
          title: '🚨 Escalade RH nécessaire',
          description: `${mockConsultants.filter(c => c.opportunitesMatchees === 0).length} consultants n'ont aucune opportunité matchée. Envisager reconversion ou mobilité.`
        },
        {
          type: 'success',
          title: '💼 Opportunités chaudes',
          description: `${mockConsultants.reduce((sum, c) => sum + c.opportunitesMatchees, 0)} opportunités actives avec matching élevé. Focus sur les profils Data Engineer et ML.`
        },
      ];

      return (
        <div className="main-content">
          <header className="page-header">
            <h1 className="page-title">Synthèse & Analytics</h1>
            <p className="page-subtitle">
              Vue d'ensemble des performances et tendances • Janvier 2026
            </p>
          </header>

          <div className="analytics-grid">
            <div className="chart-card">
              <div className="chart-header">
                <div className="chart-title">Évolution intercontrats</div>
                <div className="chart-period">3 derniers mois</div>
              </div>
              <div className="line-chart">
                {evolutionData.map((data, i) => {
                  const height = (data.count / Math.max(...evolutionData.map(d => d.count))) * 160;
                  return (
                    <div key={i} className="line-bar" style={{ height: `${height}px` }}>
                      <div className="line-bar-value">{data.count}</div>
                      <div className="line-bar-label">{data.month}</div>
                    </div>
                  );
                })}
              </div>
            </div>

            <div className="chart-card">
              <div className="chart-header">
                <div className="chart-title">Taux de placement</div>
                <div className="chart-period">Mois en cours</div>
              </div>
              <div className="gauge-container">
                <div 
                  className="gauge-circle" 
                  style={{ '--gauge-angle': `${(placementRate / 100) * 360}deg` }}
                >
                  <div className="gauge-inner">
                    <div className="gauge-value">{placementRate}%</div>
                    <div className="gauge-label">Placement</div>
                  </div>
                </div>
              </div>
            </div>

            <div className="chart-card">
              <div className="chart-header">
                <div className="chart-title">Répartition par durée</div>
                <div className="chart-period">Situation actuelle</div>
              </div>
              <div className="horizontal-bars">
                {dureeData.map((data, i) => (
                  <div key={i} className="h-bar-item">
                    <div className="h-bar-label">{data.label}</div>
                    <div className="h-bar-container">
                      <div 
                        className="h-bar-fill" 
                        style={{ width: `${(data.count / maxDuree) * 100}%` }}
                      >
                        {data.count}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>

            <div className="chart-card">
              <div className="chart-header">
                <div className="chart-title">Top 5 compétences</div>
                <div className="chart-period">En intercontrat</div>
              </div>
              <div className="horizontal-bars">
                {topCompetences.map((data, i) => (
                  <div key={i} className="h-bar-item">
                    <div className="h-bar-label">{data.label}</div>
                    <div className="h-bar-container">
                      <div 
                        className="h-bar-fill" 
                        style={{ width: `${(data.count / maxComp) * 100}%` }}
                      >
                        {data.count}
                      </div>
                    </div>
                  </div>
                ))}
              </div>
            </div>
          </div>

          <div className="roi-grid">
            <div className="roi-card">
              <div className="roi-card-title">📊 KPI d'efficacité</div>
              <div className="impact-metrics">
                <div className="impact-metric">
                  <div className="impact-metric-value days">{kpis.tempsPlacement}j</div>
                  <div className="impact-metric-label">Temps moyen placement</div>
                </div>
                <div className="impact-metric">
                  <div className="impact-metric-value gain">{kpis.tauxSucces}%</div>
                  <div className="impact-metric-label">Taux de succès</div>
                </div>
                <div className="impact-metric">
                  <div className="impact-metric-value gain">{kpis.economiesRealisees.toLocaleString()}€</div>
                  <div className="impact-metric-label">Économies réalisées</div>
                </div>
                <div className="impact-metric">
                  <div className="impact-metric-value days">
                    {Math.round((kpis.economiesRealisees / kpis.objectifEconomies) * 100)}%
                  </div>
                  <div className="impact-metric-label">Objectif atteint</div>
                </div>
              </div>
            </div>

            <div className="roi-card">
              <div className="roi-card-title">💡 Insights & Recommandations</div>
              <div className="insights-list">
                {insights.map((insight, i) => (
                  <div key={i} className={`insight-item ${insight.type}`}>
                    <div className="insight-title">{insight.title}</div>
                    <div className="insight-description">{insight.description}</div>
                  </div>
                ))}
              </div>
            </div>
          </div>
        </div>
      );
    }

    function ROIPage() {
      // States paramétrables
      const [consultantsBU, setConsultantsBU] = useState(60);
      const [tauxIntercontrat, setTauxIntercontrat] = useState(12);
      const [cjm, setCjm] = useState(400); // Coût Journalier Moyen ESN
      const [tjmClient, setTjmClient] = useState(600); // TJM facturé client
      const [reductionPct, setReductionPct] = useState(25);

      // Périmètre
      const nbIntercontrats = Math.round(consultantsBU * (tauxIntercontrat / 100));
      const prixPipelineFirst = 8990; // Forfait 1 BU (max 60p)

      // Durée moyenne intercontrat (from mock data)
      const intercontrats = mockConsultants.filter(c => c.statut === 'intercontrat');
      const avgDuree = intercontrats.length > 0 
        ? Math.round(intercontrats.reduce((sum, c) => sum + c.joursIntercontrat, 0) / intercontrats.length)
        : 24; // Fallback

      // Économies
      const joursEconomises = Math.round(avgDuree * (reductionPct / 100));
      const joursEconomisesTotal = joursEconomises * nbIntercontrats;

      // COÛT ÉVITÉ (jours non payés en intercontrat)
      const coutEviteMensuel = joursEconomises * cjm * nbIntercontrats;
      const coutEviteAnnuel = coutEviteMensuel * 12;

      // MANQUE À GAGNER ÉVITÉ (TJM client non facturés)
      const manqueGagnerEviteMensuel = joursEconomises * tjmClient * nbIntercontrats;
      const manqueGagnerEviteAnnuel = manqueGagnerEviteMensuel * 12;

      // GAIN TOTAL = Coût évité + Manque à gagner évité
      const gainTotalMensuel = coutEviteMensuel + manqueGagnerEviteMensuel;
      const gainTotalAnnuel = coutEviteAnnuel + manqueGagnerEviteAnnuel;

      // ROI
      const roiMultiplier = Math.round(gainTotalAnnuel / prixPipelineFirst);
      const roiPct = Math.round(((gainTotalAnnuel - prixPipelineFirst) / prixPipelineFirst) * 100);

      return (
        <div className="main-content">
          <header className="page-header">
            <h1 className="page-title">Impact ROI</h1>
            <p className="page-subtitle">
              Calculateur interactif - Ajustez les paramètres selon votre BU
            </p>
          </header>

          {/* Paramètres ajustables */}
          <div className="roi-card" style={{ marginBottom: '24px' }}>
            <div className="roi-card-title">⚙️ Paramètres de votre BU</div>
            
            <div style={{ display: 'grid', gap: '24px' }}>
              {/* Consultants BU */}
              <div className="slider-container">
                <div className="slider-label">
                  <span>Nombre de consultants dans la BU</span>
                  <span className="slider-value">{consultantsBU}</span>
                </div>
                <input 
                  type="range" 
                  min="30" 
                  max="200" 
                  step="10"
                  value={consultantsBU}
                  onChange={(e) => setConsultantsBU(parseInt(e.target.value))}
                  className="slider"
                />
                {consultantsBU > 60 && (
                  <div style={{ fontSize: '11px', color: 'var(--status-warning)', marginTop: '4px' }}>
                    ⚠️ Au-delà de 60 consultants : chiffrage sur-mesure requis (extension multi-BU)
                  </div>
                )}
              </div>

              {/* Taux intercontrat */}
              <div className="slider-container">
                <div className="slider-label">
                  <span>Taux d'intercontrat (%)</span>
                  <span className="slider-value">{tauxIntercontrat}%</span>
                </div>
                <input 
                  type="range" 
                  min="5" 
                  max="25" 
                  step="1"
                  value={tauxIntercontrat}
                  onChange={(e) => setTauxIntercontrat(parseInt(e.target.value))}
                  className="slider"
                />
                <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginTop: '4px' }}>
                  Moyenne Syntec : 12% | Votre BU : <strong>{nbIntercontrats} consultants</strong> en intercontrat
                </div>
              </div>

              {/* CJM (Coût) */}
              <div className="slider-container">
                <div className="slider-label">
                  <span>CJM - Coût Journalier Moyen ESN (€)</span>
                  <span className="slider-value">{cjm}€</span>
                </div>
                <input 
                  type="range" 
                  min="300" 
                  max="700" 
                  step="25"
                  value={cjm}
                  onChange={(e) => setCjm(parseInt(e.target.value))}
                  className="slider"
                />
                <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginTop: '4px' }}>
                  Coût chargé par jour (salaire + charges patronales)
                </div>
              </div>

              {/* TJM Client */}
              <div className="slider-container">
                <div className="slider-label">
                  <span>TJM Client - Taux Journalier Moyen facturé (€)</span>
                  <span className="slider-value">{tjmClient}€</span>
                </div>
                <input 
                  type="range" 
                  min="400" 
                  max="1000" 
                  step="50"
                  value={tjmClient}
                  onChange={(e) => setTjmClient(parseInt(e.target.value))}
                  className="slider"
                />
                <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginTop: '4px' }}>
                  CA non généré pendant l'intercontrat
                </div>
              </div>

              {/* Réduction % */}
              <div className="slider-container">
                <div className="slider-label">
                  <span>Réduction temps d'intercontrat</span>
                  <span className="slider-value">{reductionPct}%</span>
                </div>
                <input 
                  type="range" 
                  min="10" 
                  max="40" 
                  step="5"
                  value={reductionPct}
                  onChange={(e) => setReductionPct(parseInt(e.target.value))}
                  className="slider"
                />
                <div style={{ fontSize: '11px', color: 'var(--text-muted)', marginTop: '4px' }}>
                  Objectif réaliste : 20-30% de réduction
                </div>
              </div>
            </div>
          </div>

          {/* Résultats Impact */}
          <div className="roi-grid">
            <div className="roi-card">
              <div className="roi-card-title">📊 Impact mensuel</div>
              
              <div className="impact-metrics">
                <div className="impact-metric">
                  <div className="impact-metric-value days">{joursEconomises}j</div>
                  <div className="impact-metric-label">Économisés / consultant</div>
                </div>
                <div className="impact-metric">
                  <div className="impact-metric-value days">{joursEconomisesTotal}j</div>
                  <div className="impact-metric-label">Total jours économisés</div>
                </div>
                <div className="impact-metric">
                  <div className="impact-metric-value gain">{coutEviteMensuel.toLocaleString()}€</div>
                  <div className="impact-metric-label">Coût ESN évité</div>
                </div>
                <div className="impact-metric">
                  <div className="impact-metric-value gain">{manqueGagnerEviteMensuel.toLocaleString()}€</div>
                  <div className="impact-metric-label">CA client récupéré</div>
                </div>
              </div>
            </div>

            <div className="roi-card">
              <div className="roi-card-title">📈 Avant / Après</div>
              
              <div className="comparison-bars">
                <div className="bar-item">
                  <div className="bar-label">
                    <span>Sans Pipeline First</span>
                    <span style={{ fontFamily: 'var(--font-mono)', color: 'var(--status-critical)' }}>
                      {avgDuree}j
                    </span>
                  </div>
                  <div className="bar-bg">
                    <div 
                      className="bar-fill before" 
                      style={{ width: '100%' }}
                    >
                      {avgDuree} jours
                    </div>
                  </div>
                </div>

                <div className="bar-item">
                  <div className="bar-label">
                    <span>Avec Pipeline First</span>
                    <span style={{ fontFamily: 'var(--font-mono)', color: 'var(--status-ok)' }}>
                      {avgDuree - joursEconomises}j
                    </span>
                  </div>
                  <div className="bar-bg">
                    <div 
                      className="bar-fill" 
                      style={{ width: `${((avgDuree - joursEconomises) / avgDuree) * 100}%` }}
                    >
                      {avgDuree - joursEconomises} jours
                    </div>
                  </div>
                </div>
              </div>

              <div style={{ 
                marginTop: '32px', 
                padding: '16px', 
                background: 'var(--bg-secondary)', 
                borderRadius: 'var(--radius-sm)',
                fontSize: '13px',
                lineHeight: '1.7',
                color: 'var(--text-secondary)'
              }}>
                <strong style={{ color: 'var(--accent-cyan)' }}>Comment ?</strong><br/>
                • Priorisation intelligente des consultants<br/>
                • Actions ciblées sur opportunités à fort matching<br/>
                • Automatisation des relances et séquences<br/>
                • Escalade RH rapide pour profils non-placables
              </div>
            </div>
          </div>

          {/* ROI Summary */}
          <div className="roi-summary">
            <div className="roi-summary-title">💰 Projection annuelle avec -{reductionPct}% d'intercontrat</div>
            <div className="roi-summary-grid">
              <div className="roi-summary-item">
                <div className="roi-summary-value">{coutEviteAnnuel.toLocaleString()}€</div>
                <div className="roi-summary-label">Coût ESN évité / an</div>
              </div>
              <div className="roi-summary-item">
                <div className="roi-summary-value">{manqueGagnerEviteAnnuel.toLocaleString()}€</div>
                <div className="roi-summary-label">CA client récupéré / an</div>
              </div>
              <div className="roi-summary-item">
                <div className="roi-summary-value gain" style={{ color: 'var(--accent-cyan)', fontWeight: 700 }}>
                  {gainTotalAnnuel.toLocaleString()}€
                </div>
                <div className="roi-summary-label">GAIN TOTAL / an</div>
              </div>
              <div className="roi-summary-item">
                <div className="roi-summary-value">x{roiMultiplier}</div>
                <div className="roi-summary-label">ROI Pipeline First</div>
              </div>
              <div className="roi-summary-item">
                <div className="roi-summary-value">{roiPct > 0 ? '+' : ''}{roiPct.toLocaleString()}%</div>
                <div className="roi-summary-label">Retour sur investissement</div>
              </div>
            </div>
          </div>

          {/* Hypothèses */}
          <div className="roi-card" style={{ marginTop: '24px' }}>
            <div className="roi-card-title">📋 Hypothèses de calcul</div>
            <div style={{ fontSize: '14px', lineHeight: '1.8', color: 'var(--text-secondary)' }}>
              <p style={{ marginBottom: '12px' }}>
                <strong>Périmètre :</strong> BU de {consultantsBU} consultants dont {nbIntercontrats} en intercontrat (taux : {tauxIntercontrat}%).
              </p>
              <p style={{ marginBottom: '12px' }}>
                <strong>Durée moyenne :</strong> {avgDuree} jours d'intercontrat (calculée sur données réelles).
              </p>
              <p style={{ marginBottom: '12px' }}>
                <strong>Coûts :</strong> CJM ESN chargé de {cjm}€/j + TJM client de {tjmClient}€/j.
              </p>
              <p style={{ marginBottom: '12px' }}>
                <strong>Gain total :</strong> Coût évité (charges ESN) + CA récupéré (facturation client).
              </p>
              <p>
                <strong>Prix Pipeline First :</strong> {prixPipelineFirst.toLocaleString()}€ HT/an (forfait 1 BU, max 60 consultants).
                {consultantsBU > 60 && ' Au-delà : extension multi-BU sur devis.'}
              </p>
            </div>
          </div>
        </div>
      );
    }
    function ConsultantsPage({ onSelectConsultant, opportunities = mockOpportunites }) {
      const [search, setSearch] = useState('');
      const [filterCompetence, setFilterCompetence] = useState('all');
      const [filterDuree, setFilterDuree] = useState('all');
      const [filterOpps, setFilterOpps] = useState('all');
      const [sortBy, setSortBy] = useState('rang');

      // Calculer le nombre d'opportunités matchées pour chaque consultant
      const getOpportunitiesCount = (consultantId) => {
        return opportunities.filter(opp => 
          opp.consultantsMatches && opp.consultantsMatches.includes(consultantId)
        ).length;
      };

      // Extract unique competences
      const allCompetences = [...new Set(mockConsultants.flatMap(c => c.competences[0]))].sort();

      // Filter consultants
      let filtered = mockConsultants.filter(c => {
        const oppCount = getOpportunitiesCount(c.id);
        
        const matchSearch = search === '' || 
          c.nom.toLowerCase().includes(search.toLowerCase()) ||
          c.prenom.toLowerCase().includes(search.toLowerCase()) ||
          c.email.toLowerCase().includes(search.toLowerCase()) ||
          c.competences.some(comp => comp.toLowerCase().includes(search.toLowerCase()));
        
        const matchCompetence = filterCompetence === 'all' || c.competences[0] === filterCompetence;
        
        const matchDuree = filterDuree === 'all' ||
          (filterDuree === '0-15' && c.joursIntercontrat <= 15) ||
          (filterDuree === '16-30' && c.joursIntercontrat > 15 && c.joursIntercontrat <= 30) ||
          (filterDuree === '31+' && c.joursIntercontrat > 30);
        
        const matchOpps = filterOpps === 'all' ||
          (filterOpps === '0' && oppCount === 0) ||
          (filterOpps === '1-2' && oppCount >= 1 && oppCount <= 2) ||
          (filterOpps === '3+' && oppCount >= 3);
        
        return matchSearch && matchCompetence && matchDuree && matchOpps;
      });

      // Sort consultants
      filtered.sort((a, b) => {
        switch(sortBy) {
          case 'rang': return a.rang - b.rang;
          case 'nom': return a.nom.localeCompare(b.nom);
          case 'cout': return b.coutCumule - a.coutCumule;
          case 'duree': return b.joursIntercontrat - a.joursIntercontrat;
          case 'opps': return getOpportunitiesCount(b.id) - getOpportunitiesCount(a.id);
          default: return a.rang - b.rang;
        }
      });

      return (
        <div className="main-content">
          <header className="page-header">
            <h1 className="page-title">Tous les consultants</h1>
            <p className="page-subtitle">
              <strong>{filtered.length}</strong> consultant{filtered.length > 1 ? 's' : ''} 
              {search || filterCompetence !== 'all' || filterDuree !== 'all' || filterOpps !== 'all' ? ' (filtré)' : ''} • 
              {mockConsultants.length} total
            </p>
          </header>

          <div className="filters-bar">
            <input 
              type="text"
              className="search-input"
              placeholder="Rechercher par nom, email, compétence..."
              value={search}
              onChange={(e) => setSearch(e.target.value)}
            />
            
            <select className="filter-select" value={filterCompetence} onChange={(e) => setFilterCompetence(e.target.value)}>
              <option value="all">Toutes les compétences</option>
              {allCompetences.map(comp => (
                <option key={comp} value={comp}>{comp}</option>
              ))}
            </select>

            <select className="filter-select" value={filterDuree} onChange={(e) => setFilterDuree(e.target.value)}>
              <option value="all">Toutes durées</option>
              <option value="0-15">0-15 jours</option>
              <option value="16-30">16-30 jours</option>
              <option value="31+">31+ jours</option>
            </select>

            <select className="filter-select" value={filterOpps} onChange={(e) => setFilterOpps(e.target.value)}>
              <option value="all">Toutes opportunités</option>
              <option value="0">0 opportunité</option>
              <option value="1-2">1-2 opportunités</option>
              <option value="3+">3+ opportunités</option>
            </select>
          </div>

          <div className="consultants-table">
            <div className="table-header">
              <div style={{ cursor: 'pointer' }} onClick={() => setSortBy('rang')}>Rang</div>
              <div style={{ cursor: 'pointer' }} onClick={() => setSortBy('nom')}>Nom</div>
              <div>Compétence</div>
              <div style={{ cursor: 'pointer' }} onClick={() => setSortBy('duree')}>Durée</div>
              <div style={{ cursor: 'pointer' }} onClick={() => setSortBy('cout')}>Coût</div>
              <div>TJM</div>
              <div style={{ cursor: 'pointer' }} onClick={() => setSortBy('opps')}>Opps</div>
              <div>Email</div>
            </div>

            {filtered.map(consultant => (
              <div 
                key={consultant.id} 
                className={`table-row ${consultant.rang <= 3 && consultant.statut === 'intercontrat' ? 'top-3' : ''}`}
                onClick={() => onSelectConsultant(consultant)}
              >
                <div className="table-cell-rank">
                  {consultant.statut === 'en_mission' ? (
                    <span style={{ 
                      backgroundColor: 'var(--success)', 
                      color: 'white', 
                      padding: '3px 8px', 
                      borderRadius: '4px', 
                      fontSize: '11px', 
                      fontWeight: '600' 
                    }}>
                      EN MISSION
                    </span>
                  ) : (
                    `#${consultant.rang}`
                  )}
                </div>
                <div className="table-cell-name">{consultant.prenom} {consultant.nom}</div>
                <div className="table-cell-role">{consultant.competences[0]}</div>
                <div className="table-cell-metric days">
                  {consultant.statut === 'en_mission' ? (
                    <span style={{ color: 'var(--success)' }}>✓</span>
                  ) : (
                    `${consultant.joursIntercontrat}j`
                  )}
                </div>
                <div className="table-cell-metric cost">
                  {consultant.statut === 'en_mission' ? (
                    <span style={{ color: 'var(--success)' }}>-</span>
                  ) : (
                    `${consultant.coutCumule.toLocaleString()}€`
                  )}
                </div>
                <div className="table-cell-metric">{consultant.tjm}€</div>
                <div className="table-cell-metric opps">
                  {consultant.statut === 'en_mission' ? (
                    <span style={{ color: 'var(--success)' }}>-</span>
                  ) : (
                    getOpportunitiesCount(consultant.id)
                  )}
                </div>
                <div style={{ fontSize: '13px', color: 'var(--text-muted)' }}>{consultant.email}</div>
              </div>
            ))}
          </div>

          {filtered.length === 0 && (
            <div className="empty-state">
              <div className="empty-state-icon">🔍</div>
              <p>Aucun consultant trouvé avec ces critères</p>
            </div>
          )}
        </div>
      );
    }

    // ============================================
    // MAIN APP
    // ============================================

    function App() {
      const [currentPage, setCurrentPage] = useState('dashboard');
      const [selectedConsultant, setSelectedConsultant] = useState(null);
      const [actionHistory, setActionHistory] = useState([
        {
          id: 1001,
          type: 'campagne_preparee',
          consultantId: '1',
          consultantNom: 'Karim Benali',
          opportunites: [{id: 'opp1', client: 'Dalkia', message: 'Message initial Dalkia'}],
          date: '2026-01-25T09:30:00Z'
        },
        {
          id: 1002,
          type: 'relance_j3',
          consultantId: '1',
          consultantNom: 'Karim Benali',
          opportunites: [{id: 'opp1', client: 'Dalkia', message: 'Relance J+3 Dalkia'}],
          date: '2026-01-28T14:15:00Z'
        },
        {
          id: 1003,
          type: 'campagne_preparee',
          consultantId: '6',
          consultantNom: 'Lisa Nguyen',
          opportunites: [{id: 'opp2', client: 'BNP Paribas', message: 'Message initial BNP'}],
          date: '2026-02-01T11:00:00Z'
        }
      ]); // Historique global des actions (avec données initiales pour démo)
      const [opportunityUpdates, setOpportunityUpdates] = useState({}); // { oppId: { sequenceTracking: {...} } }

      // Merger les mises à jour avec mockOpportunites
      const getMergedOpportunities = () => {
        return mockOpportunites.map(opp => {
          if (opportunityUpdates[opp.id]) {
            return {
              ...opp,
              ...opportunityUpdates[opp.id]
            };
          }
          return opp;
        });
      };

      const handleSelectConsultant = (consultant) => {
        setSelectedConsultant(consultant);
        setCurrentPage('detail');
      };

      const handleBackToConsultants = () => {
        setSelectedConsultant(null);
        setCurrentPage('consultants');
      };

      let pageContent;
      
      if (currentPage === 'detail' && selectedConsultant) {
        pageContent = <ConsultantDetail 
          consultant={selectedConsultant} 
          onBack={handleBackToConsultants} 
          actionHistory={actionHistory}
          opportunities={getMergedOpportunities()}
          onUpdateOpportunity={(oppId, updates) => {
            setOpportunityUpdates(prev => ({
              ...prev,
              [oppId]: {
                ...prev[oppId],
                ...updates
              }
            }));
          }}
          onAddAction={(action) => setActionHistory(prev => [action, ...prev])}
        />;
      } else if (currentPage === 'consultants') {
        pageContent = <ConsultantsPage onSelectConsultant={handleSelectConsultant} opportunities={getMergedOpportunities()} />;
      } else if (currentPage === 'impact') {
        pageContent = <ROIPage />;
      } else if (currentPage === 'opportunites') {
        pageContent = <OpportunitesPage onSelectConsultant={handleSelectConsultant} />;
      } else if (currentPage === 'historique') {
        pageContent = <HistoriquePage onSelectConsultant={handleSelectConsultant} actionHistory={actionHistory} />;
      } else if (currentPage === 'synthese') {
        pageContent = <SynthesePage />;
      } else if (currentPage === 'config') {
        pageContent = <ConfigPage />;
      } else if (currentPage === 'dashboard') {
        pageContent = <Dashboard 
          onSelectConsultant={handleSelectConsultant} 
          onAddAction={(action) => setActionHistory(prev => [action, ...prev])}
          onUpdateOpportunity={(oppId, updates) => {
            setOpportunityUpdates(prev => ({
              ...prev,
              [oppId]: {
                ...prev[oppId],
                ...updates
              }
            }));
          }}
          opportunities={getMergedOpportunities()}
        />;
      } else {
        // Placeholder for other pages
        pageContent = (
          <div className="main-content">
            <header className="page-header">
              <h1 className="page-title">🚧 En construction</h1>
              <p className="page-subtitle">Cette page sera disponible prochainement</p>
            </header>
          </div>
        );
      }

      return (
        <div className="app-container">
          <Sidebar currentPage={currentPage} onNavigate={setCurrentPage} />
          {pageContent}
        </div>
      );
    }

    // Render
    const root = ReactDOM.createRoot(document.getElementById('root'));
    root.render(<App />);
  </script>
</body>
</html>
